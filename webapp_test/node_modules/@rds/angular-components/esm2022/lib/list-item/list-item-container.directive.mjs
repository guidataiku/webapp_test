import { ContentChildren, DestroyRef, Directive, HostBinding, HostListener, inject, Input, isDevMode, QueryList, } from '@angular/core';
import { merge } from 'rxjs';
import { RdsListItemComponent } from './list-item.component';
import { startWith, switchMap, tap } from 'rxjs/operators';
import { FocusKeyManager } from '@angular/cdk/a11y';
import { DOWN_ARROW, ENTER, SPACE, UP_ARROW } from '@angular/cdk/keycodes';
import { RdsMultiSelectListItemComponent } from './multi-select-list-item.component';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { TAB_INDEX_DEFAULT, TAB_INDEX_NOT_FOCUSABLE } from '../utils';
import * as i0 from "@angular/core";
export class RdsListItemContainerDirective {
    constructor() {
        this.destroyRef = inject(DestroyRef);
        this._directDescendantItems = new QueryList();
        this.attrRole = 'menu';
        this.tabIndex = TAB_INDEX_NOT_FOCUSABLE;
        this.ariaMultiSelectable = false;
        this.ariaActiveDescendant = null;
        this.class = 'rds-list-item-container';
    }
    ngAfterContentInit() {
        this._updateDirectDescendants();
        this._keyManager = new FocusKeyManager(this._directDescendantItems)
            .skipPredicate((i) => i.disabled)
            .withWrap()
            .withTypeAhead()
            .withHomeAndEnd();
        this._directDescendantItems.changes
            .pipe(startWith(this._directDescendantItems), tap(() => {
            this.tabIndex = this._directDescendantItems.filter((i) => !i.disabled)
                ? TAB_INDEX_DEFAULT
                : TAB_INDEX_NOT_FOCUSABLE;
            this.setRoleTagsIfParentNotSetAndChildrenHasSameValue();
            this.checkRoleTags();
        }), switchMap((items) => merge(...items.map((item) => item._focused))), takeUntilDestroyed(this.destroyRef))
            .subscribe((focusedItem) => this._keyManager.updateActiveItem(focusedItem));
    }
    ngOnChanges(changes) {
        if (changes['role'] && changes['role'].currentValue) {
            this.attrRole = this.role;
            this.checkRoleTags();
        }
    }
    ngOnDestroy() {
        this._directDescendantItems.destroy();
    }
    focus() {
        if (!this._keyManager.activeItem) {
            this._keyManager.setFirstItemActive();
        }
        if (this._keyManager.activeItem) {
            const firstSelected = this._directDescendantItems
                .toArray()
                .findIndex((i) => i.checked);
            if (firstSelected) {
                this._directDescendantItems.get(firstSelected)?.focus('keyboard');
            }
            this._keyManager.activeItem.focus('keyboard');
            this.ariaActiveDescendant = this._keyManager.activeItem.getLabel();
        }
    }
    blur() {
        this._keyManager.activeItem?.blur();
        this.ariaActiveDescendant = null;
    }
    handleKeydown(event) {
        if (event.keyCode === UP_ARROW || event.keyCode === DOWN_ARROW) {
            this._keyManager.setFocusOrigin('keyboard');
        }
        const lastActiveItem = this._keyManager.activeItem;
        this._keyManager.onKeydown(event);
        if (this._keyManager.activeItem !== lastActiveItem) {
            lastActiveItem?.blur();
        }
        if (this._keyManager.activeItem) {
            if (event.keyCode === ENTER || event.keyCode === SPACE) {
                this._keyManager.activeItem.click();
                this._keyManager.activeItem.markAsActive();
            }
            this.ariaActiveDescendant = this._keyManager.activeItem.getLabel();
        }
    }
    handleKeyup(event) {
        if ((event.keyCode === ENTER || event.keyCode === SPACE) &&
            this._keyManager.activeItem) {
            this._keyManager.activeItem.markAsInactive();
        }
    }
    _updateDirectDescendants() {
        this._allItems.changes
            .pipe(startWith(this._allItems), takeUntilDestroyed(this.destroyRef))
            .subscribe((items) => {
            this._directDescendantItems.reset(items.toArray());
            this._directDescendantItems.notifyOnChanges();
        });
    }
    setRoleTagsIfParentNotSetAndChildrenHasSameValue() {
        if (!this.role) {
            const childRoles = this._directDescendantItems.reduce((acc, curr) => {
                if (!acc.includes(curr.role)) {
                    acc.push(curr.role);
                }
                return acc;
            }, []);
            if (childRoles.length === 1) {
                this.attrRole = childRoles[0] === 'menuitem' ? 'menu' : 'listbox';
            }
        }
    }
    checkRoleTags() {
        this.ariaMultiSelectable =
            this._directDescendantItems.filter((i) => !(i instanceof RdsMultiSelectListItemComponent)).length === 0;
        if (isDevMode()) {
            if (this.attrRole === 'menu') {
                const hasOptionsInsideMenu = this._directDescendantItems.some((i) => i.role !== 'menuitem');
                if (hasOptionsInsideMenu) {
                    throw new Error(`Defining role other than 'menuitem' for 'menu' parent is forbidden.`);
                }
            }
            else if (this.attrRole === 'listbox') {
                const hasMenuitemInsideListbox = this._directDescendantItems.some((i) => i.role !== 'option');
                if (hasMenuitemInsideListbox) {
                    throw new Error(`Defining role other than 'option' for 'listbox' parent is forbidden.`);
                }
            }
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsListItemContainerDirective, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "17.3.1", type: RdsListItemContainerDirective, selector: "[rds-list-item-container], [rdsListItemContainer]", inputs: { role: "role" }, host: { listeners: { "focus": "focus()", "blur": "blur()", "keydown": "handleKeydown($event)", "keyup": "handleKeyup($event)" }, properties: { "attr.role": "this.attrRole", "tabIndex": "this.tabIndex", "attr.aria-multiselectable": "this.ariaMultiSelectable", "attr.aria-activedescendant": "this.ariaActiveDescendant", "class": "this.class" } }, queries: [{ propertyName: "_allItems", predicate: RdsListItemComponent, descendants: true }], usesOnChanges: true, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsListItemContainerDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[rds-list-item-container], [rdsListItemContainer]',
                }]
        }], propDecorators: { _allItems: [{
                type: ContentChildren,
                args: [RdsListItemComponent, { descendants: true }]
            }], role: [{
                type: Input
            }], attrRole: [{
                type: HostBinding,
                args: ['attr.role']
            }], tabIndex: [{
                type: HostBinding,
                args: ['tabIndex']
            }], ariaMultiSelectable: [{
                type: HostBinding,
                args: ['attr.aria-multiselectable']
            }], ariaActiveDescendant: [{
                type: HostBinding,
                args: ['attr.aria-activedescendant']
            }], class: [{
                type: HostBinding,
                args: ['class']
            }], focus: [{
                type: HostListener,
                args: ['focus']
            }], blur: [{
                type: HostListener,
                args: ['blur']
            }], handleKeydown: [{
                type: HostListener,
                args: ['keydown', ['$event']]
            }], handleKeyup: [{
                type: HostListener,
                args: ['keyup', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC1pdGVtLWNvbnRhaW5lci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItY29tcG9uZW50cy9zcmMvbGliL2xpc3QtaXRlbS9saXN0LWl0ZW0tY29udGFpbmVyLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsZUFBZSxFQUNmLFVBQVUsRUFDVixTQUFTLEVBQ1QsV0FBVyxFQUNYLFlBQVksRUFDWixNQUFNLEVBQ04sS0FBSyxFQUNMLFNBQVMsRUFHVCxTQUFTLEdBRVYsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzNFLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBRXJGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLFVBQVUsQ0FBQzs7QUFLdEUsTUFBTSxPQUFPLDZCQUE2QjtJQUgxQztRQU1tQixlQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBSXpDLDJCQUFzQixHQUFHLElBQUksU0FBUyxFQUF3QixDQUFDO1FBTzdELGFBQVEsR0FBdUIsTUFBTSxDQUFDO1FBR3RDLGFBQVEsR0FBRyx1QkFBdUIsQ0FBQztRQUdu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QVc7dUJBQUMsV0FBVztnQkFJZCxRQUFRO3NCQURqQixXQUFXO3VCQUFDLFVBQVU7Z0JBSWIsbUJBQW1CO3NCQUQ1QixXQUFXO3VCQUFDLDJCQUEyQjtnQkFJOUIsb0JBQW9CO3NCQUQ3QixXQUFXO3VCQUFDLDRCQUE0QjtnQkFJdEIsS0FBSztzQkFEdkIsV0FBVzt1QkFBQyxPQUFPO2dCQTBDcEIsS0FBSztzQkFESixZQUFZO3VCQUFDLE9BQU87Z0JBdUJyQixJQUFJO3NCQURILFlBQVk7dUJBQUMsTUFBTTtnQkFPVixhQUFhO3NCQUR0QixZQUFZO3VCQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQztnQkF3QnpCLFdBQVc7c0JBRHBCLFlBQVk7dUJBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJDb250ZW50SW5pdCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBEZXN0cm95UmVmLFxuICBEaXJlY3RpdmUsXG4gIEhvc3RCaW5kaW5nLFxuICBIb3N0TGlzdGVuZXIsXG4gIGluamVjdCxcbiAgSW5wdXQsXG4gIGlzRGV2TW9kZSxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIFF1ZXJ5TGlzdCxcbiAgU2ltcGxlQ2hhbmdlcyxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBtZXJnZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUmRzTGlzdEl0ZW1Db21wb25lbnQgfSBmcm9tICcuL2xpc3QtaXRlbS5jb21wb25lbnQnO1xuaW1wb3J0IHsgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZvY3VzS2V5TWFuYWdlciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9hMTF5JztcbmltcG9ydCB7IERPV05fQVJST1csIEVOVEVSLCBTUEFDRSwgVVBfQVJST1cgfSBmcm9tICdAYW5ndWxhci9jZGsva2V5Y29kZXMnO1xuaW1wb3J0IHsgUmRzTXVsdGlTZWxlY3RMaXN0SXRlbUNvbXBvbmVudCB9IGZyb20gJy4vbXVsdGktc2VsZWN0LWxpc3QtaXRlbS5jb21wb25lbnQnO1xuaW1wb3J0IHsgUmRzQWJzdHJhY3RTZWxlY3RhYmxlTGlzdEl0ZW1Db21wb25lbnQgfSBmcm9tICcuL2Fic3RyYWN0LXNlbGVjdGFibGUtbGlzdC1pdGVtLmNvbXBvbmVudCc7XG5pbXBvcnQgeyB0YWtlVW50aWxEZXN0cm95ZWQgfSBmcm9tICdAYW5ndWxhci9jb3JlL3J4anMtaW50ZXJvcCc7XG5pbXBvcnQgeyBUQUJfSU5ERVhfREVGQVVMVCwgVEFCX0lOREVYX05PVF9GT0NVU0FCTEUgfSBmcm9tICcuLi91dGlscyc7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tyZHMtbGlzdC1pdGVtLWNvbnRhaW5lcl0sIFtyZHNMaXN0SXRlbUNvbnRhaW5lcl0nLFxufSlcbmV4cG9ydCBjbGFzcyBSZHNMaXN0SXRlbUNvbnRhaW5lckRpcmVjdGl2ZVxuICBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25EZXN0cm95LCBBZnRlckNvbnRlbnRJbml0XG57XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveVJlZiA9IGluamVjdChEZXN0cm95UmVmKTtcblxuICBAQ29udGVudENoaWxkcmVuKFJkc0xpc3RJdGVtQ29tcG9uZW50LCB7IGRlc2NlbmRhbnRzOiB0cnVlIH0pXG4gIHByb3RlY3RlZCBfYWxsSXRlbXM6IFF1ZXJ5TGlzdDxSZHNMaXN0SXRlbUNvbXBvbmVudD47XG4gIHByaXZhdGUgX2RpcmVjdERlc2NlbmRhbnRJdGVtcyA9IG5ldyBRdWVyeUxpc3Q8UmRzTGlzdEl0ZW1Db21wb25lbnQ+KCk7XG4gIHByaXZhdGUgX2tleU1hbmFnZXI6IEZvY3VzS2V5TWFuYWdlcjxSZHNMaXN0SXRlbUNvbXBvbmVudD47XG5cbiAgQElucHV0KClcbiAgcm9sZTogJ21lbnUnIHwgJ2xpc3Rib3gnO1xuXG4gIEBIb3N0QmluZGluZygnYXR0ci5yb2xlJylcbiAgcHJvdGVjdGVkIGF0dHJSb2xlOiAnbWVudScgfCAnbGlzdGJveCcgPSAnbWVudSc7XG5cbiAgQEhvc3RCaW5kaW5nKCd0YWJJbmRleCcpXG4gIHByb3RlY3RlZCB0YWJJbmRleCA9IFRBQl9JTkRFWF9OT1RfRk9DVVNBQkxFO1xuXG4gIEBIb3N0QmluZGluZygnYXR0ci5hcmlhLW11bHRpc2VsZWN0YWJsZScpXG4gIHByb3RlY3RlZCBhcmlhTXVsdGlTZWxlY3RhYmxlID0gZmFsc2U7XG5cbiAgQEhvc3RCaW5kaW5nKCdhdHRyLmFyaWEtYWN0aXZlZGVzY2VuZGFudCcpXG4gIHByb3RlY3RlZCBhcmlhQWN0aXZlRGVzY2VuZGFudDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpXG4gIHByb3RlY3RlZCByZWFkb25seSBjbGFzcyA9ICdyZHMtbGlzdC1pdGVtLWNvbnRhaW5lcic7XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIHRoaXMuX3VwZGF0ZURpcmVjdERlc2NlbmRhbnRzKCk7XG4gICAgdGhpcy5fa2V5TWFuYWdlciA9IG5ldyBGb2N1c0tleU1hbmFnZXIodGhpcy5fZGlyZWN0RGVzY2VuZGFudEl0ZW1zKVxuICAgICAgLnNraXBQcmVkaWNhdGUoKGkpID0+IGkuZGlzYWJsZWQpXG4gICAgICAud2l0aFdyYXAoKVxuICAgICAgLndpdGhUeXBlQWhlYWQoKVxuICAgICAgLndpdGhIb21lQW5kRW5kKCk7XG4gICAgdGhpcy5fZGlyZWN0RGVzY2VuZGFudEl0ZW1zLmNoYW5nZXNcbiAgICAgIC5waXBlKFxuICAgICAgICBzdGFydFdpdGgodGhpcy5fZGlyZWN0RGVzY2VuZGFudEl0ZW1zKSxcbiAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICB0aGlzLnRhYkluZGV4ID0gdGhpcy5fZGlyZWN0RGVzY2VuZGFudEl0ZW1zLmZpbHRlcigoaSkgPT4gIWkuZGlzYWJsZWQpXG4gICAgICAgICAgICA/IFRBQl9JTkRFWF9ERUZBVUxUXG4gICAgICAgICAgICA6IFRBQl9JTkRFWF9OT1RfRk9DVVNBQkxFO1xuICAgICAgICAgIHRoaXMuc2V0Um9sZVRhZ3NJZlBhcmVudE5vdFNldEFuZENoaWxkcmVuSGFzU2FtZVZhbHVlKCk7XG4gICAgICAgICAgdGhpcy5jaGVja1JvbGVUYWdzKCk7XG4gICAgICAgIH0pLFxuICAgICAgICBzd2l0Y2hNYXAoKGl0ZW1zKSA9PlxuICAgICAgICAgIG1lcmdlKC4uLml0ZW1zLm1hcCgoaXRlbTogUmRzTGlzdEl0ZW1Db21wb25lbnQpID0+IGl0ZW0uX2ZvY3VzZWQpKSxcbiAgICAgICAgKSxcbiAgICAgICAgdGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZiksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChmb2N1c2VkSXRlbSkgPT5cbiAgICAgICAgdGhpcy5fa2V5TWFuYWdlci51cGRhdGVBY3RpdmVJdGVtKGZvY3VzZWRJdGVtIGFzIFJkc0xpc3RJdGVtQ29tcG9uZW50KSxcbiAgICAgICk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXNbJ3JvbGUnXSAmJiBjaGFuZ2VzWydyb2xlJ10uY3VycmVudFZhbHVlKSB7XG4gICAgICB0aGlzLmF0dHJSb2xlID0gdGhpcy5yb2xlO1xuICAgICAgdGhpcy5jaGVja1JvbGVUYWdzKCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5fZGlyZWN0RGVzY2VuZGFudEl0ZW1zLmRlc3Ryb3koKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2ZvY3VzJylcbiAgZm9jdXMoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLl9rZXlNYW5hZ2VyLmFjdGl2ZUl0ZW0pIHtcbiAgICAgIHRoaXMuX2tleU1hbmFnZXIuc2V0Rmlyc3RJdGVtQWN0aXZlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX2tleU1hbmFnZXIuYWN0aXZlSXRlbSkge1xuICAgICAgY29uc3QgZmlyc3RTZWxlY3RlZCA9IHRoaXMuX2RpcmVjdERlc2NlbmRhbnRJdGVtc1xuICAgICAgICAudG9BcnJheSgpXG4gICAgICAgIC5maW5kSW5kZXgoXG4gICAgICAgICAgKGkpID0+IChpIGFzIFJkc0Fic3RyYWN0U2VsZWN0YWJsZUxpc3RJdGVtQ29tcG9uZW50KS5jaGVja2VkLFxuICAgICAgICApO1xuXG4gICAgICBpZiAoZmlyc3RTZWxlY3RlZCkge1xuICAgICAgICB0aGlzLl9kaXJlY3REZXNjZW5kYW50SXRlbXMuZ2V0KGZpcnN0U2VsZWN0ZWQpPy5mb2N1cygna2V5Ym9hcmQnKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fa2V5TWFuYWdlci5hY3RpdmVJdGVtLmZvY3VzKCdrZXlib2FyZCcpO1xuICAgICAgdGhpcy5hcmlhQWN0aXZlRGVzY2VuZGFudCA9IHRoaXMuX2tleU1hbmFnZXIuYWN0aXZlSXRlbS5nZXRMYWJlbCgpO1xuICAgIH1cbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2JsdXInKVxuICBibHVyKCk6IHZvaWQge1xuICAgIHRoaXMuX2tleU1hbmFnZXIuYWN0aXZlSXRlbT8uYmx1cigpO1xuICAgIHRoaXMuYXJpYUFjdGl2ZURlc2NlbmRhbnQgPSBudWxsO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIHByb3RlY3RlZCBoYW5kbGVLZXlkb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IFVQX0FSUk9XIHx8IGV2ZW50LmtleUNvZGUgPT09IERPV05fQVJST1cpIHtcbiAgICAgIHRoaXMuX2tleU1hbmFnZXIuc2V0Rm9jdXNPcmlnaW4oJ2tleWJvYXJkJyk7XG4gICAgfVxuXG4gICAgY29uc3QgbGFzdEFjdGl2ZUl0ZW0gPSB0aGlzLl9rZXlNYW5hZ2VyLmFjdGl2ZUl0ZW07XG4gICAgdGhpcy5fa2V5TWFuYWdlci5vbktleWRvd24oZXZlbnQpO1xuXG4gICAgaWYgKHRoaXMuX2tleU1hbmFnZXIuYWN0aXZlSXRlbSAhPT0gbGFzdEFjdGl2ZUl0ZW0pIHtcbiAgICAgIGxhc3RBY3RpdmVJdGVtPy5ibHVyKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX2tleU1hbmFnZXIuYWN0aXZlSXRlbSkge1xuICAgICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IEVOVEVSIHx8IGV2ZW50LmtleUNvZGUgPT09IFNQQUNFKSB7XG4gICAgICAgIHRoaXMuX2tleU1hbmFnZXIuYWN0aXZlSXRlbS5jbGljaygpO1xuICAgICAgICB0aGlzLl9rZXlNYW5hZ2VyLmFjdGl2ZUl0ZW0ubWFya0FzQWN0aXZlKCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYXJpYUFjdGl2ZURlc2NlbmRhbnQgPSB0aGlzLl9rZXlNYW5hZ2VyLmFjdGl2ZUl0ZW0uZ2V0TGFiZWwoKTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdrZXl1cCcsIFsnJGV2ZW50J10pXG4gIHByb3RlY3RlZCBoYW5kbGVLZXl1cChldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xuICAgIGlmIChcbiAgICAgIChldmVudC5rZXlDb2RlID09PSBFTlRFUiB8fCBldmVudC5rZXlDb2RlID09PSBTUEFDRSkgJiZcbiAgICAgIHRoaXMuX2tleU1hbmFnZXIuYWN0aXZlSXRlbVxuICAgICkge1xuICAgICAgdGhpcy5fa2V5TWFuYWdlci5hY3RpdmVJdGVtLm1hcmtBc0luYWN0aXZlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlRGlyZWN0RGVzY2VuZGFudHMoKTogdm9pZCB7XG4gICAgdGhpcy5fYWxsSXRlbXMuY2hhbmdlc1xuICAgICAgLnBpcGUoc3RhcnRXaXRoKHRoaXMuX2FsbEl0ZW1zKSwgdGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZikpXG4gICAgICAuc3Vic2NyaWJlKChpdGVtczogUXVlcnlMaXN0PFJkc0xpc3RJdGVtQ29tcG9uZW50PikgPT4ge1xuICAgICAgICB0aGlzLl9kaXJlY3REZXNjZW5kYW50SXRlbXMucmVzZXQoaXRlbXMudG9BcnJheSgpKTtcbiAgICAgICAgdGhpcy5fZGlyZWN0RGVzY2VuZGFudEl0ZW1zLm5vdGlmeU9uQ2hhbmdlcygpO1xuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNldFJvbGVUYWdzSWZQYXJlbnROb3RTZXRBbmRDaGlsZHJlbkhhc1NhbWVWYWx1ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucm9sZSkge1xuICAgICAgY29uc3QgY2hpbGRSb2xlcyA9IHRoaXMuX2RpcmVjdERlc2NlbmRhbnRJdGVtcy5yZWR1Y2UoXG4gICAgICAgIChhY2MsIGN1cnIpID0+IHtcbiAgICAgICAgICBpZiAoIWFjYy5pbmNsdWRlcyhjdXJyLnJvbGUpKSB7XG4gICAgICAgICAgICBhY2MucHVzaChjdXJyLnJvbGUpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgIH0sXG4gICAgICAgIFtdIGFzICgnbWVudWl0ZW0nIHwgJ29wdGlvbicpW10sXG4gICAgICApO1xuXG4gICAgICBpZiAoY2hpbGRSb2xlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgdGhpcy5hdHRyUm9sZSA9IGNoaWxkUm9sZXNbMF0gPT09ICdtZW51aXRlbScgPyAnbWVudScgOiAnbGlzdGJveCc7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja1JvbGVUYWdzKCk6IHZvaWQge1xuICAgIHRoaXMuYXJpYU11bHRpU2VsZWN0YWJsZSA9XG4gICAgICB0aGlzLl9kaXJlY3REZXNjZW5kYW50SXRlbXMuZmlsdGVyKFxuICAgICAgICAoaSkgPT4gIShpIGluc3RhbmNlb2YgUmRzTXVsdGlTZWxlY3RMaXN0SXRlbUNvbXBvbmVudCksXG4gICAgICApLmxlbmd0aCA9PT0gMDtcblxuICAgIGlmIChpc0Rldk1vZGUoKSkge1xuICAgICAgaWYgKHRoaXMuYXR0clJvbGUgPT09ICdtZW51Jykge1xuICAgICAgICBjb25zdCBoYXNPcHRpb25zSW5zaWRlTWVudSA9IHRoaXMuX2RpcmVjdERlc2NlbmRhbnRJdGVtcy5zb21lKFxuICAgICAgICAgIChpKSA9PiBpLnJvbGUgIT09ICdtZW51aXRlbScsXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGhhc09wdGlvbnNJbnNpZGVNZW51KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYERlZmluaW5nIHJvbGUgb3RoZXIgdGhhbiAnbWVudWl0ZW0nIGZvciAnbWVudScgcGFyZW50IGlzIGZvcmJpZGRlbi5gLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAodGhpcy5hdHRyUm9sZSA9PT0gJ2xpc3Rib3gnKSB7XG4gICAgICAgIGNvbnN0IGhhc01lbnVpdGVtSW5zaWRlTGlzdGJveCA9IHRoaXMuX2RpcmVjdERlc2NlbmRhbnRJdGVtcy5zb21lKFxuICAgICAgICAgIChpKSA9PiBpLnJvbGUgIT09ICdvcHRpb24nLFxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChoYXNNZW51aXRlbUluc2lkZUxpc3Rib3gpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgRGVmaW5pbmcgcm9sZSBvdGhlciB0aGFuICdvcHRpb24nIGZvciAnbGlzdGJveCcgcGFyZW50IGlzIGZvcmJpZGRlbi5gLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==