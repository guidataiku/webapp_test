import { booleanAttribute, ChangeDetectorRef, ContentChild, DestroyRef, Directive, ElementRef, EventEmitter, HostListener, inject, Input, NgZone, Output, Renderer2, } from '@angular/core';
import { fromEvent, noop, race, Subject } from 'rxjs';
import { delay, filter, map, switchMap, take, takeUntil, tap, timeout, withLatestFrom, } from 'rxjs/operators';
import { RdsDropdownToggleDirective } from './dropdown-toggle.directive';
import { RdsDropdownMenuDirective } from './dropdown-menu.directive';
import { CdkOverlayOrigin, Overlay, } from '@angular/cdk/overlay';
import { ComponentPortal } from '@angular/cdk/portal';
import { RdsDropdownContainerComponent } from './dropdown-container.component';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import * as i0 from "@angular/core";
const SECONDARY_MOUSE_BUTTON_CLICK = 2;
export class RdsDropdownDirective {
    constructor() {
        this.cdr = inject(ChangeDetectorRef);
        this.destroyRef = inject(DestroyRef);
        this.ngZone = inject(NgZone);
        this.elementRef = inject(ElementRef);
        this.renderer = inject(Renderer2);
        this.overlay = inject(Overlay);
        this.autoClose = true;
        this.placement = 'bottom-left';
        this.disabled = false;
        this.backdrop = false;
        this.openChanged = new EventEmitter();
        this.shown = new EventEmitter();
        this.hidden = new EventEmitter();
        this._open = false;
        this._overlayRef = null;
        this._closed$ = new Subject();
    }
    onHover() {
        this._handleMouseOver(this.elementRef);
    }
    onLeave() {
        this._handleMouseLeave(this.elementRef);
    }
    ngAfterContentInit() {
        const target = this.elementRef.nativeElement.firstElementChild;
        if (target) {
            fromEvent(target, 'focus')
                .pipe(takeUntilDestroyed(this.destroyRef))
                .subscribe(() => {
                this._handleFocus(this.elementRef);
            });
            fromEvent(target, 'blur')
                .pipe(takeUntilDestroyed(this.destroyRef))
                .subscribe(() => {
                this._handleBlur(this.elementRef);
            });
        }
        this.ngZone.onStable
            .pipe(take(1), takeUntilDestroyed(this.destroyRef))
            .subscribe(() => {
            if (this._open) {
                this._setCloseHandlers();
            }
        });
        this._toggle.toggle
            .pipe(takeUntilDestroyed(this.destroyRef))
            .subscribe((event) => {
            if (this._toggle.trigger === 'mouseenter, mouseleave') {
                if (event.type === 'mouseenter' && !this.isOpen()) {
                    this.show();
                }
                else if (event.type === 'mouseleave' && this.isOpen()) {
                    const hideObserver = {
                        next: noop,
                        error: () => this.hide(),
                    };
                    if (this._overlayRef) {
                        fromEvent(this._overlayRef.overlayElement, 'mouseenter')
                            .pipe(take(1), tap(() => {
                            if (this._overlayRef) {
                                fromEvent(this._overlayRef.overlayElement, 'mouseleave')
                                    .pipe(take(1), switchMap(() => fromEvent(this._toggle.elementRef.nativeElement, 'mouseenter').pipe(take(1), timeout(1), takeUntil(this._closed$))), takeUntil(this._closed$))
                                    .subscribe(hideObserver);
                            }
                        }), timeout(1), takeUntil(this._closed$))
                            .subscribe(hideObserver);
                    }
                }
            }
            else {
                this.toggle();
            }
        });
        this._toggle.disabled = this.disabled;
    }
    ngOnChanges(changes) {
        if (changes['backdrop']) {
            this._checkToggle();
            this.hide();
            this._overlayRef = null;
        }
        if (changes['placement']) {
            if (this.placement === null || this.placement === undefined) {
                this.placement = 'bottom-left';
            }
            if (this._overlayRef !== null) {
                this._overlayRef.updatePositionStrategy(this._getPositionStrategy());
            }
        }
        if (this._toggle &&
            changes['disabled'] &&
            changes['disabled'].previousValue !== changes['disabled'].currentValue) {
            this._toggle.disabled = this.disabled;
            if (this.disabled) {
                this.hide();
            }
        }
    }
    ngOnDestroy() {
        if (this._overlayRef) {
            this._overlayRef.detach();
        }
        this._closed$.next();
        this._closed$.complete();
    }
    isOpen() {
        return this._open;
    }
    show() {
        if (!this.disabled && !this._open) {
            this._checkToggle();
            this._open = true;
            if (!this._overlayRef) {
                this._overlayRef = this.overlay.create({
                    hasBackdrop: this.backdrop !== false,
                    backdropClass: this.backdrop === 'transparent'
                        ? 'cdk-overlay-transparent-backdrop'
                        : undefined,
                    positionStrategy: this._getPositionStrategy(),
                });
                this._overlayRef.backdropClick().subscribe(() => this.hide());
                this._portal = new ComponentPortal(RdsDropdownContainerComponent, null);
            }
            const dropdownContainerComponentRef = this._overlayRef.attach(this._portal);
            dropdownContainerComponentRef.instance.templateRef =
                this._menu.templateRef;
            dropdownContainerComponentRef.changeDetectorRef.markForCheck();
            this.openChanged.emit(true);
            this.shown.emit();
            this._setCloseHandlers();
            if (this._toggle) {
                this._toggle.isOpen = true;
                this._toggle.elementRef.nativeElement.focus();
            }
        }
    }
    hide() {
        if (this._open) {
            this._open = false;
            this._toggle.isOpen = false;
            if (this._overlayRef) {
                this._overlayRef.detach();
            }
            this._closed$.next();
            this.openChanged.emit(false);
            this.hidden.emit();
            this.cdr.markForCheck();
        }
    }
    toggle() {
        if (this.isOpen()) {
            this.hide();
        }
        else {
            this.show();
        }
    }
    _getPlacement() {
        return this.placement !== null && this.placement !== undefined
            ? this.placement
            : 'bottom-left';
    }
    _setCloseHandlers() {
        if (this.autoClose) {
            this.ngZone.runOutsideAngular(() => {
                const shouldCloseOnClick = (event) => {
                    const element = event.target;
                    if (event.button === SECONDARY_MOUSE_BUTTON_CLICK ||
                        this._toggle.elementRef.nativeElement.contains(element)) {
                        return false;
                    }
                    if (this.autoClose === 'inside') {
                        return this._overlayRef?.overlayElement.contains(element) || true;
                    }
                    else if (this.autoClose === 'outside') {
                        return !this._overlayRef?.overlayElement.contains(element) || false;
                    }
                    else {
                        return true;
                    }
                };
                const escapes$ = fromEvent(document, 'keydown').pipe(filter((e) => e.key === 'Escape'), tap((e) => e.preventDefault()), takeUntil(this._closed$));
                const mouseDowns$ = fromEvent(document, 'mousedown').pipe(map((e) => shouldCloseOnClick(e)), takeUntil(this._closed$));
                const closeableClicks$ = fromEvent(document, 'mouseup').pipe(withLatestFrom(mouseDowns$), 
                // eslint-disable-next-line @typescript-eslint/no-unused-vars
                filter(([_, shouldClose]) => shouldClose), delay(0), takeUntil(this._closed$));
                race([
                    escapes$.pipe(map(() => 'ESCAPE')),
                    closeableClicks$.pipe(map(() => 'CLICK')),
                ])
                    .pipe(takeUntilDestroyed(this.destroyRef))
                    .subscribe((source) => this.ngZone.run(() => {
                    this.hide();
                    if (source === 'ESCAPE') {
                        this._toggle.elementRef.nativeElement.focus();
                    }
                }));
            });
        }
    }
    _handleMouseOver(el) {
        this.handleIsPrevButton();
        this.handleIsPrevFocused();
        this.renderer.addClass(el.nativeElement, 'rds-dropdown--hover');
    }
    _handleMouseLeave(el) {
        this.handleIsPrevButton();
        this.handleIsPrevFocused();
        this.renderer.removeClass(el.nativeElement, 'rds-dropdown--hover');
    }
    _handleFocus(el) {
        this.handleIsPrevButton();
        this.renderer.addClass(el.nativeElement, 'rds-dropdown--focused');
    }
    _handleBlur(el) {
        this.handleIsPrevButton();
        this.renderer.removeClass(el.nativeElement, 'rds-dropdown--focused');
    }
    _getPositions() {
        const placement = this._getPlacement();
        const positions = {
            originX: 'start',
            originY: 'bottom',
            overlayX: 'start',
            overlayY: 'top',
            offsetX: 0,
            offsetY: 0,
        };
        if (placement.includes('top')) {
            positions.originY = 'top';
            positions.overlayY = 'bottom';
        }
        if (placement.includes('center')) {
            positions.originX = 'center';
            positions.overlayX = 'center';
        }
        if (placement.includes('right')) {
            positions.originX = placement.includes('start') ? 'start' : 'end';
            positions.overlayX = 'end';
        }
        else if (placement.includes('end')) {
            positions.originX = 'end';
        }
        return positions;
    }
    _getPositionStrategy() {
        const overlayOrigin = new CdkOverlayOrigin(this._toggle.elementRef);
        return this.overlay
            .position()
            .flexibleConnectedTo(overlayOrigin.elementRef)
            .withPositions([this._getPositions()]);
    }
    _checkToggle() {
        if (this.backdrop && this._toggle && this._toggle.trigger !== 'click') {
            throw new Error(`Backdrop is only allowed for 'click' trigger`);
        }
    }
    handleIsPrevButton() {
        const isPrevButton = this.elementRef?.nativeElement?.nextElementSibling?.tagName === 'BUTTON';
        if (isPrevButton) {
            this.renderer.addClass(this.elementRef.nativeElement, 'rds-dropdown--prev-button');
        }
        else {
            this.renderer.removeClass(this.elementRef.nativeElement, 'rds-dropdown--prev-button');
        }
    }
    handleIsPrevFocused() {
        const input = this.elementRef.nativeElement.nextElementSibling?.querySelector('input');
        if (input) {
            if (input.parentElement?.classList.contains('rds-form-field_content-infix--focused')) {
                this.renderer.addClass(this.elementRef.nativeElement, 'rds-dropdown--prev-focused');
            }
            else {
                this.renderer.removeClass(this.elementRef.nativeElement, 'rds-dropdown--prev-focused');
            }
        }
        else {
            this.renderer.removeClass(this.elementRef.nativeElement, 'rds-dropdown--prev-focused');
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsDropdownDirective, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "16.1.0", version: "17.3.1", type: RdsDropdownDirective, selector: "[rdsDropdown], [rds-dropdown]", inputs: { autoClose: "autoClose", placement: "placement", disabled: ["disabled", "disabled", booleanAttribute], backdrop: "backdrop" }, outputs: { openChanged: "openChanged", shown: "shown", hidden: "hidden" }, host: { listeners: { "mouseover": "onHover()", "mouseleave": "onLeave()" } }, queries: [{ propertyName: "_menu", first: true, predicate: RdsDropdownMenuDirective, descendants: true }, { propertyName: "_toggle", first: true, predicate: RdsDropdownToggleDirective, descendants: true }], exportAs: ["rdsDropdown"], usesOnChanges: true, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsDropdownDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[rdsDropdown], [rds-dropdown]',
                    exportAs: 'rdsDropdown',
                }]
        }], propDecorators: { _menu: [{
                type: ContentChild,
                args: [RdsDropdownMenuDirective, { static: false }]
            }], _toggle: [{
                type: ContentChild,
                args: [RdsDropdownToggleDirective, { static: false }]
            }], autoClose: [{
                type: Input
            }], placement: [{
                type: Input
            }], disabled: [{
                type: Input,
                args: [{ transform: booleanAttribute }]
            }], backdrop: [{
                type: Input
            }], openChanged: [{
                type: Output
            }], shown: [{
                type: Output
            }], hidden: [{
                type: Output
            }], onHover: [{
                type: HostListener,
                args: ['mouseover']
            }], onLeave: [{
                type: HostListener,
                args: ['mouseleave']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24uZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9hbmd1bGFyLWNvbXBvbmVudHMvc3JjL2xpYi9kcm9wZG93bi9kcm9wZG93bi5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLGdCQUFnQixFQUNoQixpQkFBaUIsRUFDakIsWUFBWSxFQUNaLFVBQVUsRUFDVixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFDTCxNQUFNLEVBR04sTUFBTSxFQUNOLFNBQVMsR0FFVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBbUIsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2RSxPQUFPLEVBQ0wsS0FBSyxFQUNMLE1BQU0sRUFDTixHQUFHLEVBQ0gsU0FBUyxFQUNULElBQUksRUFDSixTQUFTLEVBQ1QsR0FBRyxFQUNILE9BQU8sRUFDUCxjQUFjLEdBQ2YsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUN6RSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNyRSxPQUFPLEVBQ0wsZ0JBQWdCLEVBRWhCLE9BQU8sR0FHUixNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQU8vRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7QUFFaEUsTUFBTSw0QkFBNEIsR0FBRyxDQUFDLENBQUM7QUFNdkMsTUFBTSxPQUFPLG9CQUFvQjtJQUpqQztRQU9xQixRQUFHLEdBQUcsTUFB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QWEsRUFDN0IsNEJBQTRCLENBQzdCLENBQUM7WUFDSixDQUFDO1FBQ0gsQ0FBQzthQUFNLENBQUM7WUFDTixJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FDdkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQzdCLDRCQUE0QixDQUM3QixDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7OEdBN1lVLG9CQUFvQjtrR0FBcEIsb0JBQW9CLDBJQWtCWCxnQkFBZ0IsK09BUnRCLHdCQUF3QiwwRUFHeEIsMEJBQTBCOzsyRkFiN0Isb0JBQW9CO2tCQUpoQyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSwrQkFBK0I7b0JBQ3pDLFFBQVEsRUFBRSxhQUFhO2lCQUN4Qjs4QkFZUyxLQUFLO3NCQURaLFlBQVk7dUJBQUMsd0JBQXdCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO2dCQUlqRCxPQUFPO3NCQURkLFlBQVk7dUJBQUMsMEJBQTBCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO2dCQUdsRCxTQUFTO3NCQUFqQixLQUFLO2dCQUNHLFNBQVM7c0JBQWpCLEtBQUs7Z0JBQ2tDLFFBQVE7c0JBQS9DLEtBQUs7dUJBQUMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUU7Z0JBQzdCLFFBQVE7c0JBQWhCLEtBQUs7Z0JBQ0ksV0FBVztzQkFBcEIsTUFBTTtnQkFDRyxLQUFLO3NCQUFkLE1BQU07Z0JBQ0csTUFBTTtzQkFBZixNQUFNO2dCQVFQLE9BQU87c0JBRE4sWUFBWTt1QkFBQyxXQUFXO2dCQU16QixPQUFPO3NCQUROLFlBQVk7dUJBQUMsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyQ29udGVudEluaXQsXG4gIGJvb2xlYW5BdHRyaWJ1dGUsXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb250ZW50Q2hpbGQsXG4gIERlc3Ryb3lSZWYsXG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBIb3N0TGlzdGVuZXIsXG4gIGluamVjdCxcbiAgSW5wdXQsXG4gIE5nWm9uZSxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE91dHB1dCxcbiAgUmVuZGVyZXIyLFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb21FdmVudCwgbm9vcCwgUGFydGlhbE9ic2VydmVyLCByYWNlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBkZWxheSxcbiAgZmlsdGVyLFxuICBtYXAsXG4gIHN3aXRjaE1hcCxcbiAgdGFrZSxcbiAgdGFrZVVudGlsLFxuICB0YXAsXG4gIHRpbWVvdXQsXG4gIHdpdGhMYXRlc3RGcm9tLFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSZHNEcm9wZG93blRvZ2dsZURpcmVjdGl2ZSB9IGZyb20gJy4vZHJvcGRvd24tdG9nZ2xlLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBSZHNEcm9wZG93bk1lbnVEaXJlY3RpdmUgfSBmcm9tICcuL2Ryb3Bkb3duLW1lbnUuZGlyZWN0aXZlJztcbmltcG9ydCB7XG4gIENka092ZXJsYXlPcmlnaW4sXG4gIENvbm5lY3RlZFBvc2l0aW9uLFxuICBPdmVybGF5LFxuICBPdmVybGF5UmVmLFxuICBQb3NpdGlvblN0cmF0ZWd5LFxufSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcbmltcG9ydCB7IFJkc0Ryb3Bkb3duQ29udGFpbmVyQ29tcG9uZW50IH0gZnJvbSAnLi9kcm9wZG93bi1jb250YWluZXIuY29tcG9uZW50JztcbmltcG9ydCB7XG4gIFJkc0Ryb3Bkb3duQXV0b0Nsb3NlLFxuICBSZHNEcm9wZG93bkJhY2tkcm9wLFxuICBSZHNEcm9wZG93bkNsb3NlU291cmNlLFxuICBSZHNEcm9wZG93blBsYWNlbWVudCxcbn0gZnJvbSAnLi9kcm9wZG93bi50eXBlcyc7XG5pbXBvcnQgeyB0YWtlVW50aWxEZXN0cm95ZWQgfSBmcm9tICdAYW5ndWxhci9jb3JlL3J4anMtaW50ZXJvcCc7XG5cbmNvbnN0IFNFQ09OREFSWV9NT1VTRV9CVVRUT05fQ0xJQ0sgPSAyO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbcmRzRHJvcGRvd25dLCBbcmRzLWRyb3Bkb3duXScsXG4gIGV4cG9ydEFzOiAncmRzRHJvcGRvd24nLFxufSlcbmV4cG9ydCBjbGFzcyBSZHNEcm9wZG93bkRpcmVjdGl2ZVxuICBpbXBsZW1lbnRzIEFmdGVyQ29udGVudEluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95XG57XG4gIHByb3RlY3RlZCByZWFkb25seSBjZHIgPSBpbmplY3QoQ2hhbmdlRGV0ZWN0b3JSZWYpO1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZGVzdHJveVJlZiA9IGluamVjdChEZXN0cm95UmVmKTtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IG5nWm9uZSA9IGluamVjdChOZ1pvbmUpO1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZWxlbWVudFJlZiA9IGluamVjdDxFbGVtZW50UmVmPEhUTUxFbGVtZW50Pj4oRWxlbWVudFJlZik7XG4gIHByb3RlY3RlZCByZWFkb25seSByZW5kZXJlciA9IGluamVjdChSZW5kZXJlcjIpO1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgb3ZlcmxheSA9IGluamVjdChPdmVybGF5KTtcblxuICBAQ29udGVudENoaWxkKFJkc0Ryb3Bkb3duTWVudURpcmVjdGl2ZSwgeyBzdGF0aWM6IGZhbHNlIH0pXG4gIHByaXZhdGUgX21lbnU6IFJkc0Ryb3Bkb3duTWVudURpcmVjdGl2ZTtcblxuICBAQ29udGVudENoaWxkKFJkc0Ryb3Bkb3duVG9nZ2xlRGlyZWN0aXZlLCB7IHN0YXRpYzogZmFsc2UgfSlcbiAgcHJpdmF0ZSBfdG9nZ2xlOiBSZHNEcm9wZG93blRvZ2dsZURpcmVjdGl2ZTtcblxuICBASW5wdXQoKSBhdXRvQ2xvc2U6IFJkc0Ryb3Bkb3duQXV0b0Nsb3NlID0gdHJ1ZTtcbiAgQElucHV0KCkgcGxhY2VtZW50OiBSZHNEcm9wZG93blBsYWNlbWVudCA9ICdib3R0b20tbGVmdCc7XG4gIEBJbnB1dCh7IHRyYW5zZm9ybTogYm9vbGVhbkF0dHJpYnV0ZSB9KSBkaXNhYmxlZCA9IGZhbHNlO1xuICBASW5wdXQoKSBiYWNrZHJvcDogUmRzRHJvcGRvd25CYWNrZHJvcCA9IGZhbHNlO1xuICBAT3V0cHV0KCkgb3BlbkNoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG4gIEBPdXRwdXQoKSBzaG93biA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcbiAgQE91dHB1dCgpIGhpZGRlbiA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBwcml2YXRlIF9vcGVuID0gZmFsc2U7XG4gIHByaXZhdGUgX292ZXJsYXlSZWY6IE92ZXJsYXlSZWYgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBfcG9ydGFsOiBDb21wb25lbnRQb3J0YWw8UmRzRHJvcGRvd25Db250YWluZXJDb21wb25lbnQ+O1xuICBwcml2YXRlIHJlYWRvbmx5IF9jbG9zZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBASG9zdExpc3RlbmVyKCdtb3VzZW92ZXInKVxuICBvbkhvdmVyKCk6IHZvaWQge1xuICAgIHRoaXMuX2hhbmRsZU1vdXNlT3Zlcih0aGlzLmVsZW1lbnRSZWYpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignbW91c2VsZWF2ZScpXG4gIG9uTGVhdmUoKTogdm9pZCB7XG4gICAgdGhpcy5faGFuZGxlTW91c2VMZWF2ZSh0aGlzLmVsZW1lbnRSZWYpO1xuICB9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkO1xuXG4gICAgaWYgKHRhcmdldCkge1xuICAgICAgZnJvbUV2ZW50KHRhcmdldCwgJ2ZvY3VzJylcbiAgICAgICAgLnBpcGUodGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZikpXG4gICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuX2hhbmRsZUZvY3VzKHRoaXMuZWxlbWVudFJlZik7XG4gICAgICAgIH0pO1xuICAgICAgZnJvbUV2ZW50KHRhcmdldCwgJ2JsdXInKVxuICAgICAgICAucGlwZSh0YWtlVW50aWxEZXN0cm95ZWQodGhpcy5kZXN0cm95UmVmKSlcbiAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5faGFuZGxlQmx1cih0aGlzLmVsZW1lbnRSZWYpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLm5nWm9uZS5vblN0YWJsZVxuICAgICAgLnBpcGUodGFrZSgxKSwgdGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZikpXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuX29wZW4pIHtcbiAgICAgICAgICB0aGlzLl9zZXRDbG9zZUhhbmRsZXJzKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgdGhpcy5fdG9nZ2xlLnRvZ2dsZVxuICAgICAgLnBpcGUodGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZikpXG4gICAgICAuc3Vic2NyaWJlKChldmVudCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5fdG9nZ2xlLnRyaWdnZXIgPT09ICdtb3VzZWVudGVyLCBtb3VzZWxlYXZlJykge1xuICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAnbW91c2VlbnRlcicgJiYgIXRoaXMuaXNPcGVuKCkpIHtcbiAgICAgICAgICAgIHRoaXMuc2hvdygpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnQudHlwZSA9PT0gJ21vdXNlbGVhdmUnICYmIHRoaXMuaXNPcGVuKCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGhpZGVPYnNlcnZlcjogUGFydGlhbE9ic2VydmVyPEV2ZW50PiA9IHtcbiAgICAgICAgICAgICAgbmV4dDogbm9vcCxcbiAgICAgICAgICAgICAgZXJyb3I6ICgpID0+IHRoaXMuaGlkZSgpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuX292ZXJsYXlSZWYpIHtcbiAgICAgICAgICAgICAgZnJvbUV2ZW50KHRoaXMuX292ZXJsYXlSZWYub3ZlcmxheUVsZW1lbnQsICdtb3VzZWVudGVyJylcbiAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fb3ZlcmxheVJlZikge1xuICAgICAgICAgICAgICAgICAgICAgIGZyb21FdmVudCh0aGlzLl9vdmVybGF5UmVmLm92ZXJsYXlFbGVtZW50LCAnbW91c2VsZWF2ZScpXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbUV2ZW50KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG9nZ2xlLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtb3VzZWVudGVyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCgxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLl9jbG9zZWQkKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICB0YWtlVW50aWwodGhpcy5fY2xvc2VkJCksXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKGhpZGVPYnNlcnZlcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgdGltZW91dCgxKSxcbiAgICAgICAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLl9jbG9zZWQkKSxcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShoaWRlT2JzZXJ2ZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnRvZ2dsZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIHRoaXMuX3RvZ2dsZS5kaXNhYmxlZCA9IHRoaXMuZGlzYWJsZWQ7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXNbJ2JhY2tkcm9wJ10pIHtcbiAgICAgIHRoaXMuX2NoZWNrVG9nZ2xlKCk7XG5cbiAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgdGhpcy5fb3ZlcmxheVJlZiA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZXNbJ3BsYWNlbWVudCddKSB7XG4gICAgICBpZiAodGhpcy5wbGFjZW1lbnQgPT09IG51bGwgfHwgdGhpcy5wbGFjZW1lbnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnBsYWNlbWVudCA9ICdib3R0b20tbGVmdCc7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLl9vdmVybGF5UmVmICE9PSBudWxsKSB7XG4gICAgICAgIHRoaXMuX292ZXJsYXlSZWYudXBkYXRlUG9zaXRpb25TdHJhdGVneSh0aGlzLl9nZXRQb3NpdGlvblN0cmF0ZWd5KCkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHRoaXMuX3RvZ2dsZSAmJlxuICAgICAgY2hhbmdlc1snZGlzYWJsZWQnXSAmJlxuICAgICAgY2hhbmdlc1snZGlzYWJsZWQnXS5wcmV2aW91c1ZhbHVlICE9PSBjaGFuZ2VzWydkaXNhYmxlZCddLmN1cnJlbnRWYWx1ZVxuICAgICkge1xuICAgICAgdGhpcy5fdG9nZ2xlLmRpc2FibGVkID0gdGhpcy5kaXNhYmxlZDtcblxuICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5oaWRlKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX292ZXJsYXlSZWYpIHtcbiAgICAgIHRoaXMuX292ZXJsYXlSZWYuZGV0YWNoKCk7XG4gICAgfVxuXG4gICAgdGhpcy5fY2xvc2VkJC5uZXh0KCk7XG4gICAgdGhpcy5fY2xvc2VkJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgaXNPcGVuKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9vcGVuO1xuICB9XG5cbiAgc2hvdygpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuZGlzYWJsZWQgJiYgIXRoaXMuX29wZW4pIHtcbiAgICAgIHRoaXMuX2NoZWNrVG9nZ2xlKCk7XG4gICAgICB0aGlzLl9vcGVuID0gdHJ1ZTtcblxuICAgICAgaWYgKCF0aGlzLl9vdmVybGF5UmVmKSB7XG4gICAgICAgIHRoaXMuX292ZXJsYXlSZWYgPSB0aGlzLm92ZXJsYXkuY3JlYXRlKHtcbiAgICAgICAgICBoYXNCYWNrZHJvcDogdGhpcy5iYWNrZHJvcCAhPT0gZmFsc2UsXG4gICAgICAgICAgYmFja2Ryb3BDbGFzczpcbiAgICAgICAgICAgIHRoaXMuYmFja2Ryb3AgPT09ICd0cmFuc3BhcmVudCdcbiAgICAgICAgICAgICAgPyAnY2RrLW92ZXJsYXktdHJhbnNwYXJlbnQtYmFja2Ryb3AnXG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICAgIHBvc2l0aW9uU3RyYXRlZ3k6IHRoaXMuX2dldFBvc2l0aW9uU3RyYXRlZ3koKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fb3ZlcmxheVJlZi5iYWNrZHJvcENsaWNrKCkuc3Vic2NyaWJlKCgpID0+IHRoaXMuaGlkZSgpKTtcbiAgICAgICAgdGhpcy5fcG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChSZHNEcm9wZG93bkNvbnRhaW5lckNvbXBvbmVudCwgbnVsbCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRyb3Bkb3duQ29udGFpbmVyQ29tcG9uZW50UmVmID0gdGhpcy5fb3ZlcmxheVJlZi5hdHRhY2goXG4gICAgICAgIHRoaXMuX3BvcnRhbCxcbiAgICAgICk7XG4gICAgICBkcm9wZG93bkNvbnRhaW5lckNvbXBvbmVudFJlZi5pbnN0YW5jZS50ZW1wbGF0ZVJlZiA9XG4gICAgICAgIHRoaXMuX21lbnUudGVtcGxhdGVSZWY7XG4gICAgICBkcm9wZG93bkNvbnRhaW5lckNvbXBvbmVudFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKTtcblxuICAgICAgdGhpcy5vcGVuQ2hhbmdlZC5lbWl0KHRydWUpO1xuICAgICAgdGhpcy5zaG93bi5lbWl0KCk7XG4gICAgICB0aGlzLl9zZXRDbG9zZUhhbmRsZXJzKCk7XG5cbiAgICAgIGlmICh0aGlzLl90b2dnbGUpIHtcbiAgICAgICAgdGhpcy5fdG9nZ2xlLmlzT3BlbiA9IHRydWU7XG4gICAgICAgIHRoaXMuX3RvZ2dsZS5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBoaWRlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9vcGVuKSB7XG4gICAgICB0aGlzLl9vcGVuID0gZmFsc2U7XG4gICAgICB0aGlzLl90b2dnbGUuaXNPcGVuID0gZmFsc2U7XG5cbiAgICAgIGlmICh0aGlzLl9vdmVybGF5UmVmKSB7XG4gICAgICAgIHRoaXMuX292ZXJsYXlSZWYuZGV0YWNoKCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX2Nsb3NlZCQubmV4dCgpO1xuICAgICAgdGhpcy5vcGVuQ2hhbmdlZC5lbWl0KGZhbHNlKTtcbiAgICAgIHRoaXMuaGlkZGVuLmVtaXQoKTtcbiAgICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgIH1cbiAgfVxuXG4gIHRvZ2dsZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc09wZW4oKSkge1xuICAgICAgdGhpcy5oaWRlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2hvdygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2dldFBsYWNlbWVudCgpOiBSZHNEcm9wZG93blBsYWNlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMucGxhY2VtZW50ICE9PSBudWxsICYmIHRoaXMucGxhY2VtZW50ICE9PSB1bmRlZmluZWRcbiAgICAgID8gdGhpcy5wbGFjZW1lbnRcbiAgICAgIDogJ2JvdHRvbS1sZWZ0JztcbiAgfVxuXG4gIHByaXZhdGUgX3NldENsb3NlSGFuZGxlcnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuYXV0b0Nsb3NlKSB7XG4gICAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgIGNvbnN0IHNob3VsZENsb3NlT25DbGljayA9IChldmVudDogTW91c2VFdmVudCk6IGJvb2xlYW4gPT4ge1xuICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG5cbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICBldmVudC5idXR0b24gPT09IFNFQ09OREFSWV9NT1VTRV9CVVRUT05fQ0xJQ0sgfHxcbiAgICAgICAgICAgIHRoaXMuX3RvZ2dsZS5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZWxlbWVudClcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAodGhpcy5hdXRvQ2xvc2UgPT09ICdpbnNpZGUnKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fb3ZlcmxheVJlZj8ub3ZlcmxheUVsZW1lbnQuY29udGFpbnMoZWxlbWVudCkgfHwgdHJ1ZTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXV0b0Nsb3NlID09PSAnb3V0c2lkZScpIHtcbiAgICAgICAgICAgIHJldHVybiAhdGhpcy5fb3ZlcmxheVJlZj8ub3ZlcmxheUVsZW1lbnQuY29udGFpbnMoZWxlbWVudCkgfHwgZmFsc2U7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBlc2NhcGVzJCA9IGZyb21FdmVudDxLZXlib2FyZEV2ZW50Pihkb2N1bWVudCwgJ2tleWRvd24nKS5waXBlKFxuICAgICAgICAgIGZpbHRlcigoZSkgPT4gZS5rZXkgPT09ICdFc2NhcGUnKSxcbiAgICAgICAgICB0YXAoKGUpID0+IGUucHJldmVudERlZmF1bHQoKSksXG4gICAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Nsb3NlZCQpLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IG1vdXNlRG93bnMkID0gZnJvbUV2ZW50PE1vdXNlRXZlbnQ+KGRvY3VtZW50LCAnbW91c2Vkb3duJykucGlwZShcbiAgICAgICAgICBtYXAoKGUpID0+IHNob3VsZENsb3NlT25DbGljayhlKSksXG4gICAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Nsb3NlZCQpLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGNsb3NlYWJsZUNsaWNrcyQgPSBmcm9tRXZlbnQ8TW91c2VFdmVudD4oXG4gICAgICAgICAgZG9jdW1lbnQsXG4gICAgICAgICAgJ21vdXNldXAnLFxuICAgICAgICApLnBpcGUoXG4gICAgICAgICAgd2l0aExhdGVzdEZyb20obW91c2VEb3ducyQpLFxuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnNcbiAgICAgICAgICBmaWx0ZXIoKFtfLCBzaG91bGRDbG9zZV0pID0+IHNob3VsZENsb3NlKSxcbiAgICAgICAgICBkZWxheSgwKSxcbiAgICAgICAgICB0YWtlVW50aWwodGhpcy5fY2xvc2VkJCksXG4gICAgICAgICk7XG5cbiAgICAgICAgcmFjZTxSZHNEcm9wZG93bkNsb3NlU291cmNlW10+KFtcbiAgICAgICAgICBlc2NhcGVzJC5waXBlKG1hcCgoKSA9PiAnRVNDQVBFJykpLFxuICAgICAgICAgIGNsb3NlYWJsZUNsaWNrcyQucGlwZShtYXAoKCkgPT4gJ0NMSUNLJykpLFxuICAgICAgICBdKVxuICAgICAgICAgIC5waXBlKHRha2VVbnRpbERlc3Ryb3llZCh0aGlzLmRlc3Ryb3lSZWYpKVxuICAgICAgICAgIC5zdWJzY3JpYmUoKHNvdXJjZTogUmRzRHJvcGRvd25DbG9zZVNvdXJjZSkgPT5cbiAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xuXG4gICAgICAgICAgICAgIGlmIChzb3VyY2UgPT09ICdFU0NBUEUnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdG9nZ2xlLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfaGFuZGxlTW91c2VPdmVyKGVsOiBFbGVtZW50UmVmKTogdm9pZCB7XG4gICAgdGhpcy5oYW5kbGVJc1ByZXZCdXR0b24oKTtcbiAgICB0aGlzLmhhbmRsZUlzUHJldkZvY3VzZWQoKTtcbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKGVsLm5hdGl2ZUVsZW1lbnQsICdyZHMtZHJvcGRvd24tLWhvdmVyJyk7XG4gIH1cblxuICBwcml2YXRlIF9oYW5kbGVNb3VzZUxlYXZlKGVsOiBFbGVtZW50UmVmKTogdm9pZCB7XG4gICAgdGhpcy5oYW5kbGVJc1ByZXZCdXR0b24oKTtcbiAgICB0aGlzLmhhbmRsZUlzUHJldkZvY3VzZWQoKTtcbiAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKGVsLm5hdGl2ZUVsZW1lbnQsICdyZHMtZHJvcGRvd24tLWhvdmVyJyk7XG4gIH1cblxuICBwcml2YXRlIF9oYW5kbGVGb2N1cyhlbDogRWxlbWVudFJlZik6IHZvaWQge1xuICAgIHRoaXMuaGFuZGxlSXNQcmV2QnV0dG9uKCk7XG4gICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhlbC5uYXRpdmVFbGVtZW50LCAncmRzLWRyb3Bkb3duLS1mb2N1c2VkJyk7XG4gIH1cblxuICBwcml2YXRlIF9oYW5kbGVCbHVyKGVsOiBFbGVtZW50UmVmKTogdm9pZCB7XG4gICAgdGhpcy5oYW5kbGVJc1ByZXZCdXR0b24oKTtcbiAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKGVsLm5hdGl2ZUVsZW1lbnQsICdyZHMtZHJvcGRvd24tLWZvY3VzZWQnKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldFBvc2l0aW9ucygpOiBDb25uZWN0ZWRQb3NpdGlvbiB7XG4gICAgY29uc3QgcGxhY2VtZW50ID0gdGhpcy5fZ2V0UGxhY2VtZW50KCk7XG4gICAgY29uc3QgcG9zaXRpb25zOiBDb25uZWN0ZWRQb3NpdGlvbiA9IHtcbiAgICAgIG9yaWdpblg6ICdzdGFydCcsXG4gICAgICBvcmlnaW5ZOiAnYm90dG9tJyxcbiAgICAgIG92ZXJsYXlYOiAnc3RhcnQnLFxuICAgICAgb3ZlcmxheVk6ICd0b3AnLFxuICAgICAgb2Zmc2V0WDogMCxcbiAgICAgIG9mZnNldFk6IDAsXG4gICAgfTtcblxuICAgIGlmIChwbGFjZW1lbnQuaW5jbHVkZXMoJ3RvcCcpKSB7XG4gICAgICBwb3NpdGlvbnMub3JpZ2luWSA9ICd0b3AnO1xuICAgICAgcG9zaXRpb25zLm92ZXJsYXlZID0gJ2JvdHRvbSc7XG4gICAgfVxuXG4gICAgaWYgKHBsYWNlbWVudC5pbmNsdWRlcygnY2VudGVyJykpIHtcbiAgICAgIHBvc2l0aW9ucy5vcmlnaW5YID0gJ2NlbnRlcic7XG4gICAgICBwb3NpdGlvbnMub3ZlcmxheVggPSAnY2VudGVyJztcbiAgICB9XG5cbiAgICBpZiAocGxhY2VtZW50LmluY2x1ZGVzKCdyaWdodCcpKSB7XG4gICAgICBwb3NpdGlvbnMub3JpZ2luWCA9IHBsYWNlbWVudC5pbmNsdWRlcygnc3RhcnQnKSA/ICdzdGFydCcgOiAnZW5kJztcbiAgICAgIHBvc2l0aW9ucy5vdmVybGF5WCA9ICdlbmQnO1xuICAgIH0gZWxzZSBpZiAocGxhY2VtZW50LmluY2x1ZGVzKCdlbmQnKSkge1xuICAgICAgcG9zaXRpb25zLm9yaWdpblggPSAnZW5kJztcbiAgICB9XG5cbiAgICByZXR1cm4gcG9zaXRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0UG9zaXRpb25TdHJhdGVneSgpOiBQb3NpdGlvblN0cmF0ZWd5IHtcbiAgICBjb25zdCBvdmVybGF5T3JpZ2luID0gbmV3IENka092ZXJsYXlPcmlnaW4odGhpcy5fdG9nZ2xlLmVsZW1lbnRSZWYpO1xuXG4gICAgcmV0dXJuIHRoaXMub3ZlcmxheVxuICAgICAgLnBvc2l0aW9uKClcbiAgICAgIC5mbGV4aWJsZUNvbm5lY3RlZFRvKG92ZXJsYXlPcmlnaW4uZWxlbWVudFJlZilcbiAgICAgIC53aXRoUG9zaXRpb25zKFt0aGlzLl9nZXRQb3NpdGlvbnMoKV0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2hlY2tUb2dnbGUoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuYmFja2Ryb3AgJiYgdGhpcy5fdG9nZ2xlICYmIHRoaXMuX3RvZ2dsZS50cmlnZ2VyICE9PSAnY2xpY2snKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhY2tkcm9wIGlzIG9ubHkgYWxsb3dlZCBmb3IgJ2NsaWNrJyB0cmlnZ2VyYCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVJc1ByZXZCdXR0b24oKTogdm9pZCB7XG4gICAgY29uc3QgaXNQcmV2QnV0dG9uID1cbiAgICAgIHRoaXMuZWxlbWVudFJlZj8ubmF0aXZlRWxlbWVudD8ubmV4dEVsZW1lbnRTaWJsaW5nPy50YWdOYW1lID09PSAnQlVUVE9OJztcblxuICAgIGlmIChpc1ByZXZCdXR0b24pIHtcbiAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoXG4gICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LFxuICAgICAgICAncmRzLWRyb3Bkb3duLS1wcmV2LWJ1dHRvbicsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKFxuICAgICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCxcbiAgICAgICAgJ3Jkcy1kcm9wZG93bi0tcHJldi1idXR0b24nLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUlzUHJldkZvY3VzZWQoKTogdm9pZCB7XG4gICAgY29uc3QgaW5wdXQgPVxuICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nPy5xdWVyeVNlbGVjdG9yKCdpbnB1dCcpO1xuXG4gICAgaWYgKGlucHV0KSB7XG4gICAgICBpZiAoXG4gICAgICAgIGlucHV0LnBhcmVudEVsZW1lbnQ/LmNsYXNzTGlzdC5jb250YWlucyhcbiAgICAgICAgICAncmRzLWZvcm0tZmllbGRfY29udGVudC1pbmZpeC0tZm9jdXNlZCcsXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKFxuICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LFxuICAgICAgICAgICdyZHMtZHJvcGRvd24tLXByZXYtZm9jdXNlZCcsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKFxuICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LFxuICAgICAgICAgICdyZHMtZHJvcGRvd24tLXByZXYtZm9jdXNlZCcsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3MoXG4gICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LFxuICAgICAgICAncmRzLWRyb3Bkb3duLS1wcmV2LWZvY3VzZWQnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==