import { FocusKeyManager } from '@angular/cdk/a11y';
import { ENTER, hasModifierKey, SPACE, TAB } from '@angular/cdk/keycodes';
import { booleanAttribute, ChangeDetectionStrategy, ChangeDetectorRef, Component, ContentChildren, DestroyRef, inject, Input, QueryList, ViewChildren, ViewEncapsulation, } from '@angular/core';
import { merge, Subscription } from 'rxjs';
import { startWith, switchMap } from 'rxjs/operators';
import { RdsTabLabelWrapperDirective } from './tab-label-wrapper.directive';
import { RdsTabComponent } from './tab.component';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/portal";
import * as i2 from "./tab-label-wrapper.directive";
export class RdsTabsComponent {
    constructor() {
        this.cdr = inject(ChangeDetectorRef);
        this.destroyRef = inject(DestroyRef);
        this._tabLabelSubscription = Subscription.EMPTY;
        this.size = 'm';
        this.stretch = false;
    }
    ngAfterContentInit() {
        if (this._tabLabelSubscription) {
            this._tabLabelSubscription.unsubscribe();
        }
        this._tabLabelSubscription = merge(...this.tabs.map((tab) => tab.stateChanges)).subscribe(() => this.cdr.markForCheck());
        this.tabs.changes
            .pipe(takeUntilDestroyed(this.destroyRef))
            .subscribe(() => {
            if (this.getActiveTabIndex() !== this.selectedIndex) {
                this.selectTab(this.getActiveTabIndex());
            }
            this.cdr.markForCheck();
        });
        this.selectTab(this.getActiveTabIndex());
    }
    ngAfterViewInit() {
        this.focusKeyManager = new FocusKeyManager(this.labelWrappers)
            .skipPredicate((item) => item.disabled)
            .withHorizontalOrientation('ltr')
            .withWrap()
            .withHomeAndEnd();
        this.focusKeyManager.updateActiveItem(this.getActiveTabIndex());
        this.labelWrappers.changes
            .pipe(startWith(this.labelWrappers), switchMap((items) => merge(...items.map((item) => item._focused))), takeUntilDestroyed(this.destroyRef))
            .subscribe((focusedItem) => {
            this.focusKeyManager.updateActiveItem(focusedItem);
        });
    }
    selectTab(tabIndex) {
        const rdsTabComponents = this.tabs.toArray();
        const rdsTabComponent = rdsTabComponents[tabIndex];
        if (rdsTabComponent.disabled) {
            return;
        }
        this.selectedIndex = tabIndex;
        rdsTabComponents.forEach((tab) => (tab.active = false));
        rdsTabComponent.active = true;
    }
    onKeydown(event) {
        if (hasModifierKey(event)) {
            if (event.keyCode === TAB && hasModifierKey(event, 'shiftKey')) {
                if (this.focusKeyManager.activeItemIndex !== null &&
                    this.focusKeyManager.activeItemIndex > 0) {
                    this.focusKeyManager.setFocusOrigin('keyboard');
                    this.focusKeyManager.setPreviousItemActive();
                    event.preventDefault();
                    this.focusKeyManager.onKeydown(event);
                }
                else {
                    this.resetActiveItem();
                }
            }
            return;
        }
        switch (event.keyCode) {
            case ENTER:
            case SPACE:
                if (this.getIndexOfFocusedElement() !== this.selectedIndex) {
                    this.selectTab(this.getIndexOfFocusedElement());
                }
                break;
            case TAB:
                if (this.focusKeyManager.activeItemIndex ===
                    this.labelWrappers.filter((l) => !l.disabled).length - 1) {
                    this.resetActiveItem();
                }
                else {
                    event.preventDefault();
                    this.focusKeyManager.setFocusOrigin('keyboard');
                    this.focusKeyManager.setNextItemActive();
                    this.focusKeyManager.onKeydown(event);
                }
                break;
            default:
                this.focusKeyManager.onKeydown(event);
        }
    }
    resetActiveItem() {
        this.focusKeyManager.setActiveItem(-1);
    }
    getIndexOfFocusedElement() {
        return this.focusKeyManager
            ? this.focusKeyManager.activeItemIndex
            : 0;
    }
    getActiveTabIndex() {
        const activeTabs = this.tabs ? this.tabs.filter((tab) => tab.active) : [];
        return activeTabs.length > 0
            ? this.tabs.toArray().indexOf(activeTabs[0])
            : 0;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsTabsComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "17.3.1", type: RdsTabsComponent, selector: "rds-tabs", inputs: { size: "size", stretch: ["stretch", "stretch", booleanAttribute] }, queries: [{ propertyName: "tabs", predicate: RdsTabComponent }], viewQueries: [{ propertyName: "labelWrappers", predicate: RdsTabLabelWrapperDirective, descendants: true }], ngImport: i0, template: `
    <div class="rds-tabs" [class.rds-tabs-stretch]="stretch">
      <div
        class="rds-tabs__header"
        role="tablist"
        (blur)="resetActiveItem()"
        (keydown)="onKeydown($event)"
      >
        @for (tab of tabs; track tab.label; let i = $index) {
          <div
            class="rds-tabs__tab rds-tabs__tab-size-{{ size }}"
            role="tab"
            rdsTabLabelWrapper
            [disabled]="tab.disabled"
            [attr.tabIndex]="tab.disabled ? '-1' : '0'"
            [attr.aria-posinset]="i + 1"
            [attr.aria-setsize]="tabs.length"
            [attr.aria-disabled]="tab.disabled"
            [attr.aria-selected]="selectedIndex === i"
            [class.rds-tabs__tab--active]="selectedIndex === i"
            [class.rds-tabs__tab--disabled]="tab.disabled"
            (click)="selectTab(i)"
          >
            @if (tab.templateLabel) {
              <ng-template [cdkPortalOutlet]="tab.templateLabel" />
            }
            @if (!tab.templateLabel) {
              {{ tab.label }}
            }
          </div>
        }
      </div>

      <div class="rds-tabs__content-wrapper">
        <ng-content />
      </div>
    </div>
  `, isInline: true, styles: [".rds-tabs .rds-tabs__header{display:flex;border-bottom:1px solid var(--rds-color-grey-2)}.rds-tabs .rds-tabs__tab{font-size:16px;font-weight:400;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;position:relative;top:1px;display:flex;align-items:center;border-bottom:3px solid transparent;margin:0 16px;height:59px;color:var(--rds-color-low-contrast);cursor:pointer}.rds-tabs .rds-tabs__tab:hover,.rds-tabs .rds-tabs__tab:focus{outline:none}.rds-tabs .rds-tabs__tab>*{margin-left:12px}.rds-tabs .rds-tabs__tab>*:first-child{margin-left:0}.rds-tabs .rds-tabs__tab:first-child{padding-left:0;margin-left:0}.rds-tabs .rds-tabs__tab.rds-tabs__tab--active{border-bottom:3px solid var(--rds-color-informative-hover);color:var(--rds-color-informative-hover)}.rds-tabs .rds-tabs__tab.rds-tabs__tab--disabled{color:var(--rds-color-disabled);pointer-events:none;cursor:default}.rds-tabs .rds-tabs__tab:hover:not(.rds-tabs__tab--disabled):not(.rds-tabs__tab--active){border-bottom:3px solid var(--rds-color-informative-hover)}.rds-tabs .rds-tabs__tab.cdk-focused.cdk-keyboard-focused:not(.rds-tabs__tab--disabled){border-radius:2px;outline:2px solid var(--rds-color-stroke-active-focus);outline-offset:2px}.rds-tabs .rds-tabs__tab-size-s{margin:0 12px;height:43px}.rds-tabs.rds-tabs-stretch .rds-tabs__tab{flex-basis:0;flex-grow:1}\n"], dependencies: [{ kind: "directive", type: i1.CdkPortalOutlet, selector: "[cdkPortalOutlet]", inputs: ["cdkPortalOutlet"], outputs: ["attached"], exportAs: ["cdkPortalOutlet"] }, { kind: "directive", type: i2.RdsTabLabelWrapperDirective, selector: "[rdsTabLabelWrapper]", inputs: ["disabled"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush, encapsulation: i0.ViewEncapsulation.None }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsTabsComponent, decorators: [{
            type: Component,
            args: [{ selector: 'rds-tabs', template: `
    <div class="rds-tabs" [class.rds-tabs-stretch]="stretch">
      <div
        class="rds-tabs__header"
        role="tablist"
        (blur)="resetActiveItem()"
        (keydown)="onKeydown($event)"
      >
        @for (tab of tabs; track tab.label; let i = $index) {
          <div
            class="rds-tabs__tab rds-tabs__tab-size-{{ size }}"
            role="tab"
            rdsTabLabelWrapper
            [disabled]="tab.disabled"
            [attr.tabIndex]="tab.disabled ? '-1' : '0'"
            [attr.aria-posinset]="i + 1"
            [attr.aria-setsize]="tabs.length"
            [attr.aria-disabled]="tab.disabled"
            [attr.aria-selected]="selectedIndex === i"
            [class.rds-tabs__tab--active]="selectedIndex === i"
            [class.rds-tabs__tab--disabled]="tab.disabled"
            (click)="selectTab(i)"
          >
            @if (tab.templateLabel) {
              <ng-template [cdkPortalOutlet]="tab.templateLabel" />
            }
            @if (!tab.templateLabel) {
              {{ tab.label }}
            }
          </div>
        }
      </div>

      <div class="rds-tabs__content-wrapper">
        <ng-content />
      </div>
    </div>
  `, changeDetection: ChangeDetectionStrategy.OnPush, encapsulation: ViewEncapsulation.None, styles: [".rds-tabs .rds-tabs__header{display:flex;border-bottom:1px solid var(--rds-color-grey-2)}.rds-tabs .rds-tabs__tab{font-size:16px;font-weight:400;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;position:relative;top:1px;display:flex;align-items:center;border-bottom:3px solid transparent;margin:0 16px;height:59px;color:var(--rds-color-low-contrast);cursor:pointer}.rds-tabs .rds-tabs__tab:hover,.rds-tabs .rds-tabs__tab:focus{outline:none}.rds-tabs .rds-tabs__tab>*{margin-left:12px}.rds-tabs .rds-tabs__tab>*:first-child{margin-left:0}.rds-tabs .rds-tabs__tab:first-child{padding-left:0;margin-left:0}.rds-tabs .rds-tabs__tab.rds-tabs__tab--active{border-bottom:3px solid var(--rds-color-informative-hover);color:var(--rds-color-informative-hover)}.rds-tabs .rds-tabs__tab.rds-tabs__tab--disabled{color:var(--rds-color-disabled);pointer-events:none;cursor:default}.rds-tabs .rds-tabs__tab:hover:not(.rds-tabs__tab--disabled):not(.rds-tabs__tab--active){border-bottom:3px solid var(--rds-color-informative-hover)}.rds-tabs .rds-tabs__tab.cdk-focused.cdk-keyboard-focused:not(.rds-tabs__tab--disabled){border-radius:2px;outline:2px solid var(--rds-color-stroke-active-focus);outline-offset:2px}.rds-tabs .rds-tabs__tab-size-s{margin:0 12px;height:43px}.rds-tabs.rds-tabs-stretch .rds-tabs__tab{flex-basis:0;flex-grow:1}\n"] }]
        }], propDecorators: { tabs: [{
                type: ContentChildren,
                args: [RdsTabComponent]
            }], labelWrappers: [{
                type: ViewChildren,
                args: [RdsTabLabelWrapperDirective]
            }], size: [{
                type: Input
            }], stretch: [{
                type: Input,
                args: [{ transform: booleanAttribute }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFicy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItY29tcG9uZW50cy9zcmMvbGliL3RhYi90YWJzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFFLE9BQU8sRUFHTCxnQkFBZ0IsRUFDaEIsdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsZUFBZSxFQUNmLFVBQVUsRUFDVixNQUFNLEVBQ04sS0FBSyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osaUJBQWlCLEdBQ2xCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDNUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRWxELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDOzs7O0FBZ0RoRSxNQUFNLE9BQU8sZ0JBQWdCO0lBNUM3QjtRQTZDbUIsUUFBRyxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ2hDLGVBQVUsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7UUFJekMsMEJBQXFCLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQztRQVMxQyxTQUFJLEdBQWdCLEdBQUcsQ0FBQztRQUVPLFlBQU8sR0FBRyxLQUFLLENBQUM7S0E0SHpEO0lBMUhDLGtCQUFrQjtR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Ozs7Ozs7R0FxQ1QsbUJBRWdCLHVCQUF1QixDQUFDLE1BQU0saUJBQ2hDLGlCQUFpQixDQUFDLElBQUk7OEJBWUgsSUFBSTtzQkFBckMsZUFBZTt1QkFBQyxlQUFlO2dCQUdoQyxhQUFhO3NCQURaLFlBQVk7dUJBQUMsMkJBQTJCO2dCQUdoQyxJQUFJO3NCQUFaLEtBQUs7Z0JBRWtDLE9BQU87c0JBQTlDLEtBQUs7dUJBQUMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb2N1c0tleU1hbmFnZXIgfSBmcm9tICdAYW5ndWxhci9jZGsvYTExeSc7XG5pbXBvcnQgeyBFTlRFUiwgaGFzTW9kaWZpZXJLZXksIFNQQUNFLCBUQUIgfSBmcm9tICdAYW5ndWxhci9jZGsva2V5Y29kZXMnO1xuaW1wb3J0IHtcbiAgQWZ0ZXJDb250ZW50SW5pdCxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgYm9vbGVhbkF0dHJpYnV0ZSxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnQsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgRGVzdHJveVJlZixcbiAgaW5qZWN0LFxuICBJbnB1dCxcbiAgUXVlcnlMaXN0LFxuICBWaWV3Q2hpbGRyZW4sXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG1lcmdlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN0YXJ0V2l0aCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUmRzVGFiTGFiZWxXcmFwcGVyRGlyZWN0aXZlIH0gZnJvbSAnLi90YWItbGFiZWwtd3JhcHBlci5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgUmRzVGFiQ29tcG9uZW50IH0gZnJvbSAnLi90YWIuY29tcG9uZW50JztcbmltcG9ydCB7IFJkc01lbnVJdGVtQ29tcG9uZW50IH0gZnJvbSAnLi4vbWVudSc7XG5pbXBvcnQgeyB0YWtlVW50aWxEZXN0cm95ZWQgfSBmcm9tICdAYW5ndWxhci9jb3JlL3J4anMtaW50ZXJvcCc7XG5cbmV4cG9ydCB0eXBlIFJkc1RhYnNTaXplID0gJ3MnIHwgJ20nO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdyZHMtdGFicycsXG4gIHRlbXBsYXRlOiBgXG4gICAgPGRpdiBjbGFzcz1cInJkcy10YWJzXCIgW2NsYXNzLnJkcy10YWJzLXN0cmV0Y2hdPVwic3RyZXRjaFwiPlxuICAgICAgPGRpdlxuICAgICAgICBjbGFzcz1cInJkcy10YWJzX19oZWFkZXJcIlxuICAgICAgICByb2xlPVwidGFibGlzdFwiXG4gICAgICAgIChibHVyKT1cInJlc2V0QWN0aXZlSXRlbSgpXCJcbiAgICAgICAgKGtleWRvd24pPVwib25LZXlkb3duKCRldmVudClcIlxuICAgICAgPlxuICAgICAgICBAZm9yICh0YWIgb2YgdGFiczsgdHJhY2sgdGFiLmxhYmVsOyBsZXQgaSA9ICRpbmRleCkge1xuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIGNsYXNzPVwicmRzLXRhYnNfX3RhYiByZHMtdGFic19fdGFiLXNpemUte3sgc2l6ZSB9fVwiXG4gICAgICAgICAgICByb2xlPVwidGFiXCJcbiAgICAgICAgICAgIHJkc1RhYkxhYmVsV3JhcHBlclxuICAgICAgICAgICAgW2Rpc2FibGVkXT1cInRhYi5kaXNhYmxlZFwiXG4gICAgICAgICAgICBbYXR0ci50YWJJbmRleF09XCJ0YWIuZGlzYWJsZWQgPyAnLTEnIDogJzAnXCJcbiAgICAgICAgICAgIFthdHRyLmFyaWEtcG9zaW5zZXRdPVwiaSArIDFcIlxuICAgICAgICAgICAgW2F0dHIuYXJpYS1zZXRzaXplXT1cInRhYnMubGVuZ3RoXCJcbiAgICAgICAgICAgIFthdHRyLmFyaWEtZGlzYWJsZWRdPVwidGFiLmRpc2FibGVkXCJcbiAgICAgICAgICAgIFthdHRyLmFyaWEtc2VsZWN0ZWRdPVwic2VsZWN0ZWRJbmRleCA9PT0gaVwiXG4gICAgICAgICAgICBbY2xhc3MucmRzLXRhYnNfX3RhYi0tYWN0aXZlXT1cInNlbGVjdGVkSW5kZXggPT09IGlcIlxuICAgICAgICAgICAgW2NsYXNzLnJkcy10YWJzX190YWItLWRpc2FibGVkXT1cInRhYi5kaXNhYmxlZFwiXG4gICAgICAgICAgICAoY2xpY2spPVwic2VsZWN0VGFiKGkpXCJcbiAgICAgICAgICA+XG4gICAgICAgICAgICBAaWYgKHRhYi50ZW1wbGF0ZUxhYmVsKSB7XG4gICAgICAgICAgICAgIDxuZy10ZW1wbGF0ZSBbY2RrUG9ydGFsT3V0bGV0XT1cInRhYi50ZW1wbGF0ZUxhYmVsXCIgLz5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIEBpZiAoIXRhYi50ZW1wbGF0ZUxhYmVsKSB7XG4gICAgICAgICAgICAgIHt7IHRhYi5sYWJlbCB9fVxuICAgICAgICAgICAgfVxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICB9XG4gICAgICA8L2Rpdj5cblxuICAgICAgPGRpdiBjbGFzcz1cInJkcy10YWJzX19jb250ZW50LXdyYXBwZXJcIj5cbiAgICAgICAgPG5nLWNvbnRlbnQgLz5cbiAgICAgIDwvZGl2PlxuICAgIDwvZGl2PlxuICBgLFxuICBzdHlsZVVybHM6IFsnLi90YWJzLmNvbXBvbmVudC5zY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxufSlcbmV4cG9ydCBjbGFzcyBSZHNUYWJzQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2RyID0gaW5qZWN0KENoYW5nZURldGVjdG9yUmVmKTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZXN0cm95UmVmID0gaW5qZWN0KERlc3Ryb3lSZWYpO1xuXG4gIHByaXZhdGUgZm9jdXNLZXlNYW5hZ2VyOiBGb2N1c0tleU1hbmFnZXI8UmRzVGFiTGFiZWxXcmFwcGVyRGlyZWN0aXZlPjtcblxuICBwcml2YXRlIF90YWJMYWJlbFN1YnNjcmlwdGlvbiA9IFN1YnNjcmlwdGlvbi5FTVBUWTtcblxuICBzZWxlY3RlZEluZGV4OiBudW1iZXI7XG5cbiAgQENvbnRlbnRDaGlsZHJlbihSZHNUYWJDb21wb25lbnQpIHRhYnM6IFF1ZXJ5TGlzdDxSZHNUYWJDb21wb25lbnQ+O1xuXG4gIEBWaWV3Q2hpbGRyZW4oUmRzVGFiTGFiZWxXcmFwcGVyRGlyZWN0aXZlKVxuICBsYWJlbFdyYXBwZXJzOiBRdWVyeUxpc3Q8UmRzVGFiTGFiZWxXcmFwcGVyRGlyZWN0aXZlPjtcblxuICBASW5wdXQoKSBzaXplOiBSZHNUYWJzU2l6ZSA9ICdtJztcblxuICBASW5wdXQoeyB0cmFuc2Zvcm06IGJvb2xlYW5BdHRyaWJ1dGUgfSkgc3RyZXRjaCA9IGZhbHNlO1xuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fdGFiTGFiZWxTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuX3RhYkxhYmVsU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgdGhpcy5fdGFiTGFiZWxTdWJzY3JpcHRpb24gPSBtZXJnZShcbiAgICAgIC4uLnRoaXMudGFicy5tYXAoKHRhYikgPT4gdGFiLnN0YXRlQ2hhbmdlcyksXG4gICAgKS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5jZHIubWFya0ZvckNoZWNrKCkpO1xuXG4gICAgdGhpcy50YWJzLmNoYW5nZXNcbiAgICAgIC5waXBlKHRha2VVbnRpbERlc3Ryb3llZCh0aGlzLmRlc3Ryb3lSZWYpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmdldEFjdGl2ZVRhYkluZGV4KCkgIT09IHRoaXMuc2VsZWN0ZWRJbmRleCkge1xuICAgICAgICAgIHRoaXMuc2VsZWN0VGFiKHRoaXMuZ2V0QWN0aXZlVGFiSW5kZXgoKSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNkci5tYXJrRm9yQ2hlY2soKTtcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5zZWxlY3RUYWIodGhpcy5nZXRBY3RpdmVUYWJJbmRleCgpKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmZvY3VzS2V5TWFuYWdlciA9IG5ldyBGb2N1c0tleU1hbmFnZXI8UmRzVGFiTGFiZWxXcmFwcGVyRGlyZWN0aXZlPihcbiAgICAgIHRoaXMubGFiZWxXcmFwcGVycyxcbiAgICApXG4gICAgICAuc2tpcFByZWRpY2F0ZSgoaXRlbSkgPT4gaXRlbS5kaXNhYmxlZClcbiAgICAgIC53aXRoSG9yaXpvbnRhbE9yaWVudGF0aW9uKCdsdHInKVxuICAgICAgLndpdGhXcmFwKClcbiAgICAgIC53aXRoSG9tZUFuZEVuZCgpO1xuICAgIHRoaXMuZm9jdXNLZXlNYW5hZ2VyLnVwZGF0ZUFjdGl2ZUl0ZW0odGhpcy5nZXRBY3RpdmVUYWJJbmRleCgpKTtcbiAgICB0aGlzLmxhYmVsV3JhcHBlcnMuY2hhbmdlc1xuICAgICAgLnBpcGUoXG4gICAgICAgIHN0YXJ0V2l0aCh0aGlzLmxhYmVsV3JhcHBlcnMpLFxuICAgICAgICBzd2l0Y2hNYXAoKGl0ZW1zKSA9PlxuICAgICAgICAgIG1lcmdlKC4uLml0ZW1zLm1hcCgoaXRlbTogUmRzTWVudUl0ZW1Db21wb25lbnQpID0+IGl0ZW0uX2ZvY3VzZWQpKSxcbiAgICAgICAgKSxcbiAgICAgICAgdGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZiksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChmb2N1c2VkSXRlbSkgPT4ge1xuICAgICAgICB0aGlzLmZvY3VzS2V5TWFuYWdlci51cGRhdGVBY3RpdmVJdGVtKFxuICAgICAgICAgIGZvY3VzZWRJdGVtIGFzIFJkc1RhYkxhYmVsV3JhcHBlckRpcmVjdGl2ZSxcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgc2VsZWN0VGFiKHRhYkluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCByZHNUYWJDb21wb25lbnRzID0gdGhpcy50YWJzLnRvQXJyYXkoKTtcbiAgICBjb25zdCByZHNUYWJDb21wb25lbnQgPSByZHNUYWJDb21wb25lbnRzW3RhYkluZGV4XTtcblxuICAgIGlmIChyZHNUYWJDb21wb25lbnQuZGlzYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnNlbGVjdGVkSW5kZXggPSB0YWJJbmRleDtcbiAgICByZHNUYWJDb21wb25lbnRzLmZvckVhY2goKHRhYikgPT4gKHRhYi5hY3RpdmUgPSBmYWxzZSkpO1xuICAgIHJkc1RhYkNvbXBvbmVudC5hY3RpdmUgPSB0cnVlO1xuICB9XG5cbiAgb25LZXlkb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgaWYgKGhhc01vZGlmaWVyS2V5KGV2ZW50KSkge1xuICAgICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IFRBQiAmJiBoYXNNb2RpZmllcktleShldmVudCwgJ3NoaWZ0S2V5JykpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHRoaXMuZm9jdXNLZXlNYW5hZ2VyLmFjdGl2ZUl0ZW1JbmRleCAhPT0gbnVsbCAmJlxuICAgICAgICAgIHRoaXMuZm9jdXNLZXlNYW5hZ2VyLmFjdGl2ZUl0ZW1JbmRleCA+IDBcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpcy5mb2N1c0tleU1hbmFnZXIuc2V0Rm9jdXNPcmlnaW4oJ2tleWJvYXJkJyk7XG4gICAgICAgICAgdGhpcy5mb2N1c0tleU1hbmFnZXIuc2V0UHJldmlvdXNJdGVtQWN0aXZlKCk7XG4gICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICB0aGlzLmZvY3VzS2V5TWFuYWdlci5vbktleWRvd24oZXZlbnQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMucmVzZXRBY3RpdmVJdGVtKCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHN3aXRjaCAoZXZlbnQua2V5Q29kZSkge1xuICAgICAgY2FzZSBFTlRFUjpcbiAgICAgIGNhc2UgU1BBQ0U6XG4gICAgICAgIGlmICh0aGlzLmdldEluZGV4T2ZGb2N1c2VkRWxlbWVudCgpICE9PSB0aGlzLnNlbGVjdGVkSW5kZXgpIHtcbiAgICAgICAgICB0aGlzLnNlbGVjdFRhYih0aGlzLmdldEluZGV4T2ZGb2N1c2VkRWxlbWVudCgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUQUI6XG4gICAgICAgIGlmIChcbiAgICAgICAgICB0aGlzLmZvY3VzS2V5TWFuYWdlci5hY3RpdmVJdGVtSW5kZXggPT09XG4gICAgICAgICAgdGhpcy5sYWJlbFdyYXBwZXJzLmZpbHRlcigobCkgPT4gIWwuZGlzYWJsZWQpLmxlbmd0aCAtIDFcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpcy5yZXNldEFjdGl2ZUl0ZW0oKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIHRoaXMuZm9jdXNLZXlNYW5hZ2VyLnNldEZvY3VzT3JpZ2luKCdrZXlib2FyZCcpO1xuICAgICAgICAgIHRoaXMuZm9jdXNLZXlNYW5hZ2VyLnNldE5leHRJdGVtQWN0aXZlKCk7XG4gICAgICAgICAgdGhpcy5mb2N1c0tleU1hbmFnZXIub25LZXlkb3duKGV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5mb2N1c0tleU1hbmFnZXIub25LZXlkb3duKGV2ZW50KTtcbiAgICB9XG4gIH1cblxuICByZXNldEFjdGl2ZUl0ZW0oKTogdm9pZCB7XG4gICAgdGhpcy5mb2N1c0tleU1hbmFnZXIuc2V0QWN0aXZlSXRlbSgtMSk7XG4gIH1cblxuICBwcml2YXRlIGdldEluZGV4T2ZGb2N1c2VkRWxlbWVudCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmZvY3VzS2V5TWFuYWdlclxuICAgICAgPyAodGhpcy5mb2N1c0tleU1hbmFnZXIuYWN0aXZlSXRlbUluZGV4IGFzIG51bWJlcilcbiAgICAgIDogMDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QWN0aXZlVGFiSW5kZXgoKTogbnVtYmVyIHtcbiAgICBjb25zdCBhY3RpdmVUYWJzID0gdGhpcy50YWJzID8gdGhpcy50YWJzLmZpbHRlcigodGFiKSA9PiB0YWIuYWN0aXZlKSA6IFtdO1xuXG4gICAgcmV0dXJuIGFjdGl2ZVRhYnMubGVuZ3RoID4gMFxuICAgICAgPyB0aGlzLnRhYnMudG9BcnJheSgpLmluZGV4T2YoYWN0aXZlVGFic1swXSlcbiAgICAgIDogMDtcbiAgfVxufVxuIl19