import { coerceStringArray } from '@angular/cdk/coercion';
import { BACKSPACE, hasModifierKey } from '@angular/cdk/keycodes';
import { booleanAttribute, Directive, ElementRef, EventEmitter, HostBinding, HostListener, inject, Input, isDevMode, Output, } from '@angular/core';
import { RDS_FORM_FIELD, } from '../form-field';
import { RdsChipGridComponent } from './chip-grid/chip-grid.component';
import { RDS_CHIPS_DEFAULT_OPTIONS } from '../chips/chip.tokens';
import { NgControl } from '@angular/forms';
import * as i0 from "@angular/core";
let nextUniqueId = 0;
export class RdsChipInputDirective {
    get classes() {
        return {
            'rds-chip-input': true,
            'rds-chip-input-no-placeholder': this.hidePlaceholder,
        };
    }
    get ariaRequired() {
        return this.required || null;
    }
    get ariaInvalid() {
        return this.ngControl ? this.ngControl.invalid : null;
    }
    /* eslint-disable-next-line @angular-eslint/no-input-rename */
    set chipGrid(value) {
        if (value) {
            this._chipGrid = value;
            this._chipGrid.registerInput(this);
        }
        else if (isDevMode()) {
            throw new Error('RdsChipInputDirective: rdsChipInputChipGrid received falsy value');
        }
    }
    set disabled(value) {
        this._disabled = booleanAttribute(value);
    }
    get disabled() {
        return this._disabled || !!(this._chipGrid && this._chipGrid.disabled);
    }
    get empty() {
        return !this.inputElement.value;
    }
    constructor() {
        this.inputElement = inject(ElementRef).nativeElement;
        this.formField = inject(RDS_FORM_FIELD, { optional: true });
        this.ngControl = inject(NgControl, { optional: true });
        this.focusLastChipOnBackspace = false;
        this._disabled = false;
        this.focused = false;
        this.hidePlaceholder = false;
        this.required = false;
        /* eslint-disable-next-line @angular-eslint/no-input-rename */
        this.addOnBlur = false;
        /* eslint-disable-next-line @angular-eslint/no-input-rename */
        this.separatorKeys = inject(RDS_CHIPS_DEFAULT_OPTIONS).separatorKeys;
        this.placeholder = '';
        this.id = `rds-chip-list-input-${nextUniqueId++}`;
        /* eslint-disable-next-line @angular-eslint/no-output-rename */
        this.chipEnd = new EventEmitter();
        if (this.formField) {
            this.inputElement.classList.add('rds-form-field-input-control');
        }
    }
    ngOnChanges() {
        this._chipGrid?.stateChanges?.next();
    }
    ngAfterContentInit() {
        this.focusLastChipOnBackspace = this.empty;
    }
    ngOnDestroy() {
        this.chipEnd.complete();
    }
    onKeydown(event) {
        if (event) {
            // To prevent the user from accidentally deleting chips when pressing BACKSPACE continuously,
            // We focus the last chip on backspace only after the user has released the backspace button,
            // And the input is empty (see behaviour in _keyup)
            if (event.keyCode === BACKSPACE && this.focusLastChipOnBackspace) {
                this._chipGrid?.focusLastChip();
                event.preventDefault();
                return;
            }
            else {
                this.focusLastChipOnBackspace = false;
            }
        }
        this.emitChipEnd(event);
    }
    onKeyup(event) {
        // Allow user to move focus to chips next time he presses backspace
        if (!this.focusLastChipOnBackspace &&
            event.keyCode === BACKSPACE &&
            this.empty) {
            this.focusLastChipOnBackspace = true;
            event.preventDefault();
        }
    }
    onBlur() {
        if (this.addOnBlur) {
            this.emitChipEnd();
        }
        this.focused = false;
        // Blur the chip list if it is not focused
        if (!this._chipGrid?.focused) {
            this._chipGrid?.blur();
        }
        this._chipGrid?.stateChanges.next();
    }
    onFocus() {
        this.focused = true;
        this.focusLastChipOnBackspace = this.empty;
        this._chipGrid?.stateChanges.next();
    }
    onInput() {
        // Let chip list know whenever the value changes.
        this._chipGrid?.stateChanges.next();
    }
    emitChipEnd(event) {
        if (!event || this.isSeparatorKey(event)) {
            this.chipEnd.emit({
                input: this.inputElement,
                value: this.inputElement.value,
                chipInput: this,
            });
            event?.preventDefault();
        }
    }
    focus() {
        this.inputElement.focus();
    }
    clear() {
        this.inputElement.value = '';
        this.focusLastChipOnBackspace = true;
    }
    setDescribedByIds(ids) {
        // Set the value directly in the DOM since this binding
        // is prone to "changed after checked" errors.
        if (ids.length) {
            this.inputElement.setAttribute('aria-describedby', ids.join(' '));
        }
        else {
            this.inputElement.removeAttribute('aria-describedby');
        }
    }
    isSeparatorKey(event) {
        return !hasModifierKey(event) && this.separatorKeys.includes(event.key);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsChipInputDirective, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "16.1.0", version: "17.3.1", type: RdsChipInputDirective, selector: "input[rdsChipInput], input[rds-chip-input]", inputs: { required: ["required", "required", booleanAttribute], chipGrid: ["rdsChipInputChipGrid", "chipGrid"], addOnBlur: ["rdsChipInputAddOnBlur", "addOnBlur", booleanAttribute], separatorKeys: ["rdsChipInputSeparatorKeys", "separatorKeys", coerceStringArray], placeholder: "placeholder", id: "id", disabled: "disabled" }, outputs: { chipEnd: "rdsChipInputTokenEnd" }, host: { listeners: { "keydown": "onKeydown($event)", "keyup": "onKeyup($event)", "blur": "onBlur($event)", "focus": "onFocus($event)", "input": "onInput()" }, properties: { "class": "this.classes", "attr.required": "this.ariaRequired", "attr.aria-required": "this.ariaRequired", "attr.aria-invalid": "this.ariaInvalid", "attr.placeholder": "this.placeholder", "id": "this.id", "disabled": "this.disabled" } }, exportAs: ["rdsChipInput"], usesOnChanges: true, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsChipInputDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'input[rdsChipInput], input[rds-chip-input]',
                    exportAs: 'rdsChipInput',
                }]
        }], ctorParameters: () => [], propDecorators: { required: [{
                type: Input,
                args: [{ transform: booleanAttribute }]
            }], classes: [{
                type: HostBinding,
                args: ['class']
            }], ariaRequired: [{
                type: HostBinding,
                args: ['attr.required']
            }, {
                type: HostBinding,
                args: ['attr.aria-required']
            }], ariaInvalid: [{
                type: HostBinding,
                args: ['attr.aria-invalid']
            }], chipGrid: [{
                type: Input,
                args: ['rdsChipInputChipGrid']
            }], addOnBlur: [{
                type: Input,
                args: [{ alias: 'rdsChipInputAddOnBlur', transform: booleanAttribute }]
            }], separatorKeys: [{
                type: Input,
                args: [{ alias: 'rdsChipInputSeparatorKeys', transform: coerceStringArray }]
            }], placeholder: [{
                type: HostBinding,
                args: ['attr.placeholder']
            }, {
                type: Input
            }], id: [{
                type: HostBinding,
                args: ['id']
            }, {
                type: Input
            }], disabled: [{
                type: HostBinding,
                args: ['disabled']
            }, {
                type: Input
            }], chipEnd: [{
                type: Output,
                args: ['rdsChipInputTokenEnd']
            }], onKeydown: [{
                type: HostListener,
                args: ['keydown', ['$event']]
            }], onKeyup: [{
                type: HostListener,
                args: ['keyup', ['$event']]
            }], onBlur: [{
                type: HostListener,
                args: ['blur', ['$event']]
            }], onFocus: [{
                type: HostListener,
                args: ['focus', ['$event']]
            }], onInput: [{
                type: HostListener,
                args: ['input']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hpcC1pbnB1dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvYW5ndWxhci1jb21wb25lbnRzL3NyYy9saWIvZm9ybS1maWVsZC9jaGlwLWlucHV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBZ0IsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2xFLE9BQU8sRUFFTCxnQkFBZ0IsRUFDaEIsU0FBUyxFQUNULFVBQVUsRUFDVixZQUFZLEVBQ1osV0FBVyxFQUNYLFlBQVksRUFDWixNQUFNLEVBQ04sS0FBSyxFQUNMLFNBQVMsRUFHVCxNQUFNLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNMLGNBQWMsR0FHZixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUN2RSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBRTNDLElBQUksWUFBWSxHQUFHLENBQUMsQ0FBQztBQU1yQixNQUFNLE9BQU8scUJBQXFCO0lBb0JoQyxJQUNJLE9BQU87UUFDVCxPQUFPO1lBQ0wsZ0JBQWdCLEVBQUUsSUFBSTtZQUN0QiwrQkFBK0IsRUFBRSxJQUFJLENBQUMsZUFBZTtTQUN0RCxDQUFDO0lBQ0osQ0FBQztJQUVELElBRUksWUFBWTtRQUNkLE9BQU8sSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQ0ksV0FBVztRQUNiLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJ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RSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUU7Z0JBR2xDLE9BQU87c0JBRFYsV0FBVzt1QkFBQyxPQUFPO2dCQVVoQixZQUFZO3NCQUZmLFdBQVc7dUJBQUMsZUFBZTs7c0JBQzNCLFdBQVc7dUJBQUMsb0JBQW9CO2dCQU03QixXQUFXO3NCQURkLFdBQVc7dUJBQUMsbUJBQW1CO2dCQU81QixRQUFRO3NCQURYLEtBQUs7dUJBQUMsc0JBQXNCO2dCQWM3QixTQUFTO3NCQURSLEtBQUs7dUJBQUMsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixFQUFFO2dCQUl0RSxhQUFhO3NCQURaLEtBQUs7dUJBQUMsRUFBRSxLQUFLLEVBQUUsMkJBQTJCLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFO2dCQUszRSxXQUFXO3NCQUZWLFdBQVc7dUJBQUMsa0JBQWtCOztzQkFDOUIsS0FBSztnQkFLTixFQUFFO3NCQUZELFdBQVc7dUJBQUMsSUFBSTs7c0JBQ2hCLEtBQUs7Z0JBS0YsUUFBUTtzQkFGWCxXQUFXO3VCQUFDLFVBQVU7O3NCQUN0QixLQUFLO2dCQVdHLE9BQU87c0JBRGYsTUFBTTt1QkFBQyxzQkFBc0I7Z0JBMEJ0QixTQUFTO3NCQURoQixZQUFZO3VCQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQztnQkFvQm5DLE9BQU87c0JBRE4sWUFBWTt1QkFBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBY2pDLE1BQU07c0JBREwsWUFBWTt1QkFBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBaUJoQyxPQUFPO3NCQUROLFlBQVk7dUJBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDO2dCQVFqQyxPQUFPO3NCQUROLFlBQVk7dUJBQUMsT0FBTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJvb2xlYW5JbnB1dCwgY29lcmNlU3RyaW5nQXJyYXkgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xuaW1wb3J0IHsgQkFDS1NQQUNFLCBoYXNNb2RpZmllcktleSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9rZXljb2Rlcyc7XG5pbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBib29sZWFuQXR0cmlidXRlLFxuICBEaXJlY3RpdmUsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSG9zdEJpbmRpbmcsXG4gIEhvc3RMaXN0ZW5lcixcbiAgaW5qZWN0LFxuICBJbnB1dCxcbiAgaXNEZXZNb2RlLFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIFJEU19GT1JNX0ZJRUxELFxuICBSZHNDaGlwSW5wdXRFdmVudCxcbiAgUmRzRm9ybUZpZWxkQ29tcG9uZW50LFxufSBmcm9tICcuLi9mb3JtLWZpZWxkJztcbmltcG9ydCB7IFJkc0NoaXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi9jaGlwLWdyaWQvY2hpcC1ncmlkLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBSRFNfQ0hJUFNfREVGQVVMVF9PUFRJT05TIH0gZnJvbSAnLi4vY2hpcHMvY2hpcC50b2tlbnMnO1xuaW1wb3J0IHsgTmdDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5sZXQgbmV4dFVuaXF1ZUlkID0gMDtcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnaW5wdXRbcmRzQ2hpcElucHV0XSwgaW5wdXRbcmRzLWNoaXAtaW5wdXRdJyxcbiAgZXhwb3J0QXM6ICdyZHNDaGlwSW5wdXQnLFxufSlcbmV4cG9ydCBjbGFzcyBSZHNDaGlwSW5wdXREaXJlY3RpdmU8VD5cbiAgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveVxue1xuICBwcml2YXRlIHJlYWRvbmx5IGlucHV0RWxlbWVudCA9XG4gICAgaW5qZWN0PEVsZW1lbnRSZWY8SFRNTElucHV0RWxlbWVudD4+KEVsZW1lbnRSZWYpLm5hdGl2ZUVsZW1lbnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgZm9ybUZpZWxkID0gaW5qZWN0PFJkc0Zvcm1GaWVsZENvbXBvbmVudDxUW10+PihcbiAgICBSRFNfRk9STV9GSUVMRCxcbiAgICB7IG9wdGlvbmFsOiB0cnVlIH0sXG4gICk7XG4gIHByaXZhdGUgcmVhZG9ubHkgbmdDb250cm9sID0gaW5qZWN0KE5nQ29udHJvbCwgeyBvcHRpb25hbDogdHJ1ZSB9KTtcblxuICBwcml2YXRlIGZvY3VzTGFzdENoaXBPbkJhY2tzcGFjZSA9IGZhbHNlO1xuICBwcml2YXRlIF9kaXNhYmxlZCA9IGZhbHNlO1xuICBwcml2YXRlIF9jaGlwR3JpZD86IFJkc0NoaXBHcmlkQ29tcG9uZW50PFQ+O1xuXG4gIGZvY3VzZWQgPSBmYWxzZTtcbiAgaGlkZVBsYWNlaG9sZGVyID0gZmFsc2U7XG5cbiAgQElucHV0KHsgdHJhbnNmb3JtOiBib29sZWFuQXR0cmlidXRlIH0pIHJlcXVpcmVkID0gZmFsc2U7XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpXG4gIGdldCBjbGFzc2VzKCk6IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+IHtcbiAgICByZXR1cm4ge1xuICAgICAgJ3Jkcy1jaGlwLWlucHV0JzogdHJ1ZSxcbiAgICAgICdyZHMtY2hpcC1pbnB1dC1uby1wbGFjZWhvbGRlcic6IHRoaXMuaGlkZVBsYWNlaG9sZGVyLFxuICAgIH07XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2F0dHIucmVxdWlyZWQnKVxuICBASG9zdEJpbmRpbmcoJ2F0dHIuYXJpYS1yZXF1aXJlZCcpXG4gIGdldCBhcmlhUmVxdWlyZWQoKTogYm9vbGVhbiB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLnJlcXVpcmVkIHx8IG51bGw7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2F0dHIuYXJpYS1pbnZhbGlkJylcbiAgZ2V0IGFyaWFJbnZhbGlkKCk6IGJvb2xlYW4gfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5uZ0NvbnRyb2wgPyB0aGlzLm5nQ29udHJvbC5pbnZhbGlkIDogbnVsbDtcbiAgfVxuXG4gIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lICovXG4gIEBJbnB1dCgncmRzQ2hpcElucHV0Q2hpcEdyaWQnKVxuICBzZXQgY2hpcEdyaWQodmFsdWU6IFJkc0NoaXBHcmlkQ29tcG9uZW50PFQ+KSB7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLl9jaGlwR3JpZCA9IHZhbHVlO1xuICAgICAgdGhpcy5fY2hpcEdyaWQucmVnaXN0ZXJJbnB1dCh0aGlzKTtcbiAgICB9IGVsc2UgaWYgKGlzRGV2TW9kZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdSZHNDaGlwSW5wdXREaXJlY3RpdmU6IHJkc0NoaXBJbnB1dENoaXBHcmlkIHJlY2VpdmVkIGZhbHN5IHZhbHVlJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWUgKi9cbiAgQElucHV0KHsgYWxpYXM6ICdyZHNDaGlwSW5wdXRBZGRPbkJsdXInLCB0cmFuc2Zvcm06IGJvb2xlYW5BdHRyaWJ1dGUgfSlcbiAgYWRkT25CbHVyID0gZmFsc2U7XG4gIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lICovXG4gIEBJbnB1dCh7IGFsaWFzOiAncmRzQ2hpcElucHV0U2VwYXJhdG9yS2V5cycsIHRyYW5zZm9ybTogY29lcmNlU3RyaW5nQXJyYXkgfSlcbiAgc2VwYXJhdG9yS2V5cyA9IGluamVjdChSRFNfQ0hJUFNfREVGQVVMVF9PUFRJT05TKS5zZXBhcmF0b3JLZXlzO1xuXG4gIEBIb3N0QmluZGluZygnYXR0ci5wbGFjZWhvbGRlcicpXG4gIEBJbnB1dCgpXG4gIHBsYWNlaG9sZGVyID0gJyc7XG5cbiAgQEhvc3RCaW5kaW5nKCdpZCcpXG4gIEBJbnB1dCgpXG4gIGlkID0gYHJkcy1jaGlwLWxpc3QtaW5wdXQtJHtuZXh0VW5pcXVlSWQrK31gO1xuXG4gIEBIb3N0QmluZGluZygnZGlzYWJsZWQnKVxuICBASW5wdXQoKVxuICBzZXQgZGlzYWJsZWQodmFsdWU6IEJvb2xlYW5JbnB1dCkge1xuICAgIHRoaXMuX2Rpc2FibGVkID0gYm9vbGVhbkF0dHJpYnV0ZSh2YWx1ZSk7XG4gIH1cblxuICBnZXQgZGlzYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2Rpc2FibGVkIHx8ICEhKHRoaXMuX2NoaXBHcmlkICYmIHRoaXMuX2NoaXBHcmlkLmRpc2FibGVkKTtcbiAgfVxuXG4gIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8tb3V0cHV0LXJlbmFtZSAqL1xuICBAT3V0cHV0KCdyZHNDaGlwSW5wdXRUb2tlbkVuZCcpXG4gIHJlYWRvbmx5IGNoaXBFbmQgPSBuZXcgRXZlbnRFbWl0dGVyPFJkc0NoaXBJbnB1dEV2ZW50PFQ+PigpO1xuXG4gIGdldCBlbXB0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMuaW5wdXRFbGVtZW50LnZhbHVlO1xuICB9XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgaWYgKHRoaXMuZm9ybUZpZWxkKSB7XG4gICAgICB0aGlzLmlucHV0RWxlbWVudC5jbGFzc0xpc3QuYWRkKCdyZHMtZm9ybS1maWVsZC1pbnB1dC1jb250cm9sJyk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkNoYW5nZXMoKTogdm9pZCB7XG4gICAgdGhpcy5fY2hpcEdyaWQ/LnN0YXRlQ2hhbmdlcz8ubmV4dCgpO1xuICB9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIHRoaXMuZm9jdXNMYXN0Q2hpcE9uQmFja3NwYWNlID0gdGhpcy5lbXB0eTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuY2hpcEVuZC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIHByaXZhdGUgb25LZXlkb3duKGV2ZW50PzogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xuICAgIGlmIChldmVudCkge1xuICAgICAgLy8gVG8gcHJldmVudCB0aGUgdXNlciBmcm9tIGFjY2lkZW50YWxseSBkZWxldGluZyBjaGlwcyB3aGVuIHByZXNzaW5nIEJBQ0tTUEFDRSBjb250aW51b3VzbHksXG4gICAgICAvLyBXZSBmb2N1cyB0aGUgbGFzdCBjaGlwIG9uIGJhY2tzcGFjZSBvbmx5IGFmdGVyIHRoZSB1c2VyIGhhcyByZWxlYXNlZCB0aGUgYmFja3NwYWNlIGJ1dHRvbixcbiAgICAgIC8vIEFuZCB0aGUgaW5wdXQgaXMgZW1wdHkgKHNlZSBiZWhhdmlvdXIgaW4gX2tleXVwKVxuICAgICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IEJBQ0tTUEFDRSAmJiB0aGlzLmZvY3VzTGFzdENoaXBPbkJhY2tzcGFjZSkge1xuICAgICAgICB0aGlzLl9jaGlwR3JpZD8uZm9jdXNMYXN0Q2hpcCgpO1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZm9jdXNMYXN0Q2hpcE9uQmFja3NwYWNlID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5lbWl0Q2hpcEVuZChldmVudCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdrZXl1cCcsIFsnJGV2ZW50J10pXG4gIG9uS2V5dXAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpOiB2b2lkIHtcbiAgICAvLyBBbGxvdyB1c2VyIHRvIG1vdmUgZm9jdXMgdG8gY2hpcHMgbmV4dCB0aW1lIGhlIHByZXNzZXMgYmFja3NwYWNlXG4gICAgaWYgKFxuICAgICAgIXRoaXMuZm9jdXNMYXN0Q2hpcE9uQmFja3NwYWNlICYmXG4gICAgICBldmVudC5rZXlDb2RlID09PSBCQUNLU1BBQ0UgJiZcbiAgICAgIHRoaXMuZW1wdHlcbiAgICApIHtcbiAgICAgIHRoaXMuZm9jdXNMYXN0Q2hpcE9uQmFja3NwYWNlID0gdHJ1ZTtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignYmx1cicsIFsnJGV2ZW50J10pXG4gIG9uQmx1cigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5hZGRPbkJsdXIpIHtcbiAgICAgIHRoaXMuZW1pdENoaXBFbmQoKTtcbiAgICB9XG5cbiAgICB0aGlzLmZvY3VzZWQgPSBmYWxzZTtcblxuICAgIC8vIEJsdXIgdGhlIGNoaXAgbGlzdCBpZiBpdCBpcyBub3QgZm9jdXNlZFxuICAgIGlmICghdGhpcy5fY2hpcEdyaWQ/LmZvY3VzZWQpIHtcbiAgICAgIHRoaXMuX2NoaXBHcmlkPy5ibHVyKCk7XG4gICAgfVxuXG4gICAgdGhpcy5fY2hpcEdyaWQ/LnN0YXRlQ2hhbmdlcy5uZXh0KCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdmb2N1cycsIFsnJGV2ZW50J10pXG4gIG9uRm9jdXMoKTogdm9pZCB7XG4gICAgdGhpcy5mb2N1c2VkID0gdHJ1ZTtcbiAgICB0aGlzLmZvY3VzTGFzdENoaXBPbkJhY2tzcGFjZSA9IHRoaXMuZW1wdHk7XG4gICAgdGhpcy5fY2hpcEdyaWQ/LnN0YXRlQ2hhbmdlcy5uZXh0KCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdpbnB1dCcpXG4gIG9uSW5wdXQoKTogdm9pZCB7XG4gICAgLy8gTGV0IGNoaXAgbGlzdCBrbm93IHdoZW5ldmVyIHRoZSB2YWx1ZSBjaGFuZ2VzLlxuICAgIHRoaXMuX2NoaXBHcmlkPy5zdGF0ZUNoYW5nZXMubmV4dCgpO1xuICB9XG5cbiAgZW1pdENoaXBFbmQoZXZlbnQ/OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgaWYgKCFldmVudCB8fCB0aGlzLmlzU2VwYXJhdG9yS2V5KGV2ZW50KSkge1xuICAgICAgdGhpcy5jaGlwRW5kLmVtaXQoe1xuICAgICAgICBpbnB1dDogdGhpcy5pbnB1dEVsZW1lbnQsXG4gICAgICAgIHZhbHVlOiB0aGlzLmlucHV0RWxlbWVudC52YWx1ZSxcbiAgICAgICAgY2hpcElucHV0OiB0aGlzLFxuICAgICAgfSk7XG5cbiAgICAgIGV2ZW50Py5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzKCk6IHZvaWQge1xuICAgIHRoaXMuaW5wdXRFbGVtZW50LmZvY3VzKCk7XG4gIH1cblxuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLmlucHV0RWxlbWVudC52YWx1ZSA9ICcnO1xuICAgIHRoaXMuZm9jdXNMYXN0Q2hpcE9uQmFja3NwYWNlID0gdHJ1ZTtcbiAgfVxuXG4gIHNldERlc2NyaWJlZEJ5SWRzKGlkczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAvLyBTZXQgdGhlIHZhbHVlIGRpcmVjdGx5IGluIHRoZSBET00gc2luY2UgdGhpcyBiaW5kaW5nXG4gICAgLy8gaXMgcHJvbmUgdG8gXCJjaGFuZ2VkIGFmdGVyIGNoZWNrZWRcIiBlcnJvcnMuXG4gICAgaWYgKGlkcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuaW5wdXRFbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1kZXNjcmliZWRieScsIGlkcy5qb2luKCcgJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmlucHV0RWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2FyaWEtZGVzY3JpYmVkYnknKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzU2VwYXJhdG9yS2V5KGV2ZW50OiBLZXlib2FyZEV2ZW50KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICFoYXNNb2RpZmllcktleShldmVudCkgJiYgdGhpcy5zZXBhcmF0b3JLZXlzLmluY2x1ZGVzKGV2ZW50LmtleSk7XG4gIH1cbn1cbiJdfQ==