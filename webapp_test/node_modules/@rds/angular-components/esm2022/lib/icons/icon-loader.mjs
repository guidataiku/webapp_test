import { inject, Injectable, SecurityContext } from '@angular/core';
import { of } from 'rxjs';
import { HttpClient } from '@angular/common/http';
import { DomSanitizer } from '@angular/platform-browser';
import { DOCUMENT } from '@angular/common';
import { finalize, map, share, tap } from 'rxjs/operators';
import { IconLoaderErrors } from './icon-loader-errors';
import { RDS_ICON_LOADER_CONFIG, } from './icon-types';
import { RDS_VERSION_AS_FILENAME_SUFFIX } from '../core';
import * as i0 from "@angular/core";
// in case of change remember to modify create-svg-symbols.js accordingly
const getAllIconsFilename = (namespace) => `_all-${namespace}`;
class IconConfig {
    constructor(data) {
        this.url = '';
        if (isSVGElement(data)) {
            this.svgElement = data;
        }
        else {
            this.url = data;
        }
    }
}
function isSVGElement(data) {
    return typeof data !== 'string' && 'nodeName' in data;
}
export function getSvgHref(namespace, name) {
    return `/assets/icons/${namespace}/${name}${RDS_VERSION_AS_FILENAME_SUFFIX}.svg#${name}`;
}
/**
 * Service to load icons used by the `<rds-icon>` component.
 * Icons are get from, assets/icons/{namespace}/{iconName}
 */
export class RdsIconLoader {
    // Keys are of in the format namespace:icon
    static { this.BASE_URL = '/'; }
    static { this.BASE_URL_FETCHED = false; }
    static _getBaseUrl() {
        if (!RdsIconLoader.BASE_URL_FETCHED) {
            const baseTag = document.getElementsByTagName('base')[0];
            if (!baseTag || !baseTag.href || baseTag.href === '') {
                RdsIconLoader.BASE_URL = '/';
            }
            else {
                RdsIconLoader.BASE_URL = baseTag.href;
            }
            RdsIconLoader.BASE_URL_FETCHED = true;
        }
        return RdsIconLoader.BASE_URL;
    }
    constructor() {
        this.config = inject(RDS_ICON_LOADER_CONFIG, { optional: true });
        this.httpClient = inject(HttpClient, { optional: true });
        this.document = inject(DOCUMENT, { optional: true });
        this.domSanitizer = inject(DomSanitizer);
        this.iconConfigsCache = new Map();
        this.iconFetchesInProgress = new Map();
        this.allIcons = {};
        this.preloadAll = false;
        this.handleConfig(this.config);
    }
    preloadSelectedIcons(selectedIcons) {
        Object.entries(selectedIcons).forEach(([namespace, icons]) => {
            for (const iconName of icons) {
                this.getSvgIcon(iconName, namespace).subscribe();
            }
        });
    }
    /**
     * Returns an Observable with the icon (as an `<svg>` SVGelement) for the given name
     * and namespace.
     * @param name Name of the icon to be retrieved.
     * @param namespace Namespace in which to look for the icon.
     */
    getSvgIcon(name, namespace) {
        if (this.preloadAll) {
            return this.getFromAllIconsFile(name, namespace);
        }
        const iconConfig = this.getOrCreateIconConfig(name, namespace);
        return this._getSvgElementFromIconConfig(iconConfig);
    }
    ngOnDestroy() {
        this.iconConfigsCache.clear();
    }
    getFromAllIconsFile(name, namespace) {
        if (this.allIcons[namespace]) {
            return of(this.buildFromSymbol(name, namespace));
        }
        const iconConfig = this.getOrCreateIconConfig(name, namespace);
        return this._fetchIcon(iconConfig).pipe(tap((svgText) => {
            this.allIcons[namespace] = this._convertSVGStringToSvgElement(svgText);
        }), map(() => this.buildFromSymbol(name, namespace)));
    }
    getOrCreateIconConfig(name, namespace) {
        const keyName = this.preloadAll ? getAllIconsFilename(namespace) : name;
        const key = iconKey(namespace, keyName);
        return (this.iconConfigsCache.get(key) ||
            this._addIconConfigToCache(namespace, name));
    }
    _addIconConfigToCache(namespace, iconName) {
        if (!namespace || !iconName) {
            throw IconLoaderErrors.invalidNamespaceOrIconNameError(namespace, iconName);
        }
        const url = this._buildIconUrl(namespace, iconName);
        const iconConfig = new IconConfig(url);
        this.iconConfigsCache.set(iconKey(namespace, iconName), iconConfig);
        return iconConfig;
    }
    _buildIconUrl(namespace, iconName) {
        if (this.preloadAll) {
            iconName = getAllIconsFilename(namespace);
        }
        const safeResourceUrl = this.domSanitizer.bypassSecurityTrustResourceUrl(RdsIconLoader._getBaseUrl() +
            `assets/icons/${namespace}/${iconName}${RDS_VERSION_AS_FILENAME_SUFFIX}.svg`);
        const url = this.domSanitizer.sanitize(SecurityContext.RESOURCE_URL, safeResourceUrl);
        if (!url) {
            throw IconLoaderErrors.iconUrlFailedToSanitize(safeResourceUrl);
        }
        return url;
    }
    _getSvgElementFromIconConfig(iconConfig) {
        const svgElement = iconConfig.svgElement;
        if (svgElement) {
            // We already have the SVG element for this icon, return a copy.
            return of(cloneSvg(svgElement));
        }
        else {
            // Fetch the icon from the iconConfig's URL, cache it, and return a copy.
            return this._fetchIcon(iconConfig).pipe(map((svgText) => this._buildSvgElement(svgText)), tap((builtSvgElement) => (iconConfig.svgElement = builtSvgElement)), map((builtSvgElement) => cloneSvg(builtSvgElement)));
        }
    }
    _fetchIcon(iconConfig) {
        const { url } = iconConfig;
        if (!this.httpClient) {
            throw IconLoaderErrors.noHttpProviderError();
        }
        const inProgressFetch = this.iconFetchesInProgress.get(url);
        if (inProgressFetch) {
            return inProgressFetch;
        }
        const req = this.httpClient.get(url, { responseType: 'text' }).pipe(finalize(() => this.iconFetchesInProgress.delete(url)), share());
        this.iconFetchesInProgress.set(url, req);
        return req;
    }
    _buildSvgElement(responseText) {
        const svgElement = this._convertSVGStringToSvgElement(responseText);
        this._setDefaultSvgAttributes(svgElement);
        return svgElement;
    }
    buildFromSymbol(name, namespace) {
        const symbol = this.allIcons[namespace]?.querySelector(`#${name}`);
        const svgString = symbol
            ? `<svg ${symbol.outerHTML.slice(7, -9)}</svg>`
            : '<svg></svg>';
        return this._convertSVGStringToSvgElement(svgString);
    }
    _convertSVGStringToSvgElement(svgString) {
        const div = this.document.createElement('DIV');
        div.innerHTML = svgString;
        const svg = div.querySelector('svg');
        if (svg) {
            return svg;
        }
        throw IconLoaderErrors.svgTagNotFound();
    }
    _setDefaultSvgAttributes(svg) {
        svg.setAttribute('fit', '');
        svg.setAttribute('height', '100%');
        svg.setAttribute('width', '100%');
        svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
        svg.setAttribute('focusable', 'false'); // Disable IE11 default behavior to make SVGs focusable.
        svg.setAttribute('viewBox', '0 0 24 24');
        return svg;
    }
    handleConfig(config) {
        if (config?.preloadSelected) {
            config.preloadSelected === 'all'
                ? (this.preloadAll = true)
                : this.preloadSelectedIcons(config.preloadSelected);
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsIconLoader, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsIconLoader, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsIconLoader, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: () => [] });
function cloneSvg(svg) {
    return svg.cloneNode(true);
}
function iconKey(namespace, name) {
    return namespace + ':' + name;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbi1sb2FkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItY29tcG9uZW50cy9zcmMvbGliL2ljb25zL2ljb24tbG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFhLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvRSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDekQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQ0wsc0JBQXNCLEdBSXZCLE1BQU0sY0FBYyxDQUFDO0FBQ3RCLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLFNBQVMsQ0FBQzs7QUFFekQseUVBQXlFO0FBQ3pFLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxTQUEyQixFQUFlLEVBQUUsQ0FDdkUsUUFBUSxTQUFTLEVBQWlCLENBQUM7QUFFckMsTUFBTSxVQUFVO0lBSWQsWUFBWSxJQUF5QjtRQUhyQyxRQUFHLEdBQUcsRUFBRSxDQUFDO1FBSVAsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUN2QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN6QixDQUFDO2FBQU0sQ0FBQztZQUNOLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFF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QUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDbkMsR0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDbEMsR0FBRyxDQUFDLFlBQVksQ0FBQyxxQkFBcUIsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUN6RCxHQUFHLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLHdEQUF3RDtRQUNoRyxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUV6QyxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFTyxZQUFZLENBQUMsTUFBa0M7UUFDckQsSUFBSSxNQUFNLEVBQUUsZUFBZSxFQUFFLENBQUM7WUFDNUIsTUFBTSxDQUFDLGVBQWUsS0FBSyxLQUFLO2dCQUM5QixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztnQkFDMUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDeEQsQ0FBQztJQUNILENBQUM7OEdBMU9VLGFBQWE7a0hBQWIsYUFBYSxjQURBLE1BQU07OzJGQUNuQixhQUFhO2tCQUR6QixVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7QUE4T2xDLFNBQVMsUUFBUSxDQUFDLEdBQWU7SUFDL0IsT0FBTyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBZSxDQUFDO0FBQzNDLENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBQyxTQUEyQixFQUFFLElBQWlCO0lBQzdELE9BQU8sU0FBUyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUM7QUFDaEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluamVjdCwgSW5qZWN0YWJsZSwgT25EZXN0cm95LCBTZWN1cml0eUNvbnRleHQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgRG9tU2FuaXRpemVyIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBmaW5hbGl6ZSwgbWFwLCBzaGFyZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSWNvbkxvYWRlckVycm9ycyB9IGZyb20gJy4vaWNvbi1sb2FkZXItZXJyb3JzJztcbmltcG9ydCB7XG4gIFJEU19JQ09OX0xPQURFUl9DT05GSUcsXG4gIFJkc0ljb25Mb2FkZXJDb25maWcsXG4gIFJkc0ljb25OYW1lLFxuICBSZHNJY29uTmFtZXNwYWNlLFxufSBmcm9tICcuL2ljb24tdHlwZXMnO1xuaW1wb3J0IHsgUkRTX1ZFUlNJT05fQVNfRklMRU5BTUVfU1VGRklYIH0gZnJvbSAnLi4vY29yZSc7XG5cbi8vIGluIGNhc2Ugb2YgY2hhbmdlIHJlbWVtYmVyIHRvIG1vZGlmeSBjcmVhdGUtc3ZnLXN5bWJvbHMuanMgYWNjb3JkaW5nbHlcbmNvbnN0IGdldEFsbEljb25zRmlsZW5hbWUgPSAobmFtZXNwYWNlOiBSZHNJY29uTmFtZXNwYWNlKTogUmRzSWNvbk5hbWUgPT5cbiAgYF9hbGwtJHtuYW1lc3BhY2V9YCBhcyBSZHNJY29uTmFtZTtcblxuY2xhc3MgSWNvbkNvbmZpZyB7XG4gIHVybCA9ICcnO1xuICBzdmdFbGVtZW50OiBTVkdFbGVtZW50O1xuXG4gIGNvbnN0cnVjdG9yKGRhdGE6IHN0cmluZyB8IFNWR0VsZW1lbnQpIHtcbiAgICBpZiAoaXNTVkdFbGVtZW50KGRhdGEpKSB7XG4gICAgICB0aGlzLnN2Z0VsZW1lbnQgPSBkYXRhO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnVybCA9IGRhdGE7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGlzU1ZHRWxlbWVudChkYXRhOiBzdHJpbmcgfCBTVkdFbGVtZW50KTogZGF0YSBpcyBTVkdFbGVtZW50IHtcbiAgcmV0dXJuIHR5cGVvZiBkYXRhICE9PSAnc3RyaW5nJyAmJiAnbm9kZU5hbWUnIGluIGRhdGE7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTdmdIcmVmKFxuICBuYW1lc3BhY2U6IFJkc0ljb25OYW1lc3BhY2UsXG4gIG5hbWU6IFJkc0ljb25OYW1lLFxuKTogc3RyaW5nIHtcbiAgcmV0dXJuIGAvYXNzZXRzL2ljb25zLyR7bmFtZXNwYWNlfS8ke25hbWV9JHtSRFNfVkVSU0lPTl9BU19GSUxFTkFNRV9TVUZGSVh9LnN2ZyMke25hbWV9YDtcbn1cblxuLyoqXG4gKiBTZXJ2aWNlIHRvIGxvYWQgaWNvbnMgdXNlZCBieSB0aGUgYDxyZHMtaWNvbj5gIGNvbXBvbmVudC5cbiAqIEljb25zIGFyZSBnZXQgZnJvbSwgYXNzZXRzL2ljb25zL3tuYW1lc3BhY2V9L3tpY29uTmFtZX1cbiAqL1xuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBSZHNJY29uTG9hZGVyIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSByZWFkb25seSBjb25maWcgPSBpbmplY3QoUkRTX0lDT05fTE9BREVSX0NPTkZJRywgeyBvcHRpb25hbDogdHJ1ZSB9KTtcbiAgcHJpdmF0ZSByZWFkb25seSBodHRwQ2xpZW50ID0gaW5qZWN0KEh0dHBDbGllbnQsIHsgb3B0aW9uYWw6IHRydWUgfSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnQgPSBpbmplY3QoRE9DVU1FTlQsIHsgb3B0aW9uYWw6IHRydWUgfSkgYXMgRG9jdW1lbnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgZG9tU2FuaXRpemVyID0gaW5qZWN0KERvbVNhbml0aXplcik7XG5cbiAgLy8gS2V5cyBhcmUgb2YgaW4gdGhlIGZvcm1hdCBuYW1lc3BhY2U6aWNvblxuICBwcml2YXRlIHN0YXRpYyBCQVNFX1VSTCA9ICcvJztcbiAgcHJpdmF0ZSBzdGF0aWMgQkFTRV9VUkxfRkVUQ0hFRCA9IGZhbHNlO1xuICBwcml2YXRlIHJlYWRvbmx5IGljb25Db25maWdzQ2FjaGUgPSBuZXcgTWFwPHN0cmluZywgSWNvbkNvbmZpZz4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBpY29uRmV0Y2hlc0luUHJvZ3Jlc3MgPSBuZXcgTWFwPFxuICAgIHN0cmluZyxcbiAgICBPYnNlcnZhYmxlPHN0cmluZz5cbiAgPigpO1xuICBwcml2YXRlIGFsbEljb25zOiB7IGZpbGxlZD86IFNWR0VsZW1lbnQ7IG91dGxpbmVkPzogU1ZHRWxlbWVudCB9ID0ge307XG4gIHByaXZhdGUgcHJlbG9hZEFsbCA9IGZhbHNlO1xuXG4gIHByaXZhdGUgc3RhdGljIF9nZXRCYXNlVXJsKCk6IHN0cmluZyB7XG4gICAgaWYgKCFSZHNJY29uTG9hZGVyLkJBU0VfVVJMX0ZFVENIRUQpIHtcbiAgICAgIGNvbnN0IGJhc2VUYWcgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYmFzZScpWzBdO1xuXG4gICAgICBpZiAoIWJhc2VUYWcgfHwgIWJhc2VUYWcuaHJlZiB8fCBiYXNlVGFnLmhyZWYgPT09ICcnKSB7XG4gICAgICAgIFJkc0ljb25Mb2FkZXIuQkFTRV9VUkwgPSAnLyc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBSZHNJY29uTG9hZGVyLkJBU0VfVVJMID0gYmFzZVRhZy5ocmVmO1xuICAgICAgfVxuXG4gICAgICBSZHNJY29uTG9hZGVyLkJBU0VfVVJMX0ZFVENIRUQgPSB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBSZHNJY29uTG9hZGVyLkJBU0VfVVJMO1xuICB9XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5oYW5kbGVDb25maWcodGhpcy5jb25maWcpO1xuICB9XG5cbiAgcHJlbG9hZFNlbGVjdGVkSWNvbnMoXG4gICAgc2VsZWN0ZWRJY29uczogUmVjb3JkPFJkc0ljb25OYW1lc3BhY2UsIFJkc0ljb25OYW1lW10+LFxuICApOiB2b2lkIHtcbiAgICBPYmplY3QuZW50cmllcyhzZWxlY3RlZEljb25zKS5mb3JFYWNoKChbbmFtZXNwYWNlLCBpY29uc10pID0+IHtcbiAgICAgIGZvciAoY29uc3QgaWNvbk5hbWUgb2YgaWNvbnMpIHtcbiAgICAgICAgdGhpcy5nZXRTdmdJY29uKGljb25OYW1lLCBuYW1lc3BhY2UgYXMgUmRzSWNvbk5hbWVzcGFjZSkuc3Vic2NyaWJlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBPYnNlcnZhYmxlIHdpdGggdGhlIGljb24gKGFzIGFuIGA8c3ZnPmAgU1ZHZWxlbWVudCkgZm9yIHRoZSBnaXZlbiBuYW1lXG4gICAqIGFuZCBuYW1lc3BhY2UuXG4gICAqIEBwYXJhbSBuYW1lIE5hbWUgb2YgdGhlIGljb24gdG8gYmUgcmV0cmlldmVkLlxuICAgKiBAcGFyYW0gbmFtZXNwYWNlIE5hbWVzcGFjZSBpbiB3aGljaCB0byBsb29rIGZvciB0aGUgaWNvbi5cbiAgICovXG4gIGdldFN2Z0ljb24oXG4gICAgbmFtZTogUmRzSWNvbk5hbWUsXG4gICAgbmFtZXNwYWNlOiBSZHNJY29uTmFtZXNwYWNlLFxuICApOiBPYnNlcnZhYmxlPFNWR0VsZW1lbnQ+IHtcbiAgICBpZiAodGhpcy5wcmVsb2FkQWxsKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRGcm9tQWxsSWNvbnNGaWxlKG5hbWUsIG5hbWVzcGFjZSk7XG4gICAgfVxuXG4gICAgY29uc3QgaWNvbkNvbmZpZyA9IHRoaXMuZ2V0T3JDcmVhdGVJY29uQ29uZmlnKG5hbWUsIG5hbWVzcGFjZSk7XG5cbiAgICByZXR1cm4gdGhpcy5fZ2V0U3ZnRWxlbWVudEZyb21JY29uQ29uZmlnKGljb25Db25maWcpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5pY29uQ29uZmlnc0NhY2hlLmNsZWFyKCk7XG4gIH1cblxuICBwcml2YXRlIGdldEZyb21BbGxJY29uc0ZpbGUoXG4gICAgbmFtZTogUmRzSWNvbk5hbWUsXG4gICAgbmFtZXNwYWNlOiBSZHNJY29uTmFtZXNwYWNlLFxuICApOiBPYnNlcnZhYmxlPFNWR0VsZW1lbnQ+IHtcbiAgICBpZiAodGhpcy5hbGxJY29uc1tuYW1lc3BhY2VdKSB7XG4gICAgICByZXR1cm4gb2YodGhpcy5idWlsZEZyb21TeW1ib2wobmFtZSwgbmFtZXNwYWNlKSk7XG4gICAgfVxuXG4gICAgY29uc3QgaWNvbkNvbmZpZyA9IHRoaXMuZ2V0T3JDcmVhdGVJY29uQ29uZmlnKG5hbWUsIG5hbWVzcGFjZSk7XG5cbiAgICByZXR1cm4gdGhpcy5fZmV0Y2hJY29uKGljb25Db25maWcpLnBpcGUoXG4gICAgICB0YXAoKHN2Z1RleHQpID0+IHtcbiAgICAgICAgdGhpcy5hbGxJY29uc1tuYW1lc3BhY2VdID0gdGhpcy5fY29udmVydFNWR1N0cmluZ1RvU3ZnRWxlbWVudChzdmdUZXh0KTtcbiAgICAgIH0pLFxuICAgICAgbWFwKCgpID0+IHRoaXMuYnVpbGRGcm9tU3ltYm9sKG5hbWUsIG5hbWVzcGFjZSkpLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldE9yQ3JlYXRlSWNvbkNvbmZpZyhcbiAgICBuYW1lOiBSZHNJY29uTmFtZSxcbiAgICBuYW1lc3BhY2U6IFJkc0ljb25OYW1lc3BhY2UsXG4gICk6IEljb25Db25maWcge1xuICAgIGNvbnN0IGtleU5hbWUgPSB0aGlzLnByZWxvYWRBbGwgPyBnZXRBbGxJY29uc0ZpbGVuYW1lKG5hbWVzcGFjZSkgOiBuYW1lO1xuICAgIGNvbnN0IGtleSA9IGljb25LZXkobmFtZXNwYWNlLCBrZXlOYW1lKTtcblxuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmljb25Db25maWdzQ2FjaGUuZ2V0KGtleSkgfHxcbiAgICAgIHRoaXMuX2FkZEljb25Db25maWdUb0NhY2hlKG5hbWVzcGFjZSwgbmFtZSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBfYWRkSWNvbkNvbmZpZ1RvQ2FjaGUoXG4gICAgbmFtZXNwYWNlOiBSZHNJY29uTmFtZXNwYWNlLFxuICAgIGljb25OYW1lOiBSZHNJY29uTmFtZSxcbiAgKTogSWNvbkNvbmZpZyB7XG4gICAgaWYgKCFuYW1lc3BhY2UgfHwgIWljb25OYW1lKSB7XG4gICAgICB0aHJvdyBJY29uTG9hZGVyRXJyb3JzLmludmFsaWROYW1lc3BhY2VPckljb25OYW1lRXJyb3IoXG4gICAgICAgIG5hbWVzcGFjZSxcbiAgICAgICAgaWNvbk5hbWUsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHVybCA9IHRoaXMuX2J1aWxkSWNvblVybChuYW1lc3BhY2UsIGljb25OYW1lKTtcbiAgICBjb25zdCBpY29uQ29uZmlnID0gbmV3IEljb25Db25maWcodXJsKTtcblxuICAgIHRoaXMuaWNvbkNvbmZpZ3NDYWNoZS5zZXQoaWNvbktleShuYW1lc3BhY2UsIGljb25OYW1lKSwgaWNvbkNvbmZpZyk7XG5cbiAgICByZXR1cm4gaWNvbkNvbmZpZztcbiAgfVxuXG4gIHByaXZhdGUgX2J1aWxkSWNvblVybChcbiAgICBuYW1lc3BhY2U6IFJkc0ljb25OYW1lc3BhY2UsXG4gICAgaWNvbk5hbWU6IFJkc0ljb25OYW1lLFxuICApOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLnByZWxvYWRBbGwpIHtcbiAgICAgIGljb25OYW1lID0gZ2V0QWxsSWNvbnNGaWxlbmFtZShuYW1lc3BhY2UpO1xuICAgIH1cblxuICAgIGNvbnN0IHNhZmVSZXNvdXJjZVVybCA9IHRoaXMuZG9tU2FuaXRpemVyLmJ5cGFzc1NlY3VyaXR5VHJ1c3RSZXNvdXJjZVVybChcbiAgICAgIFJkc0ljb25Mb2FkZXIuX2dldEJhc2VVcmwoKSArXG4gICAgICAgIGBhc3NldHMvaWNvbnMvJHtuYW1lc3BhY2V9LyR7aWNvbk5hbWV9JHtSRFNfVkVSU0lPTl9BU19GSUxFTkFNRV9TVUZGSVh9LnN2Z2AsXG4gICAgKTtcblxuICAgIGNvbnN0IHVybCA9IHRoaXMuZG9tU2FuaXRpemVyLnNhbml0aXplKFxuICAgICAgU2VjdXJpdHlDb250ZXh0LlJFU09VUkNFX1VSTCxcbiAgICAgIHNhZmVSZXNvdXJjZVVybCxcbiAgICApO1xuXG4gICAgaWYgKCF1cmwpIHtcbiAgICAgIHRocm93IEljb25Mb2FkZXJFcnJvcnMuaWNvblVybEZhaWxlZFRvU2FuaXRpemUoc2FmZVJlc291cmNlVXJsKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdXJsO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0U3ZnRWxlbWVudEZyb21JY29uQ29uZmlnKFxuICAgIGljb25Db25maWc6IEljb25Db25maWcsXG4gICk6IE9ic2VydmFibGU8U1ZHRWxlbWVudD4ge1xuICAgIGNvbnN0IHN2Z0VsZW1lbnQgPSBpY29uQ29uZmlnLnN2Z0VsZW1lbnQ7XG5cbiAgICBpZiAoc3ZnRWxlbWVudCkge1xuICAgICAgLy8gV2UgYWxyZWFkeSBoYXZlIHRoZSBTVkcgZWxlbWVudCBmb3IgdGhpcyBpY29uLCByZXR1cm4gYSBjb3B5LlxuICAgICAgcmV0dXJuIG9mKGNsb25lU3ZnKHN2Z0VsZW1lbnQpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRmV0Y2ggdGhlIGljb24gZnJvbSB0aGUgaWNvbkNvbmZpZydzIFVSTCwgY2FjaGUgaXQsIGFuZCByZXR1cm4gYSBjb3B5LlxuICAgICAgcmV0dXJuIHRoaXMuX2ZldGNoSWNvbihpY29uQ29uZmlnKS5waXBlKFxuICAgICAgICBtYXAoKHN2Z1RleHQpID0+IHRoaXMuX2J1aWxkU3ZnRWxlbWVudChzdmdUZXh0KSksXG4gICAgICAgIHRhcCgoYnVpbHRTdmdFbGVtZW50KSA9PiAoaWNvbkNvbmZpZy5zdmdFbGVtZW50ID0gYnVpbHRTdmdFbGVtZW50KSksXG4gICAgICAgIG1hcCgoYnVpbHRTdmdFbGVtZW50KSA9PiBjbG9uZVN2ZyhidWlsdFN2Z0VsZW1lbnQpKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZmV0Y2hJY29uKGljb25Db25maWc6IEljb25Db25maWcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGNvbnN0IHsgdXJsIH0gPSBpY29uQ29uZmlnO1xuXG4gICAgaWYgKCF0aGlzLmh0dHBDbGllbnQpIHtcbiAgICAgIHRocm93IEljb25Mb2FkZXJFcnJvcnMubm9IdHRwUHJvdmlkZXJFcnJvcigpO1xuICAgIH1cblxuICAgIGNvbnN0IGluUHJvZ3Jlc3NGZXRjaCA9IHRoaXMuaWNvbkZldGNoZXNJblByb2dyZXNzLmdldCh1cmwpO1xuXG4gICAgaWYgKGluUHJvZ3Jlc3NGZXRjaCkge1xuICAgICAgcmV0dXJuIGluUHJvZ3Jlc3NGZXRjaDtcbiAgICB9XG5cbiAgICBjb25zdCByZXEgPSB0aGlzLmh0dHBDbGllbnQuZ2V0KHVybCwgeyByZXNwb25zZVR5cGU6ICd0ZXh0JyB9KS5waXBlKFxuICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5pY29uRmV0Y2hlc0luUHJvZ3Jlc3MuZGVsZXRlKHVybCkpLFxuICAgICAgc2hhcmUoKSxcbiAgICApO1xuXG4gICAgdGhpcy5pY29uRmV0Y2hlc0luUHJvZ3Jlc3Muc2V0KHVybCwgcmVxKTtcblxuICAgIHJldHVybiByZXE7XG4gIH1cblxuICBwcml2YXRlIF9idWlsZFN2Z0VsZW1lbnQocmVzcG9uc2VUZXh0OiBzdHJpbmcpOiBTVkdFbGVtZW50IHtcbiAgICBjb25zdCBzdmdFbGVtZW50ID0gdGhpcy5fY29udmVydFNWR1N0cmluZ1RvU3ZnRWxlbWVudChyZXNwb25zZVRleHQpO1xuICAgIHRoaXMuX3NldERlZmF1bHRTdmdBdHRyaWJ1dGVzKHN2Z0VsZW1lbnQpO1xuXG4gICAgcmV0dXJuIHN2Z0VsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRnJvbVN5bWJvbChcbiAgICBuYW1lOiBSZHNJY29uTmFtZSxcbiAgICBuYW1lc3BhY2U6IFJkc0ljb25OYW1lc3BhY2UsXG4gICk6IFNWR0VsZW1lbnQge1xuICAgIGNvbnN0IHN5bWJvbCA9IHRoaXMuYWxsSWNvbnNbbmFtZXNwYWNlXT8ucXVlcnlTZWxlY3RvcihgIyR7bmFtZX1gKTtcbiAgICBjb25zdCBzdmdTdHJpbmcgPSBzeW1ib2xcbiAgICAgID8gYDxzdmcgJHtzeW1ib2wub3V0ZXJIVE1MLnNsaWNlKDcsIC05KX08L3N2Zz5gXG4gICAgICA6ICc8c3ZnPjwvc3ZnPic7XG5cbiAgICByZXR1cm4gdGhpcy5fY29udmVydFNWR1N0cmluZ1RvU3ZnRWxlbWVudChzdmdTdHJpbmcpO1xuICB9XG5cbiAgcHJpdmF0ZSBfY29udmVydFNWR1N0cmluZ1RvU3ZnRWxlbWVudChzdmdTdHJpbmc6IHN0cmluZyk6IFNWR0VsZW1lbnQge1xuICAgIGNvbnN0IGRpdiA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnRElWJyk7XG4gICAgZGl2LmlubmVySFRNTCA9IHN2Z1N0cmluZztcbiAgICBjb25zdCBzdmcgPSBkaXYucXVlcnlTZWxlY3Rvcignc3ZnJykgYXMgU1ZHRWxlbWVudDtcblxuICAgIGlmIChzdmcpIHtcbiAgICAgIHJldHVybiBzdmc7XG4gICAgfVxuXG4gICAgdGhyb3cgSWNvbkxvYWRlckVycm9ycy5zdmdUYWdOb3RGb3VuZCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0RGVmYXVsdFN2Z0F0dHJpYnV0ZXMoc3ZnOiBTVkdFbGVtZW50KTogU1ZHRWxlbWVudCB7XG4gICAgc3ZnLnNldEF0dHJpYnV0ZSgnZml0JywgJycpO1xuICAgIHN2Zy5zZXRBdHRyaWJ1dGUoJ2hlaWdodCcsICcxMDAlJyk7XG4gICAgc3ZnLnNldEF0dHJpYnV0ZSgnd2lkdGgnLCAnMTAwJScpO1xuICAgIHN2Zy5zZXRBdHRyaWJ1dGUoJ3ByZXNlcnZlQXNwZWN0UmF0aW8nLCAneE1pZFlNaWQgbWVldCcpO1xuICAgIHN2Zy5zZXRBdHRyaWJ1dGUoJ2ZvY3VzYWJsZScsICdmYWxzZScpOyAvLyBEaXNhYmxlIElFMTEgZGVmYXVsdCBiZWhhdmlvciB0byBtYWtlIFNWR3MgZm9jdXNhYmxlLlxuICAgIHN2Zy5zZXRBdHRyaWJ1dGUoJ3ZpZXdCb3gnLCAnMCAwIDI0IDI0Jyk7XG5cbiAgICByZXR1cm4gc3ZnO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVDb25maWcoY29uZmlnOiBSZHNJY29uTG9hZGVyQ29uZmlnIHwgbnVsbCk6IHZvaWQge1xuICAgIGlmIChjb25maWc/LnByZWxvYWRTZWxlY3RlZCkge1xuICAgICAgY29uZmlnLnByZWxvYWRTZWxlY3RlZCA9PT0gJ2FsbCdcbiAgICAgICAgPyAodGhpcy5wcmVsb2FkQWxsID0gdHJ1ZSlcbiAgICAgICAgOiB0aGlzLnByZWxvYWRTZWxlY3RlZEljb25zKGNvbmZpZy5wcmVsb2FkU2VsZWN0ZWQpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBjbG9uZVN2Zyhzdmc6IFNWR0VsZW1lbnQpOiBTVkdFbGVtZW50IHtcbiAgcmV0dXJuIHN2Zy5jbG9uZU5vZGUodHJ1ZSkgYXMgU1ZHRWxlbWVudDtcbn1cblxuZnVuY3Rpb24gaWNvbktleShuYW1lc3BhY2U6IFJkc0ljb25OYW1lc3BhY2UsIG5hbWU6IFJkc0ljb25OYW1lKTogc3RyaW5nIHtcbiAgcmV0dXJuIG5hbWVzcGFjZSArICc6JyArIG5hbWU7XG59XG4iXX0=