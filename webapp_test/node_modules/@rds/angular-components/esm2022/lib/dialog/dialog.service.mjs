import { inject, Injectable, Injector, TemplateRef, } from '@angular/core';
import { DialogSizeWidth, RdsDialogConfig, RdsDialogRef } from './model';
import { defer, Subject } from 'rxjs';
import { Overlay, OverlayConfig, ScrollStrategyOptions, } from '@angular/cdk/overlay';
import { startWith } from 'rxjs/operators';
import { RdsDialogContainerComponent } from './dialog-container.component';
import { ComponentPortal, TemplatePortal } from '@angular/cdk/portal';
import { RDS_DIALOG_DATA } from './tokens';
import * as i0 from "@angular/core";
export class RdsDialogService {
    constructor() {
        this.overlay = inject(Overlay);
        this.injector = inject(Injector);
        this.scrollStrategyOptions = inject(ScrollStrategyOptions);
        this.parentDialogService = inject(RdsDialogService, {
            optional: true,
            skipSelf: true,
        });
        /* eslint-disable-next-line @typescript-eslint/no-explicit-any */
        this.dialogsOpenAtCurrentLevel = [];
        this.afterAllClosedAtCurrentLevel = new Subject();
        /* eslint-disable-next-line @typescript-eslint/no-explicit-any */
        this.afterOpenedAtCurrentLevel = new Subject();
        this.scrollStrategy = () => this.scrollStrategyOptions.block();
        this.afterAllClosed = defer(() => this.openDialogs.length
            ? this._afterAllClosed
            : this._afterAllClosed.pipe(startWith([undefined])));
    }
    /* eslint-disable-next-line @typescript-eslint/no-explicit-any */
    get openDialogs() {
        return this.parentDialogService
            ? this.parentDialogService.openDialogs
            : this.dialogsOpenAtCurrentLevel;
    }
    /* eslint-disable-next-line @typescript-eslint/no-explicit-any */
    get afterOpened() {
        return this.parentDialogService
            ? this.parentDialogService.afterOpened
            : this.afterOpenedAtCurrentLevel;
    }
    get _afterAllClosed() {
        const parent = this.parentDialogService;
        return parent ? parent._afterAllClosed : this.afterAllClosedAtCurrentLevel;
    }
    ngOnDestroy() {
        this.closeDialogs(this.dialogsOpenAtCurrentLevel);
        this.afterAllClosedAtCurrentLevel.complete();
        this.afterOpenedAtCurrentLevel.complete();
    }
    /* eslint-disable-next-line @typescript-eslint/no-explicit-any */
    open(componentOrTemplateRef, dialogConfig) {
        const mergedDialogConfig = this.mergeDialogConfigWithDefaultDialogConfigValues(dialogConfig);
        if (mergedDialogConfig.id && this.getDialogById(mergedDialogConfig.id)) {
            throw Error(`Dialog with id "${mergedDialogConfig.id}" exists already. The dialog id must be unique.`);
        }
        const overlayRef = this.createOverlayRef(mergedDialogConfig);
        const dialogContainer = this.attachDialogContainer(overlayRef, mergedDialogConfig);
        const dialogRef = this.attachDialogContent(componentOrTemplateRef, dialogContainer, overlayRef, mergedDialogConfig);
        this.openDialogs.push(dialogRef);
        dialogRef.afterClosed().subscribe(() => this.removeDialogRef(dialogRef));
        this.afterOpened.next(dialogRef);
        return dialogRef;
    }
    closeAll() {
        this.closeDialogs(this.openDialogs);
    }
    createOverlayRef(dialogConfig) {
        const overlayConfig = this.buildOverlayConfig({
            panelClass: dialogConfig.panelClass,
            hasBackdrop: dialogConfig.hasBackdrop,
            size: dialogConfig.size,
            minHeight: dialogConfig.minHeight,
            maxHeight: dialogConfig.maxHeight,
            closeOnNavigation: dialogConfig.closeOnNavigation,
            role: dialogConfig.role,
        });
        return this.overlay.create(overlayConfig);
    }
    getDialogById(id) {
        return this.openDialogs.find((dialog) => dialog.id === id);
    }
    buildOverlayConfig({ panelClass, hasBackdrop, size, minHeight, maxHeight, closeOnNavigation, }) {
        return new OverlayConfig({
            positionStrategy: this.overlay.position().global(),
            scrollStrategy: this.scrollStrategy(),
            panelClass,
            hasBackdrop,
            minWidth: '0px',
            maxWidth: `${DialogSizeWidth[size]}px`,
            minHeight,
            maxHeight,
            disposeOnNavigation: closeOnNavigation,
        });
    }
    attachDialogContainer(overlayRef, dialogConfig) {
        const userInjector = dialogConfig.viewContainerRef && dialogConfig.viewContainerRef.injector;
        const injector = Injector.create({
            parent: userInjector || this.injector,
            providers: [{ provide: RdsDialogConfig, useValue: dialogConfig }],
        });
        const containerPortal = new ComponentPortal(RdsDialogContainerComponent, dialogConfig.viewContainerRef, injector, dialogConfig.componentFactoryResolver);
        const containerRef = overlayRef.attach(containerPortal);
        return containerRef.instance;
    }
    attachDialogContent(componentOrTemplateRef, dialogContainer, overlayRef, dialogConfig) {
        const dialogRef = new RdsDialogRef(overlayRef, dialogContainer, dialogConfig.id);
        if (componentOrTemplateRef instanceof TemplateRef) {
            dialogContainer.attachTemplatePortal(new TemplatePortal(componentOrTemplateRef, null, 
            /* eslint-disable-next-line @typescript-eslint/no-explicit-any */
            { $implicit: dialogConfig.data, dialogRef }));
        }
        else {
            const injector = this.createInjector(dialogConfig, dialogRef, dialogContainer);
            const contentRef = dialogContainer.attachComponentPortal(new ComponentPortal(componentOrTemplateRef, dialogConfig.viewContainerRef, injector));
            dialogRef.componentInstance = contentRef.instance;
        }
        dialogRef.changeSize(`${DialogSizeWidth[dialogConfig.size]}px`, dialogConfig.height);
        dialogRef.centerDialog();
        dialogRef.updateOverlayPosition();
        return dialogRef;
    }
    createInjector(dialogConfig, dialogRef, dialogContainer) {
        const userInjector = dialogConfig.viewContainerRef && dialogConfig.viewContainerRef.injector;
        const providers = [
            { provide: RdsDialogContainerComponent, useValue: dialogContainer },
            { provide: RDS_DIALOG_DATA, useValue: dialogConfig.data },
            { provide: RdsDialogRef, useValue: dialogRef },
        ];
        return Injector.create({
            parent: userInjector || this.injector,
            providers,
        });
    }
    removeDialogRef(dialogRef) {
        const index = this.openDialogs.indexOf(dialogRef);
        if (index > -1) {
            this.openDialogs.splice(index, 1);
        }
    }
    closeDialogs(dialogs) {
        let i = dialogs.length;
        while (i--) {
            dialogs[i].close();
        }
    }
    mergeDialogConfigWithDefaultDialogConfigValues(dialogConfig) {
        const config = { ...new RdsDialogConfig(), ...dialogConfig };
        if (!config.panelClass) {
            config.panelClass = 'rds-dialog-overlay';
        }
        else if (typeof config.panelClass === 'string') {
            config.panelClass = ['rds-dialog-overlay', config.panelClass];
        }
        else {
            config.panelClass = ['rds-dialog-overlay', ...config.panelClass];
        }
        return config;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsDialogService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsDialogService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsDialogService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItY29tcG9uZW50cy9zcmMvbGliL2RpYWxvZy9kaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsTUFBTSxFQUNOLFVBQVUsRUFDVixRQUFRLEVBR1IsV0FBVyxHQUVaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFFLFlBQVksRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsS0FBSyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEVBRUwsT0FBTyxFQUNQLGFBQWEsRUFHYixxQkFBcUIsR0FDdEIsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDM0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sVUFBVSxDQUFDOztBQUczQyxNQUFNLE9BQU8sZ0JBQWdCO0lBRDdCO1FBRW1CLFlBQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUIsYUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1QiwwQkFBcUIsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUN0RCx3QkFBbUIsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLEVBQUU7WUFDOUQsUUFBUSxFQUFFLElBQUk7WUFDZCxRQUFRLEVBQUUsSUFBSTtTQUNmLENBQUMsQ0FBQztRQUVILGlFQUFpRTtRQUN6RCw4QkFBeUIsR0FBd0IsRUFBRSxDQUFDO1FBQzNDLGlD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LENBQUMsQ0FBQztRQUNwQyxDQUFDO0lBQ0gsQ0FBQztJQUVPLFlBQVksQ0FBVSxPQUFnQztRQUM1RCxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBRXZCLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNYLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNyQixDQUFDO0lBQ0gsQ0FBQztJQUVPLDhDQUE4QyxDQUNwRCxZQUEwQztRQUUxQyxNQUFNLE1BQU0sR0FBRyxFQUFFLEdBQUcsSUFBSSxlQUFlLEVBQUssRUFBRSxHQUFHLFlBQVksRUFBRSxDQUFDO1FBRWhFLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDdkIsTUFBTSxDQUFDLFVBQVUsR0FBRyxvQkFBb0IsQ0FBQztRQUMzQyxDQUFDO2FBQU0sSUFBSSxPQUFPLE1BQU0sQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDakQsTUFBTSxDQUFDLFVBQVUsR0FBRyxDQUFDLG9CQUFvQixFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNoRSxDQUFDO2FBQU0sQ0FBQztZQUNOLE1BQU0sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs4R0FyUFUsZ0JBQWdCO2tIQUFoQixnQkFBZ0IsY0FESCxNQUFNOzsyRkFDbkIsZ0JBQWdCO2tCQUQ1QixVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGluamVjdCxcbiAgSW5qZWN0YWJsZSxcbiAgSW5qZWN0b3IsXG4gIE9uRGVzdHJveSxcbiAgU3RhdGljUHJvdmlkZXIsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q29udGFpbmVyUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERpYWxvZ1NpemVXaWR0aCwgUmRzRGlhbG9nQ29uZmlnLCBSZHNEaWFsb2dSZWYgfSBmcm9tICcuL21vZGVsJztcbmltcG9ydCB7IGRlZmVyLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBDb21wb25lbnRUeXBlLFxuICBPdmVybGF5LFxuICBPdmVybGF5Q29uZmlnLFxuICBPdmVybGF5UmVmLFxuICBTY3JvbGxTdHJhdGVneSxcbiAgU2Nyb2xsU3RyYXRlZ3lPcHRpb25zLFxufSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBzdGFydFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSZHNEaWFsb2dDb250YWluZXJDb21wb25lbnQgfSBmcm9tICcuL2RpYWxvZy1jb250YWluZXIuY29tcG9uZW50JztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgVGVtcGxhdGVQb3J0YWwgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcbmltcG9ydCB7IFJEU19ESUFMT0dfREFUQSB9IGZyb20gJy4vdG9rZW5zJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBSZHNEaWFsb2dTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSByZWFkb25seSBvdmVybGF5ID0gaW5qZWN0KE92ZXJsYXkpO1xuICBwcml2YXRlIHJlYWRvbmx5IGluamVjdG9yID0gaW5qZWN0KEluamVjdG9yKTtcbiAgcHJpdmF0ZSByZWFkb25seSBzY3JvbGxTdHJhdGVneU9wdGlvbnMgPSBpbmplY3QoU2Nyb2xsU3RyYXRlZ3lPcHRpb25zKTtcbiAgcHJpdmF0ZSByZWFkb25seSBwYXJlbnREaWFsb2dTZXJ2aWNlID0gaW5qZWN0KFJkc0RpYWxvZ1NlcnZpY2UsIHtcbiAgICBvcHRpb25hbDogdHJ1ZSxcbiAgICBza2lwU2VsZjogdHJ1ZSxcbiAgfSk7XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkgKi9cbiAgcHJpdmF0ZSBkaWFsb2dzT3BlbkF0Q3VycmVudExldmVsOiBSZHNEaWFsb2dSZWY8YW55PltdID0gW107XG4gIHByaXZhdGUgcmVhZG9ubHkgYWZ0ZXJBbGxDbG9zZWRBdEN1cnJlbnRMZXZlbCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55ICovXG4gIHByaXZhdGUgcmVhZG9ubHkgYWZ0ZXJPcGVuZWRBdEN1cnJlbnRMZXZlbCA9IG5ldyBTdWJqZWN0PFJkc0RpYWxvZ1JlZjxhbnk+PigpO1xuICBwcml2YXRlIHJlYWRvbmx5IHNjcm9sbFN0cmF0ZWd5OiAoKSA9PiBTY3JvbGxTdHJhdGVneSA9ICgpID0+XG4gICAgdGhpcy5zY3JvbGxTdHJhdGVneU9wdGlvbnMuYmxvY2soKTtcblxuICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueSAqL1xuICBnZXQgb3BlbkRpYWxvZ3MoKTogUmRzRGlhbG9nUmVmPGFueT5bXSB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50RGlhbG9nU2VydmljZVxuICAgICAgPyB0aGlzLnBhcmVudERpYWxvZ1NlcnZpY2Uub3BlbkRpYWxvZ3NcbiAgICAgIDogdGhpcy5kaWFsb2dzT3BlbkF0Q3VycmVudExldmVsO1xuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkgKi9cbiAgZ2V0IGFmdGVyT3BlbmVkKCk6IFN1YmplY3Q8UmRzRGlhbG9nUmVmPGFueT4+IHtcbiAgICByZXR1cm4gdGhpcy5wYXJlbnREaWFsb2dTZXJ2aWNlXG4gICAgICA/IHRoaXMucGFyZW50RGlhbG9nU2VydmljZS5hZnRlck9wZW5lZFxuICAgICAgOiB0aGlzLmFmdGVyT3BlbmVkQXRDdXJyZW50TGV2ZWw7XG4gIH1cblxuICBnZXQgX2FmdGVyQWxsQ2xvc2VkKCk6IFN1YmplY3Q8dm9pZD4ge1xuICAgIGNvbnN0IHBhcmVudCA9IHRoaXMucGFyZW50RGlhbG9nU2VydmljZTtcblxuICAgIHJldHVybiBwYXJlbnQgPyBwYXJlbnQuX2FmdGVyQWxsQ2xvc2VkIDogdGhpcy5hZnRlckFsbENsb3NlZEF0Q3VycmVudExldmVsO1xuICB9XG5cbiAgcmVhZG9ubHkgYWZ0ZXJBbGxDbG9zZWQ6IE9ic2VydmFibGU8dm9pZD4gPSBkZWZlcigoKSA9PlxuICAgIHRoaXMub3BlbkRpYWxvZ3MubGVuZ3RoXG4gICAgICA/IHRoaXMuX2FmdGVyQWxsQ2xvc2VkXG4gICAgICA6IHRoaXMuX2FmdGVyQWxsQ2xvc2VkLnBpcGUoc3RhcnRXaXRoKFt1bmRlZmluZWRdKSksXG4gICkgYXMgT2JzZXJ2YWJsZTx2b2lkPjtcblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmNsb3NlRGlhbG9ncyh0aGlzLmRpYWxvZ3NPcGVuQXRDdXJyZW50TGV2ZWwpO1xuICAgIHRoaXMuYWZ0ZXJBbGxDbG9zZWRBdEN1cnJlbnRMZXZlbC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuYWZ0ZXJPcGVuZWRBdEN1cnJlbnRMZXZlbC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkgKi9cbiAgb3BlbjxULCBEID0gYW55LCBSID0gYW55PihcbiAgICBjb21wb25lbnRPclRlbXBsYXRlUmVmOiBDb21wb25lbnRUeXBlPFQ+IHwgVGVtcGxhdGVSZWY8VD4sXG4gICAgZGlhbG9nQ29uZmlnPzogUGFydGlhbDxSZHNEaWFsb2dDb25maWc8RD4+LFxuICApOiBSZHNEaWFsb2dSZWY8VCwgRCwgUj4ge1xuICAgIGNvbnN0IG1lcmdlZERpYWxvZ0NvbmZpZyA9XG4gICAgICB0aGlzLm1lcmdlRGlhbG9nQ29uZmlnV2l0aERlZmF1bHREaWFsb2dDb25maWdWYWx1ZXMoZGlhbG9nQ29uZmlnKTtcblxuICAgIGlmIChtZXJnZWREaWFsb2dDb25maWcuaWQgJiYgdGhpcy5nZXREaWFsb2dCeUlkKG1lcmdlZERpYWxvZ0NvbmZpZy5pZCkpIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBgRGlhbG9nIHdpdGggaWQgXCIke21lcmdlZERpYWxvZ0NvbmZpZy5pZH1cIiBleGlzdHMgYWxyZWFkeS4gVGhlIGRpYWxvZyBpZCBtdXN0IGJlIHVuaXF1ZS5gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBvdmVybGF5UmVmID0gdGhpcy5jcmVhdGVPdmVybGF5UmVmKG1lcmdlZERpYWxvZ0NvbmZpZyk7XG4gICAgY29uc3QgZGlhbG9nQ29udGFpbmVyID0gdGhpcy5hdHRhY2hEaWFsb2dDb250YWluZXIoXG4gICAgICBvdmVybGF5UmVmLFxuICAgICAgbWVyZ2VkRGlhbG9nQ29uZmlnLFxuICAgICk7XG4gICAgY29uc3QgZGlhbG9nUmVmID0gdGhpcy5hdHRhY2hEaWFsb2dDb250ZW50PFQsIEQsIFI+KFxuICAgICAgY29tcG9uZW50T3JUZW1wbGF0ZVJlZixcbiAgICAgIGRpYWxvZ0NvbnRhaW5lcixcbiAgICAgIG92ZXJsYXlSZWYsXG4gICAgICBtZXJnZWREaWFsb2dDb25maWcsXG4gICAgKTtcblxuICAgIHRoaXMub3BlbkRpYWxvZ3MucHVzaChkaWFsb2dSZWYpO1xuICAgIGRpYWxvZ1JlZi5hZnRlckNsb3NlZCgpLnN1YnNjcmliZSgoKSA9PiB0aGlzLnJlbW92ZURpYWxvZ1JlZihkaWFsb2dSZWYpKTtcbiAgICB0aGlzLmFmdGVyT3BlbmVkLm5leHQoZGlhbG9nUmVmKTtcblxuICAgIHJldHVybiBkaWFsb2dSZWY7XG4gIH1cblxuICBjbG9zZUFsbCgpOiB2b2lkIHtcbiAgICB0aGlzLmNsb3NlRGlhbG9ncyh0aGlzLm9wZW5EaWFsb2dzKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlT3ZlcmxheVJlZjxUPihkaWFsb2dDb25maWc6IFJkc0RpYWxvZ0NvbmZpZzxUPik6IE92ZXJsYXlSZWYge1xuICAgIGNvbnN0IG92ZXJsYXlDb25maWcgPSB0aGlzLmJ1aWxkT3ZlcmxheUNvbmZpZyh7XG4gICAgICBwYW5lbENsYXNzOiBkaWFsb2dDb25maWcucGFuZWxDbGFzcyxcbiAgICAgIGhhc0JhY2tkcm9wOiBkaWFsb2dDb25maWcuaGFzQmFja2Ryb3AsXG4gICAgICBzaXplOiBkaWFsb2dDb25maWcuc2l6ZSxcbiAgICAgIG1pbkhlaWdodDogZGlhbG9nQ29uZmlnLm1pbkhlaWdodCxcbiAgICAgIG1heEhlaWdodDogZGlhbG9nQ29uZmlnLm1heEhlaWdodCxcbiAgICAgIGNsb3NlT25OYXZpZ2F0aW9uOiBkaWFsb2dDb25maWcuY2xvc2VPbk5hdmlnYXRpb24sXG4gICAgICByb2xlOiBkaWFsb2dDb25maWcucm9sZSxcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLm92ZXJsYXkuY3JlYXRlKG92ZXJsYXlDb25maWcpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREaWFsb2dCeUlkPFQ+KGlkOiBzdHJpbmcpOiBSZHNEaWFsb2dSZWY8VD4gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLm9wZW5EaWFsb2dzLmZpbmQoKGRpYWxvZykgPT4gZGlhbG9nLmlkID09PSBpZCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkT3ZlcmxheUNvbmZpZzxEPih7XG4gICAgcGFuZWxDbGFzcyxcbiAgICBoYXNCYWNrZHJvcCxcbiAgICBzaXplLFxuICAgIG1pbkhlaWdodCxcbiAgICBtYXhIZWlnaHQsXG4gICAgY2xvc2VPbk5hdmlnYXRpb24sXG4gIH06IFJkc0RpYWxvZ0NvbmZpZzxEPik6IE92ZXJsYXlDb25maWcge1xuICAgIHJldHVybiBuZXcgT3ZlcmxheUNvbmZpZyh7XG4gICAgICBwb3NpdGlvblN0cmF0ZWd5OiB0aGlzLm92ZXJsYXkucG9zaXRpb24oKS5nbG9iYWwoKSxcbiAgICAgIHNjcm9sbFN0cmF0ZWd5OiB0aGlzLnNjcm9sbFN0cmF0ZWd5KCksXG4gICAgICBwYW5lbENsYXNzLFxuICAgICAgaGFzQmFja2Ryb3AsXG4gICAgICBtaW5XaWR0aDogJzBweCcsXG4gICAgICBtYXhXaWR0aDogYCR7RGlhbG9nU2l6ZVdpZHRoW3NpemVdfXB4YCxcbiAgICAgIG1pbkhlaWdodCxcbiAgICAgIG1heEhlaWdodCxcbiAgICAgIGRpc3Bvc2VPbk5hdmlnYXRpb246IGNsb3NlT25OYXZpZ2F0aW9uLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhdHRhY2hEaWFsb2dDb250YWluZXI8RD4oXG4gICAgb3ZlcmxheVJlZjogT3ZlcmxheVJlZixcbiAgICBkaWFsb2dDb25maWc6IFJkc0RpYWxvZ0NvbmZpZzxEPixcbiAgKTogUmRzRGlhbG9nQ29udGFpbmVyQ29tcG9uZW50PEQ+IHtcbiAgICBjb25zdCB1c2VySW5qZWN0b3IgPVxuICAgICAgZGlhbG9nQ29uZmlnLnZpZXdDb250YWluZXJSZWYgJiYgZGlhbG9nQ29uZmlnLnZpZXdDb250YWluZXJSZWYuaW5qZWN0b3I7XG4gICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcGFyZW50OiB1c2VySW5qZWN0b3IgfHwgdGhpcy5pbmplY3RvcixcbiAgICAgIHByb3ZpZGVyczogW3sgcHJvdmlkZTogUmRzRGlhbG9nQ29uZmlnLCB1c2VWYWx1ZTogZGlhbG9nQ29uZmlnIH1dLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY29udGFpbmVyUG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbDxSZHNEaWFsb2dDb250YWluZXJDb21wb25lbnQ8RD4+KFxuICAgICAgUmRzRGlhbG9nQ29udGFpbmVyQ29tcG9uZW50LFxuICAgICAgZGlhbG9nQ29uZmlnLnZpZXdDb250YWluZXJSZWYsXG4gICAgICBpbmplY3RvcixcbiAgICAgIGRpYWxvZ0NvbmZpZy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgKTtcbiAgICBjb25zdCBjb250YWluZXJSZWYgPVxuICAgICAgb3ZlcmxheVJlZi5hdHRhY2g8UmRzRGlhbG9nQ29udGFpbmVyQ29tcG9uZW50PEQ+Pihjb250YWluZXJQb3J0YWwpO1xuXG4gICAgcmV0dXJuIGNvbnRhaW5lclJlZi5pbnN0YW5jZTtcbiAgfVxuXG4gIHByaXZhdGUgYXR0YWNoRGlhbG9nQ29udGVudDxULCBELCBSPihcbiAgICBjb21wb25lbnRPclRlbXBsYXRlUmVmOiBDb21wb25lbnRUeXBlPFQ+IHwgVGVtcGxhdGVSZWY8VD4sXG4gICAgZGlhbG9nQ29udGFpbmVyOiBSZHNEaWFsb2dDb250YWluZXJDb21wb25lbnQ8RD4sXG4gICAgb3ZlcmxheVJlZjogT3ZlcmxheVJlZixcbiAgICBkaWFsb2dDb25maWc6IFJkc0RpYWxvZ0NvbmZpZzxEPixcbiAgKTogUmRzRGlhbG9nUmVmPFQsIEQsIFI+IHtcbiAgICBjb25zdCBkaWFsb2dSZWYgPSBuZXcgUmRzRGlhbG9nUmVmPFQsIEQsIFI+KFxuICAgICAgb3ZlcmxheVJlZixcbiAgICAgIGRpYWxvZ0NvbnRhaW5lcixcbiAgICAgIGRpYWxvZ0NvbmZpZy5pZCxcbiAgICApO1xuXG4gICAgaWYgKGNvbXBvbmVudE9yVGVtcGxhdGVSZWYgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZikge1xuICAgICAgZGlhbG9nQ29udGFpbmVyLmF0dGFjaFRlbXBsYXRlUG9ydGFsKFxuICAgICAgICBuZXcgVGVtcGxhdGVQb3J0YWw8VD4oXG4gICAgICAgICAgY29tcG9uZW50T3JUZW1wbGF0ZVJlZixcbiAgICAgICAgICBudWxsIGFzIHVua25vd24gYXMgVmlld0NvbnRhaW5lclJlZixcbiAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueSAqL1xuICAgICAgICAgIHsgJGltcGxpY2l0OiBkaWFsb2dDb25maWcuZGF0YSwgZGlhbG9nUmVmIH0gYXMgYW55LFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaW5qZWN0b3IgPSB0aGlzLmNyZWF0ZUluamVjdG9yPFQsIEQ+KFxuICAgICAgICBkaWFsb2dDb25maWcsXG4gICAgICAgIGRpYWxvZ1JlZixcbiAgICAgICAgZGlhbG9nQ29udGFpbmVyLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGNvbnRlbnRSZWYgPSBkaWFsb2dDb250YWluZXIuYXR0YWNoQ29tcG9uZW50UG9ydGFsPFQ+KFxuICAgICAgICBuZXcgQ29tcG9uZW50UG9ydGFsKFxuICAgICAgICAgIGNvbXBvbmVudE9yVGVtcGxhdGVSZWYsXG4gICAgICAgICAgZGlhbG9nQ29uZmlnLnZpZXdDb250YWluZXJSZWYsXG4gICAgICAgICAgaW5qZWN0b3IsXG4gICAgICAgICksXG4gICAgICApO1xuICAgICAgZGlhbG9nUmVmLmNvbXBvbmVudEluc3RhbmNlID0gY29udGVudFJlZi5pbnN0YW5jZTtcbiAgICB9XG5cbiAgICBkaWFsb2dSZWYuY2hhbmdlU2l6ZShcbiAgICAgIGAke0RpYWxvZ1NpemVXaWR0aFtkaWFsb2dDb25maWcuc2l6ZV19cHhgLFxuICAgICAgZGlhbG9nQ29uZmlnLmhlaWdodCxcbiAgICApO1xuICAgIGRpYWxvZ1JlZi5jZW50ZXJEaWFsb2coKTtcbiAgICBkaWFsb2dSZWYudXBkYXRlT3ZlcmxheVBvc2l0aW9uKCk7XG5cbiAgICByZXR1cm4gZGlhbG9nUmVmO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVJbmplY3RvcjxULCBEPihcbiAgICBkaWFsb2dDb25maWc6IFJkc0RpYWxvZ0NvbmZpZzxEPixcbiAgICBkaWFsb2dSZWY6IFJkc0RpYWxvZ1JlZjxUPixcbiAgICBkaWFsb2dDb250YWluZXI6IFJkc0RpYWxvZ0NvbnRhaW5lckNvbXBvbmVudDxEPixcbiAgKTogSW5qZWN0b3Ige1xuICAgIGNvbnN0IHVzZXJJbmplY3RvciA9XG4gICAgICBkaWFsb2dDb25maWcudmlld0NvbnRhaW5lclJlZiAmJiBkaWFsb2dDb25maWcudmlld0NvbnRhaW5lclJlZi5pbmplY3RvcjtcblxuICAgIGNvbnN0IHByb3ZpZGVyczogU3RhdGljUHJvdmlkZXJbXSA9IFtcbiAgICAgIHsgcHJvdmlkZTogUmRzRGlhbG9nQ29udGFpbmVyQ29tcG9uZW50LCB1c2VWYWx1ZTogZGlhbG9nQ29udGFpbmVyIH0sXG4gICAgICB7IHByb3ZpZGU6IFJEU19ESUFMT0dfREFUQSwgdXNlVmFsdWU6IGRpYWxvZ0NvbmZpZy5kYXRhIH0sXG4gICAgICB7IHByb3ZpZGU6IFJkc0RpYWxvZ1JlZiwgdXNlVmFsdWU6IGRpYWxvZ1JlZiB9LFxuICAgIF07XG5cbiAgICByZXR1cm4gSW5qZWN0b3IuY3JlYXRlKHtcbiAgICAgIHBhcmVudDogdXNlckluamVjdG9yIHx8IHRoaXMuaW5qZWN0b3IsXG4gICAgICBwcm92aWRlcnMsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZURpYWxvZ1JlZjxULCBELCBSPihkaWFsb2dSZWY6IFJkc0RpYWxvZ1JlZjxULCBELCBSPik6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5vcGVuRGlhbG9ncy5pbmRleE9mKGRpYWxvZ1JlZik7XG5cbiAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgdGhpcy5vcGVuRGlhbG9ncy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2xvc2VEaWFsb2dzPFQsIEQsIFI+KGRpYWxvZ3M6IFJkc0RpYWxvZ1JlZjxULCBELCBSPltdKTogdm9pZCB7XG4gICAgbGV0IGkgPSBkaWFsb2dzLmxlbmd0aDtcblxuICAgIHdoaWxlIChpLS0pIHtcbiAgICAgIGRpYWxvZ3NbaV0uY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1lcmdlRGlhbG9nQ29uZmlnV2l0aERlZmF1bHREaWFsb2dDb25maWdWYWx1ZXM8RD4oXG4gICAgZGlhbG9nQ29uZmlnPzogUGFydGlhbDxSZHNEaWFsb2dDb25maWc8RD4+LFxuICApOiBSZHNEaWFsb2dDb25maWc8RD4ge1xuICAgIGNvbnN0IGNvbmZpZyA9IHsgLi4ubmV3IFJkc0RpYWxvZ0NvbmZpZzxEPigpLCAuLi5kaWFsb2dDb25maWcgfTtcblxuICAgIGlmICghY29uZmlnLnBhbmVsQ2xhc3MpIHtcbiAgICAgIGNvbmZpZy5wYW5lbENsYXNzID0gJ3Jkcy1kaWFsb2ctb3ZlcmxheSc7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgY29uZmlnLnBhbmVsQ2xhc3MgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25maWcucGFuZWxDbGFzcyA9IFsncmRzLWRpYWxvZy1vdmVybGF5JywgY29uZmlnLnBhbmVsQ2xhc3NdO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25maWcucGFuZWxDbGFzcyA9IFsncmRzLWRpYWxvZy1vdmVybGF5JywgLi4uY29uZmlnLnBhbmVsQ2xhc3NdO1xuICAgIH1cblxuICAgIHJldHVybiBjb25maWc7XG4gIH1cbn1cbiJdfQ==