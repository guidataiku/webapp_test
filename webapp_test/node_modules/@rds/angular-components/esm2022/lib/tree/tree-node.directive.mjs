import { CdkTreeNode } from '@angular/cdk/tree';
import { Attribute, booleanAttribute, Directive, ElementRef, HostBinding, HostListener, inject, Input, numberAttribute, Renderer2, } from '@angular/core';
import { FocusMonitor } from '@angular/cdk/a11y';
import { RdsTreeComponent } from './tree.component';
import { TAB_INDEX_DEFAULT, TAB_INDEX_NOT_FOCUSABLE } from '../utils';
import * as i0 from "@angular/core";
export class RdsTreeNodeDirective extends CdkTreeNode {
    get cssClasses() {
        const cssClasses = ['rds-tree-node'];
        if (this.disabled) {
            cssClasses.push('rds-tree-node--disabled');
        }
        if (!this.disabled && this.active) {
            cssClasses.push('rds-tree-node--active');
        }
        if (this.tree) {
            cssClasses.push(`rds-tree-node--size-${this.tree.size}`);
        }
        return cssClasses.join(' ');
    }
    get attrAriaExpanded() {
        // don't set aria-expanded for leafs as it violates accessibility
        if (!this._tree.treeControl.isExpandable(this._data)) {
            return undefined;
        }
        return this.isExpanded;
    }
    get attrAriaLevel() {
        return this.level + 1;
    }
    get styleLevel() {
        return this.level + 1;
    }
    get attrTabIndex() {
        return this.disabled ? TAB_INDEX_NOT_FOCUSABLE : this.tabIndex;
    }
    onArrowDown() {
        const nextNode = this._elementRef.nativeElement
            .nextElementSibling;
        if (!nextNode) {
            return;
        }
        this.focusMonitor.focusVia(nextNode, 'keyboard');
    }
    onArrowUp() {
        const previousNode = this._elementRef.nativeElement
            .previousElementSibling;
        if (!previousNode) {
            return;
        }
        this.focusMonitor.focusVia(previousNode, 'keyboard');
    }
    onExpand(event) {
        if (this.disabled) {
            return;
        }
        if (this._tree.treeControl.isExpandable(this._data) &&
            !this._tree.treeControl.isExpanded(this._data)) {
            this._tree.treeControl.expand(this.data);
            event.stopPropagation();
        }
    }
    onCollapse(event) {
        if (this.disabled) {
            return;
        }
        if (this._tree.treeControl.isExpandable(this._data) &&
            this._tree.treeControl.isExpanded(this._data)) {
            this._tree.treeControl.collapse(this._data);
            event.stopPropagation();
        }
    }
    constructor(tabIndex) {
        super(inject(ElementRef), inject(RdsTreeComponent));
        this.renderer = inject(Renderer2);
        this.focusMonitor = inject(FocusMonitor);
        this.tree = inject(RdsTreeComponent);
        this.tabIndex = TAB_INDEX_DEFAULT;
        this.disabled = false;
        this.active = false;
        this.tabIndex = numberAttribute(tabIndex, TAB_INDEX_DEFAULT);
    }
    ngAfterContentInit() {
        if (!this.disabled) {
            this.focusMonitor.monitor(this._elementRef, true);
        }
        else {
            this.focusMonitor.stopMonitoring(this._elementRef);
        }
    }
    ngOnChanges(changes) {
        if (changes['disabled'] &&
            changes['disabled'].previousValue !== changes['disabled'].currentValue) {
            if (this.disabled) {
                this.focusMonitor.stopMonitoring(this._elementRef);
                this.renderer.setAttribute(this._elementRef.nativeElement, 'disabled', 'disabled');
            }
            else {
                this.renderer.removeAttribute(this._elementRef.nativeElement, 'disabled');
                this.focusMonitor.monitor(this._elementRef, true);
            }
            this._checkButtons();
        }
    }
    ngOnDestroy() {
        super.ngOnDestroy();
        this.focusMonitor.stopMonitoring(this._elementRef);
    }
    focus() {
        super.focus();
    }
    _checkButtons() {
        const buttonElements = this._elementRef.nativeElement.querySelectorAll('button');
        buttonElements.forEach((b) => this.renderer.setProperty(b, 'disabled', this.disabled));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsTreeNodeDirective, deps: [{ token: 'tabindex', attribute: true }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "16.1.0", version: "17.3.1", type: RdsTreeNodeDirective, selector: "rds-tree-node", inputs: { tabIndex: ["tabIndex", "tabIndex", numberAttribute], disabled: ["disabled", "disabled", booleanAttribute], active: ["active", "active", booleanAttribute] }, host: { listeners: { "keydown.arrowDown": "onArrowDown()", "keydown.arrowUp": "onArrowUp()", "keydown.arrowRight": "onExpand($event)", "keydown.arrowLeft": "onCollapse($event)" }, properties: { "class": "this.cssClasses", "attr.aria-expanded": "this.attrAriaExpanded", "attr.aria-level": "this.attrAriaLevel", "style.--rds-tree-node-level": "this.styleLevel", "tabIndex": "this.attrTabIndex" } }, providers: [{ provide: CdkTreeNode, useExisting: RdsTreeNodeDirective }], exportAs: ["rdsTreeNode"], usesInheritance: true, usesOnChanges: true, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsTreeNodeDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'rds-tree-node',
                    exportAs: 'rdsTreeNode',
                    providers: [{ provide: CdkTreeNode, useExisting: RdsTreeNodeDirective }],
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Attribute,
                    args: ['tabindex']
                }] }], propDecorators: { cssClasses: [{
                type: HostBinding,
                args: ['class']
            }], attrAriaExpanded: [{
                type: HostBinding,
                args: ['attr.aria-expanded']
            }], attrAriaLevel: [{
                type: HostBinding,
                args: ['attr.aria-level']
            }], styleLevel: [{
                type: HostBinding,
                args: ['style.--rds-tree-node-level']
            }], attrTabIndex: [{
                type: HostBinding,
                args: ['tabIndex']
            }], tabIndex: [{
                type: Input,
                args: [{ transform: numberAttribute }]
            }], disabled: [{
                type: Input,
                args: [{ transform: booleanAttribute }]
            }], active: [{
                type: Input,
                args: [{ transform: booleanAttribute }]
            }], onArrowDown: [{
                type: HostListener,
                args: ['keydown.arrowDown']
            }], onArrowUp: [{
                type: HostListener,
                args: ['keydown.arrowUp']
            }], onExpand: [{
                type: HostListener,
                args: ['keydown.arrowRight', ['$event']]
            }], onCollapse: [{
                type: HostListener,
                args: ['keydown.arrowLeft', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1ub2RlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvYW5ndWxhci1jb21wb25lbnRzL3NyYy9saWIvdHJlZS90cmVlLW5vZGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLEVBRUwsU0FBUyxFQUNULGdCQUFnQixFQUNoQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFdBQVcsRUFDWCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFDTCxlQUFlLEVBR2YsU0FBUyxHQUVWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBbUIsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDcEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLHVCQUF1QixFQUFFLE1BQU0sVUFBVSxDQUFDOztBQU90RSxNQUFNLE9BQU8sb0JBQ1gsU0FBUSxXQUFjO0lBT3RCLElBQTBCLFVBQVU7UUFDbEMsTUFBTSxVQUFVLEdBQWEsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUUvQyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNsQixVQUFVLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDN0MsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNsQyxVQUFVLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDM0MsQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2QsVUFBVSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FB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Vzt1QkFBQyw2QkFBNkI7Z0JBS3RDLFlBQVk7c0JBRGYsV0FBVzt1QkFBQyxVQUFVO2dCQU12QixRQUFRO3NCQURQLEtBQUs7dUJBQUMsRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUFFO2dCQUdHLFFBQVE7c0JBQS9DLEtBQUs7dUJBQUMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUU7Z0JBQ0UsTUFBTTtzQkFBN0MsS0FBSzt1QkFBQyxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRTtnQkFHdEMsV0FBVztzQkFEVixZQUFZO3VCQUFDLG1CQUFtQjtnQkFhakMsU0FBUztzQkFEUixZQUFZO3VCQUFDLGlCQUFpQjtnQkFhL0IsUUFBUTtzQkFEUCxZQUFZO3VCQUFDLG9CQUFvQixFQUFFLENBQUMsUUFBUSxDQUFDO2dCQWdCOUMsVUFBVTtzQkFEVCxZQUFZO3VCQUFDLG1CQUFtQixFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2RrVHJlZU5vZGUgfSBmcm9tICdAYW5ndWxhci9jZGsvdHJlZSc7XG5pbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBBdHRyaWJ1dGUsXG4gIGJvb2xlYW5BdHRyaWJ1dGUsXG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgSG9zdEJpbmRpbmcsXG4gIEhvc3RMaXN0ZW5lcixcbiAgaW5qZWN0LFxuICBJbnB1dCxcbiAgbnVtYmVyQXR0cmlidXRlLFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgUmVuZGVyZXIyLFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvY3VzYWJsZU9wdGlvbiwgRm9jdXNNb25pdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2ExMXknO1xuaW1wb3J0IHsgUmRzVHJlZUNvbXBvbmVudCB9IGZyb20gJy4vdHJlZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgVEFCX0lOREVYX0RFRkFVTFQsIFRBQl9JTkRFWF9OT1RfRk9DVVNBQkxFIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdyZHMtdHJlZS1ub2RlJyxcbiAgZXhwb3J0QXM6ICdyZHNUcmVlTm9kZScsXG4gIHByb3ZpZGVyczogW3sgcHJvdmlkZTogQ2RrVHJlZU5vZGUsIHVzZUV4aXN0aW5nOiBSZHNUcmVlTm9kZURpcmVjdGl2ZSB9XSxcbn0pXG5leHBvcnQgY2xhc3MgUmRzVHJlZU5vZGVEaXJlY3RpdmU8VD5cbiAgZXh0ZW5kcyBDZGtUcmVlTm9kZTxUPlxuICBpbXBsZW1lbnRzIEFmdGVyQ29udGVudEluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBGb2N1c2FibGVPcHRpb25cbntcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHJlbmRlcmVyID0gaW5qZWN0KFJlbmRlcmVyMik7XG4gIHByb3RlY3RlZCByZWFkb25seSBmb2N1c01vbml0b3IgPSBpbmplY3QoRm9jdXNNb25pdG9yKTtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHRyZWUgPSBpbmplY3Q8UmRzVHJlZUNvbXBvbmVudDxUPj4oUmRzVHJlZUNvbXBvbmVudCk7XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpIGdldCBjc3NDbGFzc2VzKCk6IHN0cmluZyB7XG4gICAgY29uc3QgY3NzQ2xhc3Nlczogc3RyaW5nW10gPSBbJ3Jkcy10cmVlLW5vZGUnXTtcblxuICAgIGlmICh0aGlzLmRpc2FibGVkKSB7XG4gICAgICBjc3NDbGFzc2VzLnB1c2goJ3Jkcy10cmVlLW5vZGUtLWRpc2FibGVkJyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmRpc2FibGVkICYmIHRoaXMuYWN0aXZlKSB7XG4gICAgICBjc3NDbGFzc2VzLnB1c2goJ3Jkcy10cmVlLW5vZGUtLWFjdGl2ZScpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnRyZWUpIHtcbiAgICAgIGNzc0NsYXNzZXMucHVzaChgcmRzLXRyZWUtbm9kZS0tc2l6ZS0ke3RoaXMudHJlZS5zaXplfWApO1xuICAgIH1cblxuICAgIHJldHVybiBjc3NDbGFzc2VzLmpvaW4oJyAnKTtcbiAgfVxuXG4gIEBIb3N0QmluZGluZygnYXR0ci5hcmlhLWV4cGFuZGVkJykgZ2V0IGF0dHJBcmlhRXhwYW5kZWQoKTpcbiAgICB8IGJvb2xlYW5cbiAgICB8IHVuZGVmaW5lZCB7XG4gICAgLy8gZG9uJ3Qgc2V0IGFyaWEtZXhwYW5kZWQgZm9yIGxlYWZzIGFzIGl0IHZpb2xhdGVzIGFjY2Vzc2liaWxpdHlcbiAgICBpZiAoIXRoaXMuX3RyZWUudHJlZUNvbnRyb2wuaXNFeHBhbmRhYmxlKHRoaXMuX2RhdGEpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmlzRXhwYW5kZWQ7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2F0dHIuYXJpYS1sZXZlbCcpIGdldCBhdHRyQXJpYUxldmVsKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMubGV2ZWwgKyAxO1xuICB9XG5cbiAgQEhvc3RCaW5kaW5nKCdzdHlsZS4tLXJkcy10cmVlLW5vZGUtbGV2ZWwnKSBnZXQgc3R5bGVMZXZlbCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmxldmVsICsgMTtcbiAgfVxuXG4gIEBIb3N0QmluZGluZygndGFiSW5kZXgnKVxuICBnZXQgYXR0clRhYkluZGV4KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZGlzYWJsZWQgPyBUQUJfSU5ERVhfTk9UX0ZPQ1VTQUJMRSA6IHRoaXMudGFiSW5kZXg7XG4gIH1cblxuICBASW5wdXQoeyB0cmFuc2Zvcm06IG51bWJlckF0dHJpYnV0ZSB9KVxuICB0YWJJbmRleCA9IFRBQl9JTkRFWF9ERUZBVUxUO1xuXG4gIEBJbnB1dCh7IHRyYW5zZm9ybTogYm9vbGVhbkF0dHJpYnV0ZSB9KSBkaXNhYmxlZCA9IGZhbHNlO1xuICBASW5wdXQoeyB0cmFuc2Zvcm06IGJvb2xlYW5BdHRyaWJ1dGUgfSkgYWN0aXZlID0gZmFsc2U7XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd0Rvd24nKVxuICBvbkFycm93RG93bigpOiB2b2lkIHtcbiAgICBjb25zdCBuZXh0Tm9kZSA9IHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudFxuICAgICAgLm5leHRFbGVtZW50U2libGluZyBhcyBIVE1MRWxlbWVudCB8IG51bGw7XG5cbiAgICBpZiAoIW5leHROb2RlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5mb2N1c01vbml0b3IuZm9jdXNWaWEobmV4dE5vZGUsICdrZXlib2FyZCcpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd1VwJylcbiAgb25BcnJvd1VwKCk6IHZvaWQge1xuICAgIGNvbnN0IHByZXZpb3VzTm9kZSA9IHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudFxuICAgICAgLnByZXZpb3VzRWxlbWVudFNpYmxpbmcgYXMgSFRNTEVsZW1lbnQgfCBudWxsO1xuXG4gICAgaWYgKCFwcmV2aW91c05vZGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmZvY3VzTW9uaXRvci5mb2N1c1ZpYShwcmV2aW91c05vZGUsICdrZXlib2FyZCcpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd1JpZ2h0JywgWyckZXZlbnQnXSlcbiAgb25FeHBhbmQoZXZlbnQ6IEtleWJvYXJkRXZlbnQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5kaXNhYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHRoaXMuX3RyZWUudHJlZUNvbnRyb2wuaXNFeHBhbmRhYmxlKHRoaXMuX2RhdGEpICYmXG4gICAgICAhdGhpcy5fdHJlZS50cmVlQ29udHJvbC5pc0V4cGFuZGVkKHRoaXMuX2RhdGEpXG4gICAgKSB7XG4gICAgICB0aGlzLl90cmVlLnRyZWVDb250cm9sLmV4cGFuZCh0aGlzLmRhdGEpO1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd0xlZnQnLCBbJyRldmVudCddKVxuICBvbkNvbGxhcHNlKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLl90cmVlLnRyZWVDb250cm9sLmlzRXhwYW5kYWJsZSh0aGlzLl9kYXRhKSAmJlxuICAgICAgdGhpcy5fdHJlZS50cmVlQ29udHJvbC5pc0V4cGFuZGVkKHRoaXMuX2RhdGEpXG4gICAgKSB7XG4gICAgICB0aGlzLl90cmVlLnRyZWVDb250cm9sLmNvbGxhcHNlKHRoaXMuX2RhdGEpO1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuICB9XG5cbiAgY29uc3RydWN0b3IoQEF0dHJpYnV0ZSgndGFiaW5kZXgnKSB0YWJJbmRleD86IHN0cmluZykge1xuICAgIHN1cGVyKGluamVjdChFbGVtZW50UmVmKSwgaW5qZWN0KFJkc1RyZWVDb21wb25lbnQpKTtcbiAgICB0aGlzLnRhYkluZGV4ID0gbnVtYmVyQXR0cmlidXRlKHRhYkluZGV4LCBUQUJfSU5ERVhfREVGQVVMVCk7XG4gIH1cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmRpc2FibGVkKSB7XG4gICAgICB0aGlzLmZvY3VzTW9uaXRvci5tb25pdG9yKHRoaXMuX2VsZW1lbnRSZWYsIHRydWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZvY3VzTW9uaXRvci5zdG9wTW9uaXRvcmluZyh0aGlzLl9lbGVtZW50UmVmKTtcbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgY2hhbmdlc1snZGlzYWJsZWQnXSAmJlxuICAgICAgY2hhbmdlc1snZGlzYWJsZWQnXS5wcmV2aW91c1ZhbHVlICE9PSBjaGFuZ2VzWydkaXNhYmxlZCddLmN1cnJlbnRWYWx1ZVxuICAgICkge1xuICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5mb2N1c01vbml0b3Iuc3RvcE1vbml0b3JpbmcodGhpcy5fZWxlbWVudFJlZik7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKFxuICAgICAgICAgIHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCxcbiAgICAgICAgICAnZGlzYWJsZWQnLFxuICAgICAgICAgICdkaXNhYmxlZCcsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUF0dHJpYnV0ZShcbiAgICAgICAgICB0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsXG4gICAgICAgICAgJ2Rpc2FibGVkJyxcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5mb2N1c01vbml0b3IubW9uaXRvcih0aGlzLl9lbGVtZW50UmVmLCB0cnVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fY2hlY2tCdXR0b25zKCk7XG4gICAgfVxuICB9XG5cbiAgb3ZlcnJpZGUgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgc3VwZXIubmdPbkRlc3Ryb3koKTtcbiAgICB0aGlzLmZvY3VzTW9uaXRvci5zdG9wTW9uaXRvcmluZyh0aGlzLl9lbGVtZW50UmVmKTtcbiAgfVxuXG4gIG92ZXJyaWRlIGZvY3VzKCk6IHZvaWQge1xuICAgIHN1cGVyLmZvY3VzKCk7XG4gIH1cblxuICBwcml2YXRlIF9jaGVja0J1dHRvbnMoKTogdm9pZCB7XG4gICAgY29uc3QgYnV0dG9uRWxlbWVudHMgPVxuICAgICAgdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGw8SFRNTEJ1dHRvbkVsZW1lbnQ+KFxuICAgICAgICAnYnV0dG9uJyxcbiAgICAgICk7XG4gICAgYnV0dG9uRWxlbWVudHMuZm9yRWFjaCgoYikgPT5cbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkoYiwgJ2Rpc2FibGVkJywgdGhpcy5kaXNhYmxlZCksXG4gICAgKTtcbiAgfVxufVxuIl19