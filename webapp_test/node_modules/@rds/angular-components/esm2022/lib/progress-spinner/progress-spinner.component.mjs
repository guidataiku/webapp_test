import { booleanAttribute, ChangeDetectionStrategy, Component, HostBinding, Input, numberAttribute, ViewEncapsulation, } from '@angular/core';
import { Subject } from 'rxjs';
import { debounceTime, delay } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "ngx-lottie";
import * as i2 from "@angular/common";
const ANIMATION_SPEED_FACTOR = 10;
const ANIMATION_DIRECTION = {
    FORWARD: 1,
    BACKWARD: -1,
};
const DEFAULT_MAX_VALUE = 100;
const DEFAULT_MIN_VALUE = 0;
export class RdsProgressSpinnerComponent {
    constructor() {
        this.animationConfig$ = new Subject();
        this.animationConfigDebounced$ = this.animationConfig$.pipe(delay(1), debounceTime(1));
        this.hostRole = 'progressbar';
        this._value = DEFAULT_MIN_VALUE;
        this._minValue = DEFAULT_MIN_VALUE;
        this._maxValue = DEFAULT_MAX_VALUE;
        this.mode = 'indeterminate';
        this.size = 'xl';
        this.white = false;
    }
    get hostClasses() {
        return ['rds-progress-spinner', `rds-progress-spinner-${this.size}`];
    }
    get attrValueMin() {
        return this.mode === 'determinate' ? this.minValue : null;
    }
    get attrValueMax() {
        return this.mode === 'determinate' ? this.maxValue : null;
    }
    get attrValueNow() {
        return this.mode === 'determinate' ? this.value : null;
    }
    set value(newValue) {
        const value = numberAttribute(newValue, DEFAULT_MIN_VALUE);
        if (this._value !== value) {
            this._value = value;
            if (this.animationItem) {
                this.animationItem.setDirection(this.getAnimationDirection());
                this.playAnimation();
            }
        }
    }
    get value() {
        return this._value;
    }
    set minValue(value) {
        const min = numberAttribute(value, DEFAULT_MIN_VALUE);
        if (min > this.maxValue) {
            throw new Error(`The minimal value should be less than maximum value`);
        }
        if (this._minValue !== min) {
            this._minValue = min;
            this.animationItem.setDirection(this.getAnimationDirection());
            this.playAnimation();
        }
    }
    get minValue() {
        return this._minValue;
    }
    set maxValue(value) {
        const max = numberAttribute(value, DEFAULT_MAX_VALUE);
        if (max < this.minValue) {
            throw new Error(`The maximal value should be greater than minimal value`);
        }
        if (this._maxValue !== max) {
            this._maxValue = max;
            this.animationItem.setDirection(this.getAnimationDirection());
            this.playAnimation();
        }
    }
    get maxValue() {
        return this._maxValue;
    }
    ngAfterViewInit() {
        this._setAnimationConfig();
    }
    ngOnChanges(changes) {
        if (changes['mode'] || changes['size'] || changes['white']) {
            this._setAnimationConfig();
        }
    }
    ngOnDestroy() {
        this.animationItem?.destroy();
    }
    animationCreated($event) {
        if (this.mode === 'determinate') {
            this.animationItem = $event;
            this.playAnimation();
        }
    }
    playAnimation() {
        if (this.mode === 'determinate' && this.animationItem) {
            this.animationItem.pause();
            this.removeAnimationItemListener();
            if ((this.animationItem.playDirection === ANIMATION_DIRECTION.FORWARD &&
                this.animationItem.currentFrame < this.getPercentageValue()) ||
                (this.animationItem.playDirection === ANIMATION_DIRECTION.BACKWARD &&
                    this.animationItem.currentFrame > this.getPercentageValue())) {
                this.animationItem.setSpeed(Math.abs(this.animationItem.currentFrame - this.getPercentageValue()) / ANIMATION_SPEED_FACTOR);
                this.animationItem.play();
                this.animationItem.addEventListener('enterFrame', (event) => {
                    if ((this.animationItem.playDirection === ANIMATION_DIRECTION.FORWARD &&
                        event.currentTime >= this.getPercentageValue()) ||
                        (this.animationItem.playDirection ===
                            ANIMATION_DIRECTION.BACKWARD &&
                            event.currentTime < this.getPercentageValue())) {
                        this.animationItem.pause();
                        this.removeAnimationItemListener();
                        this.animationItem.goToAndStop(this.getPercentageValue(), true);
                    }
                });
            }
        }
    }
    _getPath() {
        return `assets/spinner/spinner-${this.mode === 'determinate' ? 'determinate-' : ''}${this.white ? 'white-' : ''}${this.size}.json`;
    }
    _setAnimationConfig() {
        if (this.animationItem) {
            this.animationItem.destroy();
        }
        if (this.mode === 'indeterminate') {
            this.animationConfig$.next({
                path: this._getPath(),
                autoplay: true,
                loop: true,
            });
        }
        else {
            this.animationConfig$.next({
                path: this._getPath(),
                loop: false,
            });
        }
    }
    removeAnimationItemListener() {
        if (this.animationItem) {
            this.animationItem.removeEventListener('enterFrame');
        }
    }
    getPercentageValue() {
        const value = ((this.value - this.minValue) / (this.maxValue - this.minValue)) * 100;
        const percentage = Math.round(value + Number.EPSILON);
        if (percentage <= DEFAULT_MIN_VALUE) {
            return DEFAULT_MIN_VALUE;
        }
        else if (percentage >= this.animationItem.totalFrames) {
            return this.animationItem.totalFrames || DEFAULT_MAX_VALUE;
        }
        else {
            return percentage;
        }
    }
    getAnimationDirection() {
        return this.getPercentageValue() < this.animationItem.currentFrame
            ? ANIMATION_DIRECTION.BACKWARD
            : ANIMATION_DIRECTION.FORWARD;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsProgressSpinnerComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "17.3.1", type: RdsProgressSpinnerComponent, selector: "rds-progress-spinner", inputs: { value: "value", minValue: "minValue", maxValue: "maxValue", mode: "mode", size: "size", label: "label", white: ["white", "white", booleanAttribute] }, host: { properties: { "class": "this.hostClasses", "attr.role": "this.hostRole", "attr.aria-valuemin": "this.attrValueMin", "attr.aria-valuemax": "this.attrValueMax", "attr.aria-valuenow": "this.attrValueNow", "class.rds-progress-spinner--white": "this.white" } }, usesOnChanges: true, ngImport: i0, template: `
    <div class="rds-progress-spinner-container">
      <ng-lottie
        [options]="animationConfigDebounced$ | async"
        (animationCreated)="animationCreated($event)"
      />
    </div>
    @if (label) {
      <span class="rds-progress-spinner-label">{{ label }}</span>
    }
  `, isInline: true, styles: [".rds-progress-spinner{display:flex;flex-direction:column;justify-content:center;align-items:center}.rds-progress-spinner.rds-progress-spinner-xs .rds-progress-spinner-container{font-size:12px;font-weight:400;line-height:16px;text-transform:none;letter-spacing:.5px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:18px;width:18px}.rds-progress-spinner.rds-progress-spinner-s .rds-progress-spinner-container{font-size:12px;font-weight:400;line-height:16px;text-transform:none;letter-spacing:.5px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:24px;width:24px}.rds-progress-spinner.rds-progress-spinner-m .rds-progress-spinner-container{font-size:14px;font-weight:200;line-height:20px;text-transform:none;letter-spacing:.3px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:32px;width:32px}.rds-progress-spinner.rds-progress-spinner-l .rds-progress-spinner-container{font-size:14px;font-weight:200;line-height:20px;text-transform:none;letter-spacing:.3px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:44px;width:44px}.rds-progress-spinner.rds-progress-spinner-xl .rds-progress-spinner-container{font-size:16px;font-weight:400;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:72px;width:72px}.rds-progress-spinner .rds-progress-spinner-container path[stroke-linecap=butt]{stroke:var(--rds-color-track)}.rds-progress-spinner .rds-progress-spinner-container path[stroke-linecap=round]{stroke:var(--rds-color-informative)}.rds-progress-spinner .rds-progress-spinner-label{display:flex;margin-top:4px;color:var(--rds-color-informative)}.rds-progress-spinner.rds-progress-spinner--white .rds-progress-spinner-label{color:var(--rds-color-on-dark-surface)}.rds-progress-spinner.rds-progress-spinner--white .rds-progress-spinner-container path[stroke-linecap=butt]{stroke:var(--rds-color-on-dark-surface)}.rds-progress-spinner.rds-progress-spinner--white .rds-progress-spinner-container path[stroke-linecap=round]{stroke:var(--rds-color-on-dark-surface)}\n"], dependencies: [{ kind: "component", type: i1.LottieComponent, selector: "ng-lottie", inputs: ["width", "height"] }, { kind: "pipe", type: i2.AsyncPipe, name: "async" }], changeDetection: i0.ChangeDetectionStrategy.OnPush, encapsulation: i0.ViewEncapsulation.None }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsProgressSpinnerComponent, decorators: [{
            type: Component,
            args: [{ selector: 'rds-progress-spinner', template: `
    <div class="rds-progress-spinner-container">
      <ng-lottie
        [options]="animationConfigDebounced$ | async"
        (animationCreated)="animationCreated($event)"
      />
    </div>
    @if (label) {
      <span class="rds-progress-spinner-label">{{ label }}</span>
    }
  `, encapsulation: ViewEncapsulation.None, changeDetection: ChangeDetectionStrategy.OnPush, styles: [".rds-progress-spinner{display:flex;flex-direction:column;justify-content:center;align-items:center}.rds-progress-spinner.rds-progress-spinner-xs .rds-progress-spinner-container{font-size:12px;font-weight:400;line-height:16px;text-transform:none;letter-spacing:.5px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:18px;width:18px}.rds-progress-spinner.rds-progress-spinner-s .rds-progress-spinner-container{font-size:12px;font-weight:400;line-height:16px;text-transform:none;letter-spacing:.5px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:24px;width:24px}.rds-progress-spinner.rds-progress-spinner-m .rds-progress-spinner-container{font-size:14px;font-weight:200;line-height:20px;text-transform:none;letter-spacing:.3px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:32px;width:32px}.rds-progress-spinner.rds-progress-spinner-l .rds-progress-spinner-container{font-size:14px;font-weight:200;line-height:20px;text-transform:none;letter-spacing:.3px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:44px;width:44px}.rds-progress-spinner.rds-progress-spinner-xl .rds-progress-spinner-container{font-size:16px;font-weight:400;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:72px;width:72px}.rds-progress-spinner .rds-progress-spinner-container path[stroke-linecap=butt]{stroke:var(--rds-color-track)}.rds-progress-spinner .rds-progress-spinner-container path[stroke-linecap=round]{stroke:var(--rds-color-informative)}.rds-progress-spinner .rds-progress-spinner-label{display:flex;margin-top:4px;color:var(--rds-color-informative)}.rds-progress-spinner.rds-progress-spinner--white .rds-progress-spinner-label{color:var(--rds-color-on-dark-surface)}.rds-progress-spinner.rds-progress-spinner--white .rds-progress-spinner-container path[stroke-linecap=butt]{stroke:var(--rds-color-on-dark-surface)}.rds-progress-spinner.rds-progress-spinner--white .rds-progress-spinner-container path[stroke-linecap=round]{stroke:var(--rds-color-on-dark-surface)}\n"] }]
        }], propDecorators: { hostClasses: [{
                type: HostBinding,
                args: ['class']
            }], hostRole: [{
                type: HostBinding,
                args: ['attr.role']
            }], attrValueMin: [{
                type: HostBinding,
                args: ['attr.aria-valuemin']
            }], attrValueMax: [{
                type: HostBinding,
                args: ['attr.aria-valuemax']
            }], attrValueNow: [{
                type: HostBinding,
                args: ['attr.aria-valuenow']
            }], value: [{
                type: Input
            }], minValue: [{
                type: Input
            }], maxValue: [{
                type: Input
            }], mode: [{
                type: Input
            }], size: [{
                type: Input
            }], label: [{
                type: Input
            }], white: [{
                type: HostBinding,
                args: ['class.rds-progress-spinner--white']
            }, {
                type: Input,
                args: [{ transform: booleanAttribute }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZ3Jlc3Mtc3Bpbm5lci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItY29tcG9uZW50cy9zcmMvbGliL3Byb2dyZXNzLXNwaW5uZXIvcHJvZ3Jlc3Mtc3Bpbm5lci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLGdCQUFnQixFQUNoQix1QkFBdUIsRUFDdkIsU0FBUyxFQUNULFdBQVcsRUFDWCxLQUFLLEVBQ0wsZUFBZSxFQUlmLGlCQUFpQixHQUNsQixNQUFNLGVBQWUsQ0FBQztBQVF2QixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFFckQsTUFBTSxzQkFBc0IsR0FBRyxFQUFFLENBQUM7QUFFbEMsTUFBTSxtQkFBbUIsR0FHckI7SUFDRixPQUFPLEVBQUUsQ0FBQztJQUNWLFFBQVEsRUFBRSxDQUFDLENBQUM7Q0FDYixDQUFDO0FBQ0YsTUFBTSxpQkFBaUIsR0FBRyxHQUFHLENBQUM7QUFDOUIsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLENBQUM7QUFtQjVCLE1BQU0sT0FBTywyQkFBMkI7SUFqQnhDO1FBcUJtQixxQkFBZ0IsR0FBRyxJQUFJLE9BQU8sRUFBb0IsQ0FBQztRQUNqRCw4QkFBeUIsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUN2RSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQ1IsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUNoQixDQUFDO1FBTWlDLGFBQVEsR0FBRyxhQUFhLENBQUM7UUFtQ3BELFdBQU0sR0FBRyxpQkFBaUIsQ0FBQztRQXFCM0IsY0FBUyxHQUFHLGlCQUFpQixDQUFDO1FBcUI5QixjQUFTLEdBQUcsaUJBQWlCLENBQUM7UUFFN0IsU0FBSSxHQUEyQixlQUFlLENB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LENBQUM7WUFDTixPQUFPLFVBQVUsQ0FBQztRQUNwQixDQUFDO0lBQ0gsQ0FBQztJQUVPLHFCQUFxQjtRQUMzQixPQUFPLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWTtZQUNoRSxDQUFDLENBQUMsbUJBQW1CLENBQUMsUUFBUTtZQUM5QixDQUFDLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDO0lBQ2xDLENBQUM7OEdBOU1VLDJCQUEyQjtrR0FBM0IsMkJBQTJCLGdMQWtHbEIsZ0JBQWdCLDJUQWpIMUI7Ozs7Ozs7Ozs7R0FVVDs7MkZBS1UsMkJBQTJCO2tCQWpCdkMsU0FBUzsrQkFDRSxzQkFBc0IsWUFDdEI7Ozs7Ozs7Ozs7R0FVVCxpQkFFYyxpQkFBaUIsQ0FBQyxJQUFJLG1CQUNwQix1QkFBdUIsQ0FBQyxNQUFNOzhCQVlyQixXQUFXO3NCQUFwQyxXQUFXO3VCQUFDLE9BQU87Z0JBSWUsUUFBUTtzQkFBMUMsV0FBVzt1QkFBQyxXQUFXO2dCQUdwQixZQUFZO3NCQURmLFdBQVc7dUJBQUMsb0JBQW9CO2dCQU03QixZQUFZO3NCQURmLFdBQVc7dUJBQUMsb0JBQW9CO2dCQU03QixZQUFZO3NCQURmLFdBQVc7dUJBQUMsb0JBQW9CO2dCQU03QixLQUFLO3NCQURSLEtBQUs7Z0JBcUJGLFFBQVE7c0JBRFgsS0FBSztnQkFzQkYsUUFBUTtzQkFEWCxLQUFLO2dCQXFCRyxJQUFJO3NCQUFaLEtBQUs7Z0JBQ0csSUFBSTtzQkFBWixLQUFLO2dCQUNHLEtBQUs7c0JBQWIsS0FBSztnQkFJTixLQUFLO3NCQUZKLFdBQVc7dUJBQUMsbUNBQW1DOztzQkFDL0MsS0FBSzt1QkFBQyxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyVmlld0luaXQsXG4gIGJvb2xlYW5BdHRyaWJ1dGUsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDb21wb25lbnQsXG4gIEhvc3RCaW5kaW5nLFxuICBJbnB1dCxcbiAgbnVtYmVyQXR0cmlidXRlLFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVmlld0VuY2Fwc3VsYXRpb24sXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQW5pbWF0aW9uSXRlbSB9IGZyb20gJ2xvdHRpZS13ZWInO1xuaW1wb3J0IHsgQW5pbWF0aW9uT3B0aW9ucyB9IGZyb20gJ25neC1sb3R0aWUnO1xuaW1wb3J0IHtcbiAgUmRzUHJvZ3Jlc3NTcGlubmVyTW9kZSxcbiAgUmRzUHJvZ3Jlc3NTcGlubmVyU2l6ZSxcbn0gZnJvbSAnLi9wcm9ncmVzcy1zcGlubmVyLnR5cGVzJztcbmltcG9ydCB7IE51bWJlcklucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZGVsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmNvbnN0IEFOSU1BVElPTl9TUEVFRF9GQUNUT1IgPSAxMDtcbnR5cGUgUmRzUHJvZ3Jlc3NTcGlubmVyRGlyZWN0aW9uID0gMSB8IC0xO1xuY29uc3QgQU5JTUFUSU9OX0RJUkVDVElPTjoge1xuICBGT1JXQVJEOiBSZHNQcm9ncmVzc1NwaW5uZXJEaXJlY3Rpb247XG4gIEJBQ0tXQVJEOiBSZHNQcm9ncmVzc1NwaW5uZXJEaXJlY3Rpb247XG59ID0ge1xuICBGT1JXQVJEOiAxLFxuICBCQUNLV0FSRDogLTEsXG59O1xuY29uc3QgREVGQVVMVF9NQVhfVkFMVUUgPSAxMDA7XG5jb25zdCBERUZBVUxUX01JTl9WQUxVRSA9IDA7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3Jkcy1wcm9ncmVzcy1zcGlubmVyJyxcbiAgdGVtcGxhdGU6IGBcbiAgICA8ZGl2IGNsYXNzPVwicmRzLXByb2dyZXNzLXNwaW5uZXItY29udGFpbmVyXCI+XG4gICAgICA8bmctbG90dGllXG4gICAgICAgIFtvcHRpb25zXT1cImFuaW1hdGlvbkNvbmZpZ0RlYm91bmNlZCQgfCBhc3luY1wiXG4gICAgICAgIChhbmltYXRpb25DcmVhdGVkKT1cImFuaW1hdGlvbkNyZWF0ZWQoJGV2ZW50KVwiXG4gICAgICAvPlxuICAgIDwvZGl2PlxuICAgIEBpZiAobGFiZWwpIHtcbiAgICAgIDxzcGFuIGNsYXNzPVwicmRzLXByb2dyZXNzLXNwaW5uZXItbGFiZWxcIj57eyBsYWJlbCB9fTwvc3Bhbj5cbiAgICB9XG4gIGAsXG4gIHN0eWxlVXJsczogW2AuL3Byb2dyZXNzLXNwaW5uZXIuY29tcG9uZW50LnNjc3NgXSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIFJkc1Byb2dyZXNzU3Bpbm5lckNvbXBvbmVudFxuICBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95XG57XG4gIHByaXZhdGUgYW5pbWF0aW9uSXRlbTogQW5pbWF0aW9uSXRlbTtcbiAgcHJpdmF0ZSByZWFkb25seSBhbmltYXRpb25Db25maWckID0gbmV3IFN1YmplY3Q8QW5pbWF0aW9uT3B0aW9ucz4oKTtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGFuaW1hdGlvbkNvbmZpZ0RlYm91bmNlZCQgPSB0aGlzLmFuaW1hdGlvbkNvbmZpZyQucGlwZShcbiAgICBkZWxheSgxKSxcbiAgICBkZWJvdW5jZVRpbWUoMSksXG4gICk7XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpIGdldCBob3N0Q2xhc3NlcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIFsncmRzLXByb2dyZXNzLXNwaW5uZXInLCBgcmRzLXByb2dyZXNzLXNwaW5uZXItJHt0aGlzLnNpemV9YF07XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2F0dHIucm9sZScpIHJlYWRvbmx5IGhvc3RSb2xlID0gJ3Byb2dyZXNzYmFyJztcblxuICBASG9zdEJpbmRpbmcoJ2F0dHIuYXJpYS12YWx1ZW1pbicpXG4gIGdldCBhdHRyVmFsdWVNaW4oKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMubW9kZSA9PT0gJ2RldGVybWluYXRlJyA/IHRoaXMubWluVmFsdWUgOiBudWxsO1xuICB9XG5cbiAgQEhvc3RCaW5kaW5nKCdhdHRyLmFyaWEtdmFsdWVtYXgnKVxuICBnZXQgYXR0clZhbHVlTWF4KCk6IG51bWJlciB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLm1vZGUgPT09ICdkZXRlcm1pbmF0ZScgPyB0aGlzLm1heFZhbHVlIDogbnVsbDtcbiAgfVxuXG4gIEBIb3N0QmluZGluZygnYXR0ci5hcmlhLXZhbHVlbm93JylcbiAgZ2V0IGF0dHJWYWx1ZU5vdygpOiBudW1iZXIgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5tb2RlID09PSAnZGV0ZXJtaW5hdGUnID8gdGhpcy52YWx1ZSA6IG51bGw7XG4gIH1cblxuICBASW5wdXQoKVxuICBzZXQgdmFsdWUobmV3VmFsdWU6IE51bWJlcklucHV0KSB7XG4gICAgY29uc3QgdmFsdWUgPSBudW1iZXJBdHRyaWJ1dGUobmV3VmFsdWUsIERFRkFVTFRfTUlOX1ZBTFVFKTtcblxuICAgIGlmICh0aGlzLl92YWx1ZSAhPT0gdmFsdWUpIHtcbiAgICAgIHRoaXMuX3ZhbHVlID0gdmFsdWU7XG5cbiAgICAgIGlmICh0aGlzLmFuaW1hdGlvbkl0ZW0pIHtcbiAgICAgICAgdGhpcy5hbmltYXRpb25JdGVtLnNldERpcmVjdGlvbih0aGlzLmdldEFuaW1hdGlvbkRpcmVjdGlvbigpKTtcbiAgICAgICAgdGhpcy5wbGF5QW5pbWF0aW9uKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0IHZhbHVlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBfdmFsdWUgPSBERUZBVUxUX01JTl9WQUxVRTtcblxuICBASW5wdXQoKVxuICBzZXQgbWluVmFsdWUodmFsdWU6IE51bWJlcklucHV0KSB7XG4gICAgY29uc3QgbWluID0gbnVtYmVyQXR0cmlidXRlKHZhbHVlLCBERUZBVUxUX01JTl9WQUxVRSk7XG5cbiAgICBpZiAobWluID4gdGhpcy5tYXhWYWx1ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgbWluaW1hbCB2YWx1ZSBzaG91bGQgYmUgbGVzcyB0aGFuIG1heGltdW0gdmFsdWVgKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fbWluVmFsdWUgIT09IG1pbikge1xuICAgICAgdGhpcy5fbWluVmFsdWUgPSBtaW47XG4gICAgICB0aGlzLmFuaW1hdGlvbkl0ZW0uc2V0RGlyZWN0aW9uKHRoaXMuZ2V0QW5pbWF0aW9uRGlyZWN0aW9uKCkpO1xuICAgICAgdGhpcy5wbGF5QW5pbWF0aW9uKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IG1pblZhbHVlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX21pblZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBfbWluVmFsdWUgPSBERUZBVUxUX01JTl9WQUxVRTtcblxuICBASW5wdXQoKVxuICBzZXQgbWF4VmFsdWUodmFsdWU6IE51bWJlcklucHV0KSB7XG4gICAgY29uc3QgbWF4ID0gbnVtYmVyQXR0cmlidXRlKHZhbHVlLCBERUZBVUxUX01BWF9WQUxVRSk7XG5cbiAgICBpZiAobWF4IDwgdGhpcy5taW5WYWx1ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgbWF4aW1hbCB2YWx1ZSBzaG91bGQgYmUgZ3JlYXRlciB0aGFuIG1pbmltYWwgdmFsdWVgKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fbWF4VmFsdWUgIT09IG1heCkge1xuICAgICAgdGhpcy5fbWF4VmFsdWUgPSBtYXg7XG4gICAgICB0aGlzLmFuaW1hdGlvbkl0ZW0uc2V0RGlyZWN0aW9uKHRoaXMuZ2V0QW5pbWF0aW9uRGlyZWN0aW9uKCkpO1xuICAgICAgdGhpcy5wbGF5QW5pbWF0aW9uKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IG1heFZhbHVlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX21heFZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBfbWF4VmFsdWUgPSBERUZBVUxUX01BWF9WQUxVRTtcblxuICBASW5wdXQoKSBtb2RlOiBSZHNQcm9ncmVzc1NwaW5uZXJNb2RlID0gJ2luZGV0ZXJtaW5hdGUnO1xuICBASW5wdXQoKSBzaXplOiBSZHNQcm9ncmVzc1NwaW5uZXJTaXplID0gJ3hsJztcbiAgQElucHV0KCkgbGFiZWw6IHN0cmluZyB8IG51bGw7XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcy5yZHMtcHJvZ3Jlc3Mtc3Bpbm5lci0td2hpdGUnKVxuICBASW5wdXQoeyB0cmFuc2Zvcm06IGJvb2xlYW5BdHRyaWJ1dGUgfSlcbiAgd2hpdGUgPSBmYWxzZTtcblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5fc2V0QW5pbWF0aW9uQ29uZmlnKCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXNbJ21vZGUnXSB8fCBjaGFuZ2VzWydzaXplJ10gfHwgY2hhbmdlc1snd2hpdGUnXSkge1xuICAgICAgdGhpcy5fc2V0QW5pbWF0aW9uQ29uZmlnKCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5hbmltYXRpb25JdGVtPy5kZXN0cm95KCk7XG4gIH1cblxuICBhbmltYXRpb25DcmVhdGVkKCRldmVudDogQW5pbWF0aW9uSXRlbSk6IHZvaWQge1xuICAgIGlmICh0aGlzLm1vZGUgPT09ICdkZXRlcm1pbmF0ZScpIHtcbiAgICAgIHRoaXMuYW5pbWF0aW9uSXRlbSA9ICRldmVudDtcbiAgICAgIHRoaXMucGxheUFuaW1hdGlvbigpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGxheUFuaW1hdGlvbigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5tb2RlID09PSAnZGV0ZXJtaW5hdGUnICYmIHRoaXMuYW5pbWF0aW9uSXRlbSkge1xuICAgICAgdGhpcy5hbmltYXRpb25JdGVtLnBhdXNlKCk7XG4gICAgICB0aGlzLnJlbW92ZUFuaW1hdGlvbkl0ZW1MaXN0ZW5lcigpO1xuXG4gICAgICBpZiAoXG4gICAgICAgICh0aGlzLmFuaW1hdGlvbkl0ZW0ucGxheURpcmVjdGlvbiA9PT0gQU5JTUFUSU9OX0RJUkVDVElPTi5GT1JXQVJEICYmXG4gICAgICAgICAgdGhpcy5hbmltYXRpb25JdGVtLmN1cnJlbnRGcmFtZSA8IHRoaXMuZ2V0UGVyY2VudGFnZVZhbHVlKCkpIHx8XG4gICAgICAgICh0aGlzLmFuaW1hdGlvbkl0ZW0ucGxheURpcmVjdGlvbiA9PT0gQU5JTUFUSU9OX0RJUkVDVElPTi5CQUNLV0FSRCAmJlxuICAgICAgICAgIHRoaXMuYW5pbWF0aW9uSXRlbS5jdXJyZW50RnJhbWUgPiB0aGlzLmdldFBlcmNlbnRhZ2VWYWx1ZSgpKVxuICAgICAgKSB7XG4gICAgICAgIHRoaXMuYW5pbWF0aW9uSXRlbS5zZXRTcGVlZChcbiAgICAgICAgICBNYXRoLmFicyhcbiAgICAgICAgICAgIHRoaXMuYW5pbWF0aW9uSXRlbS5jdXJyZW50RnJhbWUgLSB0aGlzLmdldFBlcmNlbnRhZ2VWYWx1ZSgpLFxuICAgICAgICAgICkgLyBBTklNQVRJT05fU1BFRURfRkFDVE9SLFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmFuaW1hdGlvbkl0ZW0ucGxheSgpO1xuXG4gICAgICAgIHRoaXMuYW5pbWF0aW9uSXRlbS5hZGRFdmVudExpc3RlbmVyKCdlbnRlckZyYW1lJywgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgKHRoaXMuYW5pbWF0aW9uSXRlbS5wbGF5RGlyZWN0aW9uID09PSBBTklNQVRJT05fRElSRUNUSU9OLkZPUldBUkQgJiZcbiAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFRpbWUgPj0gdGhpcy5nZXRQZXJjZW50YWdlVmFsdWUoKSkgfHxcbiAgICAgICAgICAgICh0aGlzLmFuaW1hdGlvbkl0ZW0ucGxheURpcmVjdGlvbiA9PT1cbiAgICAgICAgICAgICAgQU5JTUFUSU9OX0RJUkVDVElPTi5CQUNLV0FSRCAmJlxuICAgICAgICAgICAgICBldmVudC5jdXJyZW50VGltZSA8IHRoaXMuZ2V0UGVyY2VudGFnZVZhbHVlKCkpXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICB0aGlzLmFuaW1hdGlvbkl0ZW0ucGF1c2UoKTtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQW5pbWF0aW9uSXRlbUxpc3RlbmVyKCk7XG4gICAgICAgICAgICB0aGlzLmFuaW1hdGlvbkl0ZW0uZ29Ub0FuZFN0b3AodGhpcy5nZXRQZXJjZW50YWdlVmFsdWUoKSwgdHJ1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9nZXRQYXRoKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBhc3NldHMvc3Bpbm5lci9zcGlubmVyLSR7XG4gICAgICB0aGlzLm1vZGUgPT09ICdkZXRlcm1pbmF0ZScgPyAnZGV0ZXJtaW5hdGUtJyA6ICcnXG4gICAgfSR7dGhpcy53aGl0ZSA/ICd3aGl0ZS0nIDogJyd9JHt0aGlzLnNpemV9Lmpzb25gO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0QW5pbWF0aW9uQ29uZmlnKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmFuaW1hdGlvbkl0ZW0pIHtcbiAgICAgIHRoaXMuYW5pbWF0aW9uSXRlbS5kZXN0cm95KCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubW9kZSA9PT0gJ2luZGV0ZXJtaW5hdGUnKSB7XG4gICAgICB0aGlzLmFuaW1hdGlvbkNvbmZpZyQubmV4dCh7XG4gICAgICAgIHBhdGg6IHRoaXMuX2dldFBhdGgoKSxcbiAgICAgICAgYXV0b3BsYXk6IHRydWUsXG4gICAgICAgIGxvb3A6IHRydWUsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hbmltYXRpb25Db25maWckLm5leHQoe1xuICAgICAgICBwYXRoOiB0aGlzLl9nZXRQYXRoKCksXG4gICAgICAgIGxvb3A6IGZhbHNlLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVBbmltYXRpb25JdGVtTGlzdGVuZXIoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuYW5pbWF0aW9uSXRlbSkge1xuICAgICAgdGhpcy5hbmltYXRpb25JdGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2VudGVyRnJhbWUnKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFBlcmNlbnRhZ2VWYWx1ZSgpOiBudW1iZXIge1xuICAgIGNvbnN0IHZhbHVlID1cbiAgICAgICgodGhpcy52YWx1ZSAtIHRoaXMubWluVmFsdWUpIC8gKHRoaXMubWF4VmFsdWUgLSB0aGlzLm1pblZhbHVlKSkgKiAxMDA7XG4gICAgY29uc3QgcGVyY2VudGFnZSA9IE1hdGgucm91bmQodmFsdWUgKyBOdW1iZXIuRVBTSUxPTik7XG5cbiAgICBpZiAocGVyY2VudGFnZSA8PSBERUZBVUxUX01JTl9WQUxVRSkge1xuICAgICAgcmV0dXJuIERFRkFVTFRfTUlOX1ZBTFVFO1xuICAgIH0gZWxzZSBpZiAocGVyY2VudGFnZSA+PSB0aGlzLmFuaW1hdGlvbkl0ZW0udG90YWxGcmFtZXMpIHtcbiAgICAgIHJldHVybiB0aGlzLmFuaW1hdGlvbkl0ZW0udG90YWxGcmFtZXMgfHwgREVGQVVMVF9NQVhfVkFMVUU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBwZXJjZW50YWdlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0QW5pbWF0aW9uRGlyZWN0aW9uKCk6IFJkc1Byb2dyZXNzU3Bpbm5lckRpcmVjdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UGVyY2VudGFnZVZhbHVlKCkgPCB0aGlzLmFuaW1hdGlvbkl0ZW0uY3VycmVudEZyYW1lXG4gICAgICA/IEFOSU1BVElPTl9ESVJFQ1RJT04uQkFDS1dBUkRcbiAgICAgIDogQU5JTUFUSU9OX0RJUkVDVElPTi5GT1JXQVJEO1xuICB9XG59XG4iXX0=