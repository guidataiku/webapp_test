import { Subject } from 'rxjs';
export class AsyncSelectionModel {
    get changed() {
        return this._changed.asObservable();
    }
    get length() {
        return this._length;
    }
    constructor(length, _multiple = false, compareFunc = (a, b) => a === b, initiallySelectedValues, initiallyDeselectedValues, _emitChanges = true) {
        this._multiple = _multiple;
        this._emitChanges = _emitChanges;
        this._length = -1;
        this._isAllSelected = false;
        this._removedToEmit = [];
        this._addedToEmit = [];
        this._selected = [];
        this._deselected = [];
        this._changed = new Subject();
        this._compareFunc = (a, b) => a === b;
        this._length = length;
        if (initiallySelectedValues && initiallySelectedValues.length) {
            if (_multiple) {
                initiallySelectedValues.forEach((value) => this._markSelected(value));
            }
            else {
                this._markSelected(initiallySelectedValues[0]);
            }
            this._addedToEmit.length = 0;
        }
        if (initiallyDeselectedValues && initiallyDeselectedValues.length) {
            initiallyDeselectedValues.forEach((value) => this._markDeselected(value));
            this._removedToEmit.length = 0;
        }
        if (typeof compareFunc === 'function') {
            this._compareFunc = compareFunc;
        }
    }
    updateLength(length) {
        this._length = length;
        this._checkIfAllSelected();
    }
    isAllSelected() {
        return this._isAllSelected || this._length === 0;
    }
    getAllSelectedType() {
        if (this.isAllSelected() && this._deselected.length === 0) {
            return 'all';
        }
        else if (!this.isAllSelected() && this._selected.length === 0) {
            return 'none';
        }
        else {
            return 'partial';
        }
    }
    selectAll() {
        if (this._length > 1 && !this._multiple) {
            throw getMultipleValuesInSingleSelectionError();
        }
        this._isAllSelected = true;
        this._deselected = [];
        this._removedToEmit = [];
        this._selected = [];
        this._addedToEmit = [];
        this._emitChangeEvent();
    }
    deselectAll() {
        this._isAllSelected = false;
        this._deselected = [];
        this._removedToEmit = [];
        this._selected = [];
        this._addedToEmit = [];
        this._emitChangeEvent();
    }
    toggleAll() {
        this.isAllSelected() ? this.deselectAll() : this.selectAll();
    }
    clear() {
        this._isAllSelected = false;
        this._deselected = [];
        this._removedToEmit = [];
        this._selected = [];
        this._addedToEmit = [];
        this._emitChangeEvent();
    }
    select(...values) {
        this._verifyValueAssignment(values);
        values.forEach((value) => this._markSelected(value));
        this._checkIfAllSelected();
        this._emitChangeEvent();
    }
    deselect(...values) {
        this._verifyValueAssignment(values);
        values.forEach((value) => this._markDeselected(value));
        this._checkIfAllSelected();
        this._emitChangeEvent();
    }
    toggle(value) {
        this.isSelected(value) ? this.deselect(value) : this.select(value);
    }
    isSelected(value) {
        return this.isAllSelected()
            ? !this._deselected.some((v) => this._compareFunc(v, value))
            : this._selected.some((v) => this._compareFunc(v, value));
    }
    isDeselected(value) {
        return !this.isSelected(value);
    }
    isEmpty() {
        if (this._length === 0) {
            return true;
        }
        return ((!this.isAllSelected() && this._selected.length === 0) ||
            (this.isAllSelected() && this._deselected.length === this._length));
    }
    hasValue() {
        return !this.isEmpty();
    }
    sort(predicate) {
        if (this._multiple) {
            if (this._selected) {
                this._selected.sort(predicate);
            }
        }
        if (this._deselected) {
            this._deselected.sort(predicate);
        }
    }
    isMultipleSelection() {
        return this._multiple;
    }
    _emitChangeEvent() {
        this._changed.next({
            source: this,
            isAllSelected: this.isAllSelected(),
            allSelectedType: this.getAllSelectedType(),
            added: this._addedToEmit,
            removed: this._removedToEmit,
        });
        this._removedToEmit = [];
        this._addedToEmit = [];
    }
    _markSelected(value) {
        if (this.isDeselected(value)) {
            this._unmarkDeselected(value);
            if (!this._multiple) {
                this._unmarkAll();
            }
            this._selected.push(value);
            if (this._emitChanges) {
                this.pushIfNotExists(this._addedToEmit, value);
            }
        }
    }
    _unmarkSelected(value) {
        if (this.isSelected(value)) {
            const index = this._selected.findIndex((v) => this._compareFunc(v, value));
            if (index > -1) {
                this._selected.splice(index, 1);
                if (this._emitChanges) {
                    this.pushIfNotExists(this._removedToEmit, value);
                }
            }
        }
    }
    _markDeselected(value) {
        if (this.isSelected(value)) {
            this._unmarkSelected(value);
            const index = this._deselected.findIndex((v) => this._compareFunc(v, value));
            if (index === -1) {
                this._deselected.push(value);
                if (this._emitChanges) {
                    this.pushIfNotExists(this._removedToEmit, value);
                }
            }
        }
    }
    _unmarkDeselected(value) {
        if (this.isDeselected(value)) {
            const index = this._deselected.findIndex((v) => this._compareFunc(v, value));
            if (index > -1) {
                this._deselected.splice(index, 1);
                if (this._emitChanges) {
                    this.pushIfNotExists(this._addedToEmit, value);
                }
            }
        }
    }
    _unmarkAll() {
        if (!this.isEmpty()) {
            this._selected.forEach((value) => this._unmarkSelected(value));
        }
    }
    _verifyValueAssignment(values) {
        if (values.length > 1 && !this._multiple) {
            throw getMultipleValuesInSingleSelectionError();
        }
    }
    _checkIfAllSelected() {
        if (this._length === this._selected.length) {
            this._isAllSelected = true;
            this._removedToEmit = this._deselected;
            this._deselected = [];
        }
        else if (this._length === this._deselected.length) {
            this._isAllSelected = false;
            this._addedToEmit = [];
            this._selected = [];
        }
    }
    pushIfNotExists(array, value) {
        if (array.every((v) => !this._compareFunc(v, value))) {
            array.push(value);
        }
    }
}
export function getMultipleValuesInSingleSelectionError() {
    return Error('Cannot pass multiple values into AsyncSelectionModel with single-value mode.');
}
export function isEqual(...property) {
    if (!property || (Array.isArray(property) && property.length === 0)) {
        throw new Error('Property needs to be defined to compare function');
    }
    return (a, b) => {
        for (let i = 0; i < property.length; i++) {
            if (a[property[i]] === b[property[i]]) {
                continue;
            }
            return false;
        }
        return true;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXN5bmMtc2VsZWN0aW9uLm1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9hbmd1bGFyLWNvbXBvbmVudHMvc3JjL2xpYi90YWJsZS9hc3luYy1zZWxlY3Rpb24ubW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUkzQyxNQUFNLE9BQU8sbUJBQW1CO0lBUzlCLElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ1IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFJRCxZQUNFLE1BQWMsRUFDSixZQUFZLEtBQUssRUFDM0IsY0FBdUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUN4RCx1QkFBNkIsRUFDN0IseUJBQStCLEVBQ3JCLGVBQWUsSUFBSTtRQUpuQixjQUFTLEdBQVQsU0FBUyxDQUFRO1FBSWpCLGlCQUFZLEdBQVosWUFBWSxDQUFPO1FBeEJyQixZQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDYixtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUN2QixtQkFBYyxHQUFRLEVBQUUsQ0FBQztRQUN6QixpQkFBWSxHQUFRLEVBQUUsQ0FBQztRQUN2QixjQUFTLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLGdCQUFXLEdBQVEsRUFBRSxDQUFDO1FBQ2IsYUFBUSxHQUFHLElBQUksT0FBTyxFQUEyQixDQUFDO1FBVTNELGlCQUFZLEdBQTRCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQVVsRSxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUV0QixJQUFJLHVCQUF1QixJQUFJLHVCQUF1QixD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QUFDO0lBQ2QsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuZXhwb3J0IHR5cGUgQWxsU2VsZWN0ZWRUeXBlID0gJ25vbmUnIHwgJ3BhcnRpYWwnIHwgJ2FsbCc7XG5cbmV4cG9ydCBjbGFzcyBBc3luY1NlbGVjdGlvbk1vZGVsPFQ+IHtcbiAgcHJvdGVjdGVkIF9sZW5ndGggPSAtMTtcbiAgcHJvdGVjdGVkIF9pc0FsbFNlbGVjdGVkID0gZmFsc2U7XG4gIHByb3RlY3RlZCBfcmVtb3ZlZFRvRW1pdDogVFtdID0gW107XG4gIHByb3RlY3RlZCBfYWRkZWRUb0VtaXQ6IFRbXSA9IFtdO1xuICBwcm90ZWN0ZWQgX3NlbGVjdGVkOiBUW10gPSBbXTtcbiAgcHJvdGVjdGVkIF9kZXNlbGVjdGVkOiBUW10gPSBbXTtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IF9jaGFuZ2VkID0gbmV3IFN1YmplY3Q8QXN5bmNTZWxlY3Rpb25DaGFuZ2U8VD4+KCk7XG5cbiAgZ2V0IGNoYW5nZWQoKTogT2JzZXJ2YWJsZTxBc3luY1NlbGVjdGlvbkNoYW5nZTxUPj4ge1xuICAgIHJldHVybiB0aGlzLl9jaGFuZ2VkLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgZ2V0IGxlbmd0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9sZW5ndGg7XG4gIH1cblxuICBwcm90ZWN0ZWQgX2NvbXBhcmVGdW5jOiAoYTogVCwgYjogVCkgPT4gYm9vbGVhbiA9IChhLCBiKSA9PiBhID09PSBiO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGxlbmd0aDogbnVtYmVyLFxuICAgIHByb3RlY3RlZCBfbXVsdGlwbGUgPSBmYWxzZSxcbiAgICBjb21wYXJlRnVuYzogKGE6IFQsIGI6IFQpID0+IGJvb2xlYW4gPSAoYSwgYikgPT4gYSA9PT0gYixcbiAgICBpbml0aWFsbHlTZWxlY3RlZFZhbHVlcz86IFRbXSxcbiAgICBpbml0aWFsbHlEZXNlbGVjdGVkVmFsdWVzPzogVFtdLFxuICAgIHByb3RlY3RlZCBfZW1pdENoYW5nZXMgPSB0cnVlLFxuICApIHtcbiAgICB0aGlzLl9sZW5ndGggPSBsZW5ndGg7XG5cbiAgICBpZiAoaW5pdGlhbGx5U2VsZWN0ZWRWYWx1ZXMgJiYgaW5pdGlhbGx5U2VsZWN0ZWRWYWx1ZXMubGVuZ3RoKSB7XG4gICAgICBpZiAoX211bHRpcGxlKSB7XG4gICAgICAgIGluaXRpYWxseVNlbGVjdGVkVmFsdWVzLmZvckVhY2goKHZhbHVlKSA9PiB0aGlzLl9tYXJrU2VsZWN0ZWQodmFsdWUpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX21hcmtTZWxlY3RlZChpbml0aWFsbHlTZWxlY3RlZFZhbHVlc1swXSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX2FkZGVkVG9FbWl0Lmxlbmd0aCA9IDA7XG4gICAgfVxuXG4gICAgaWYgKGluaXRpYWxseURlc2VsZWN0ZWRWYWx1ZXMgJiYgaW5pdGlhbGx5RGVzZWxlY3RlZFZhbHVlcy5sZW5ndGgpIHtcbiAgICAgIGluaXRpYWxseURlc2VsZWN0ZWRWYWx1ZXMuZm9yRWFjaCgodmFsdWUpID0+IHRoaXMuX21hcmtEZXNlbGVjdGVkKHZhbHVlKSk7XG4gICAgICB0aGlzLl9yZW1vdmVkVG9FbWl0Lmxlbmd0aCA9IDA7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBjb21wYXJlRnVuYyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5fY29tcGFyZUZ1bmMgPSBjb21wYXJlRnVuYztcbiAgICB9XG4gIH1cblxuICB1cGRhdGVMZW5ndGgobGVuZ3RoOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLl9sZW5ndGggPSBsZW5ndGg7XG4gICAgdGhpcy5fY2hlY2tJZkFsbFNlbGVjdGVkKCk7XG4gIH1cblxuICBpc0FsbFNlbGVjdGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9pc0FsbFNlbGVjdGVkIHx8IHRoaXMuX2xlbmd0aCA9PT0gMDtcbiAgfVxuXG4gIGdldEFsbFNlbGVjdGVkVHlwZSgpOiBBbGxTZWxlY3RlZFR5cGUge1xuICAgIGlmICh0aGlzLmlzQWxsU2VsZWN0ZWQoKSAmJiB0aGlzLl9kZXNlbGVjdGVkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuICdhbGwnO1xuICAgIH0gZWxzZSBpZiAoIXRoaXMuaXNBbGxTZWxlY3RlZCgpICYmIHRoaXMuX3NlbGVjdGVkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuICdub25lJztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuICdwYXJ0aWFsJztcbiAgICB9XG4gIH1cblxuICBzZWxlY3RBbGwoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX2xlbmd0aCA+IDEgJiYgIXRoaXMuX211bHRpcGxlKSB7XG4gICAgICB0aHJvdyBnZXRNdWx0aXBsZVZhbHVlc0luU2luZ2xlU2VsZWN0aW9uRXJyb3IoKTtcbiAgICB9XG5cbiAgICB0aGlzLl9pc0FsbFNlbGVjdGVkID0gdHJ1ZTtcbiAgICB0aGlzLl9kZXNlbGVjdGVkID0gW107XG4gICAgdGhpcy5fcmVtb3ZlZFRvRW1pdCA9IFtdO1xuICAgIHRoaXMuX3NlbGVjdGVkID0gW107XG4gICAgdGhpcy5fYWRkZWRUb0VtaXQgPSBbXTtcbiAgICB0aGlzLl9lbWl0Q2hhbmdlRXZlbnQoKTtcbiAgfVxuXG4gIGRlc2VsZWN0QWxsKCk6IHZvaWQge1xuICAgIHRoaXMuX2lzQWxsU2VsZWN0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLl9kZXNlbGVjdGVkID0gW107XG4gICAgdGhpcy5fcmVtb3ZlZFRvRW1pdCA9IFtdO1xuICAgIHRoaXMuX3NlbGVjdGVkID0gW107XG4gICAgdGhpcy5fYWRkZWRUb0VtaXQgPSBbXTtcbiAgICB0aGlzLl9lbWl0Q2hhbmdlRXZlbnQoKTtcbiAgfVxuXG4gIHRvZ2dsZUFsbCgpOiB2b2lkIHtcbiAgICB0aGlzLmlzQWxsU2VsZWN0ZWQoKSA/IHRoaXMuZGVzZWxlY3RBbGwoKSA6IHRoaXMuc2VsZWN0QWxsKCk7XG4gIH1cblxuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLl9pc0FsbFNlbGVjdGVkID0gZmFsc2U7XG4gICAgdGhpcy5fZGVzZWxlY3RlZCA9IFtdO1xuICAgIHRoaXMuX3JlbW92ZWRUb0VtaXQgPSBbXTtcbiAgICB0aGlzLl9zZWxlY3RlZCA9IFtdO1xuICAgIHRoaXMuX2FkZGVkVG9FbWl0ID0gW107XG4gICAgdGhpcy5fZW1pdENoYW5nZUV2ZW50KCk7XG4gIH1cblxuICBzZWxlY3QoLi4udmFsdWVzOiBUW10pOiB2b2lkIHtcbiAgICB0aGlzLl92ZXJpZnlWYWx1ZUFzc2lnbm1lbnQodmFsdWVzKTtcbiAgICB2YWx1ZXMuZm9yRWFjaCgodmFsdWUpID0+IHRoaXMuX21hcmtTZWxlY3RlZCh2YWx1ZSkpO1xuICAgIHRoaXMuX2NoZWNrSWZBbGxTZWxlY3RlZCgpO1xuICAgIHRoaXMuX2VtaXRDaGFuZ2VFdmVudCgpO1xuICB9XG5cbiAgZGVzZWxlY3QoLi4udmFsdWVzOiBUW10pOiB2b2lkIHtcbiAgICB0aGlzLl92ZXJpZnlWYWx1ZUFzc2lnbm1lbnQodmFsdWVzKTtcbiAgICB2YWx1ZXMuZm9yRWFjaCgodmFsdWUpID0+IHRoaXMuX21hcmtEZXNlbGVjdGVkKHZhbHVlKSk7XG4gICAgdGhpcy5fY2hlY2tJZkFsbFNlbGVjdGVkKCk7XG4gICAgdGhpcy5fZW1pdENoYW5nZUV2ZW50KCk7XG4gIH1cblxuICB0b2dnbGUodmFsdWU6IFQpOiB2b2lkIHtcbiAgICB0aGlzLmlzU2VsZWN0ZWQodmFsdWUpID8gdGhpcy5kZXNlbGVjdCh2YWx1ZSkgOiB0aGlzLnNlbGVjdCh2YWx1ZSk7XG4gIH1cblxuICBpc1NlbGVjdGVkKHZhbHVlOiBUKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNBbGxTZWxlY3RlZCgpXG4gICAgICA/ICF0aGlzLl9kZXNlbGVjdGVkLnNvbWUoKHYpID0+IHRoaXMuX2NvbXBhcmVGdW5jKHYsIHZhbHVlKSlcbiAgICAgIDogdGhpcy5fc2VsZWN0ZWQuc29tZSgodikgPT4gdGhpcy5fY29tcGFyZUZ1bmModiwgdmFsdWUpKTtcbiAgfVxuXG4gIGlzRGVzZWxlY3RlZCh2YWx1ZTogVCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhdGhpcy5pc1NlbGVjdGVkKHZhbHVlKTtcbiAgfVxuXG4gIGlzRW1wdHkoKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMuX2xlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIChcbiAgICAgICghdGhpcy5pc0FsbFNlbGVjdGVkKCkgJiYgdGhpcy5fc2VsZWN0ZWQubGVuZ3RoID09PSAwKSB8fFxuICAgICAgKHRoaXMuaXNBbGxTZWxlY3RlZCgpICYmIHRoaXMuX2Rlc2VsZWN0ZWQubGVuZ3RoID09PSB0aGlzLl9sZW5ndGgpXG4gICAgKTtcbiAgfVxuXG4gIGhhc1ZhbHVlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhdGhpcy5pc0VtcHR5KCk7XG4gIH1cblxuICBzb3J0KHByZWRpY2F0ZT86IChhOiBULCBiOiBUKSA9PiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fbXVsdGlwbGUpIHtcbiAgICAgIGlmICh0aGlzLl9zZWxlY3RlZCkge1xuICAgICAgICB0aGlzLl9zZWxlY3RlZC5zb3J0KHByZWRpY2F0ZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX2Rlc2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMuX2Rlc2VsZWN0ZWQuc29ydChwcmVkaWNhdGUpO1xuICAgIH1cbiAgfVxuXG4gIGlzTXVsdGlwbGVTZWxlY3Rpb24oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX211bHRpcGxlO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9lbWl0Q2hhbmdlRXZlbnQoKTogdm9pZCB7XG4gICAgdGhpcy5fY2hhbmdlZC5uZXh0KHtcbiAgICAgIHNvdXJjZTogdGhpcyxcbiAgICAgIGlzQWxsU2VsZWN0ZWQ6IHRoaXMuaXNBbGxTZWxlY3RlZCgpLFxuICAgICAgYWxsU2VsZWN0ZWRUeXBlOiB0aGlzLmdldEFsbFNlbGVjdGVkVHlwZSgpLFxuICAgICAgYWRkZWQ6IHRoaXMuX2FkZGVkVG9FbWl0LFxuICAgICAgcmVtb3ZlZDogdGhpcy5fcmVtb3ZlZFRvRW1pdCxcbiAgICB9KTtcblxuICAgIHRoaXMuX3JlbW92ZWRUb0VtaXQgPSBbXTtcbiAgICB0aGlzLl9hZGRlZFRvRW1pdCA9IFtdO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9tYXJrU2VsZWN0ZWQodmFsdWU6IFQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc0Rlc2VsZWN0ZWQodmFsdWUpKSB7XG4gICAgICB0aGlzLl91bm1hcmtEZXNlbGVjdGVkKHZhbHVlKTtcblxuICAgICAgaWYgKCF0aGlzLl9tdWx0aXBsZSkge1xuICAgICAgICB0aGlzLl91bm1hcmtBbGwoKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fc2VsZWN0ZWQucHVzaCh2YWx1ZSk7XG5cbiAgICAgIGlmICh0aGlzLl9lbWl0Q2hhbmdlcykge1xuICAgICAgICB0aGlzLnB1c2hJZk5vdEV4aXN0cyh0aGlzLl9hZGRlZFRvRW1pdCwgdmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBfdW5tYXJrU2VsZWN0ZWQodmFsdWU6IFQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc1NlbGVjdGVkKHZhbHVlKSkge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLl9zZWxlY3RlZC5maW5kSW5kZXgoKHYpID0+XG4gICAgICAgIHRoaXMuX2NvbXBhcmVGdW5jKHYsIHZhbHVlKSxcbiAgICAgICk7XG5cbiAgICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICAgIHRoaXMuX3NlbGVjdGVkLnNwbGljZShpbmRleCwgMSk7XG5cbiAgICAgICAgaWYgKHRoaXMuX2VtaXRDaGFuZ2VzKSB7XG4gICAgICAgICAgdGhpcy5wdXNoSWZOb3RFeGlzdHModGhpcy5fcmVtb3ZlZFRvRW1pdCwgdmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIF9tYXJrRGVzZWxlY3RlZCh2YWx1ZTogVCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmlzU2VsZWN0ZWQodmFsdWUpKSB7XG4gICAgICB0aGlzLl91bm1hcmtTZWxlY3RlZCh2YWx1ZSk7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuX2Rlc2VsZWN0ZWQuZmluZEluZGV4KCh2KSA9PlxuICAgICAgICB0aGlzLl9jb21wYXJlRnVuYyh2LCB2YWx1ZSksXG4gICAgICApO1xuXG4gICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgIHRoaXMuX2Rlc2VsZWN0ZWQucHVzaCh2YWx1ZSk7XG5cbiAgICAgICAgaWYgKHRoaXMuX2VtaXRDaGFuZ2VzKSB7XG4gICAgICAgICAgdGhpcy5wdXNoSWZOb3RFeGlzdHModGhpcy5fcmVtb3ZlZFRvRW1pdCwgdmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIF91bm1hcmtEZXNlbGVjdGVkKHZhbHVlOiBUKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNEZXNlbGVjdGVkKHZhbHVlKSkge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLl9kZXNlbGVjdGVkLmZpbmRJbmRleCgodikgPT5cbiAgICAgICAgdGhpcy5fY29tcGFyZUZ1bmModiwgdmFsdWUpLFxuICAgICAgKTtcblxuICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgdGhpcy5fZGVzZWxlY3RlZC5zcGxpY2UoaW5kZXgsIDEpO1xuXG4gICAgICAgIGlmICh0aGlzLl9lbWl0Q2hhbmdlcykge1xuICAgICAgICAgIHRoaXMucHVzaElmTm90RXhpc3RzKHRoaXMuX2FkZGVkVG9FbWl0LCB2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VubWFya0FsbCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaXNFbXB0eSgpKSB7XG4gICAgICB0aGlzLl9zZWxlY3RlZC5mb3JFYWNoKCh2YWx1ZSkgPT4gdGhpcy5fdW5tYXJrU2VsZWN0ZWQodmFsdWUpKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX3ZlcmlmeVZhbHVlQXNzaWdubWVudCh2YWx1ZXM6IFRbXSk6IHZvaWQge1xuICAgIGlmICh2YWx1ZXMubGVuZ3RoID4gMSAmJiAhdGhpcy5fbXVsdGlwbGUpIHtcbiAgICAgIHRocm93IGdldE11bHRpcGxlVmFsdWVzSW5TaW5nbGVTZWxlY3Rpb25FcnJvcigpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBfY2hlY2tJZkFsbFNlbGVjdGVkKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9sZW5ndGggPT09IHRoaXMuX3NlbGVjdGVkLmxlbmd0aCkge1xuICAgICAgdGhpcy5faXNBbGxTZWxlY3RlZCA9IHRydWU7XG4gICAgICB0aGlzLl9yZW1vdmVkVG9FbWl0ID0gdGhpcy5fZGVzZWxlY3RlZDtcbiAgICAgIHRoaXMuX2Rlc2VsZWN0ZWQgPSBbXTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuX2xlbmd0aCA9PT0gdGhpcy5fZGVzZWxlY3RlZC5sZW5ndGgpIHtcbiAgICAgIHRoaXMuX2lzQWxsU2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuX2FkZGVkVG9FbWl0ID0gW107XG4gICAgICB0aGlzLl9zZWxlY3RlZCA9IFtdO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBwdXNoSWZOb3RFeGlzdHMoYXJyYXk6IFRbXSwgdmFsdWU6IFQpOiB2b2lkIHtcbiAgICBpZiAoYXJyYXkuZXZlcnkoKHYpID0+ICF0aGlzLl9jb21wYXJlRnVuYyh2LCB2YWx1ZSkpKSB7XG4gICAgICBhcnJheS5wdXNoKHZhbHVlKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBBc3luY1NlbGVjdGlvbkNoYW5nZTxUPiB7XG4gIHNvdXJjZTogQXN5bmNTZWxlY3Rpb25Nb2RlbDxUPjtcbiAgaXNBbGxTZWxlY3RlZDogYm9vbGVhbjtcbiAgYWxsU2VsZWN0ZWRUeXBlOiBBbGxTZWxlY3RlZFR5cGU7XG4gIGFkZGVkOiBUW107XG4gIHJlbW92ZWQ6IFRbXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE11bHRpcGxlVmFsdWVzSW5TaW5nbGVTZWxlY3Rpb25FcnJvcigpOiBFcnJvciB7XG4gIHJldHVybiBFcnJvcihcbiAgICAnQ2Fubm90IHBhc3MgbXVsdGlwbGUgdmFsdWVzIGludG8gQXN5bmNTZWxlY3Rpb25Nb2RlbCB3aXRoIHNpbmdsZS12YWx1ZSBtb2RlLicsXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0VxdWFsPFQ+KC4uLnByb3BlcnR5OiAoa2V5b2YgVClbXSk6IChhOiBULCBiOiBUKSA9PiBib29sZWFuIHtcbiAgaWYgKCFwcm9wZXJ0eSB8fCAoQXJyYXkuaXNBcnJheShwcm9wZXJ0eSkgJiYgcHJvcGVydHkubGVuZ3RoID09PSAwKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignUHJvcGVydHkgbmVlZHMgdG8gYmUgZGVmaW5lZCB0byBjb21wYXJlIGZ1bmN0aW9uJyk7XG4gIH1cblxuICByZXR1cm4gKGE6IFQsIGI6IFQpID0+IHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BlcnR5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoYVtwcm9wZXJ0eVtpXV0gPT09IGJbcHJvcGVydHlbaV1dKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG59XG4iXX0=