import { booleanAttribute, ChangeDetectionStrategy, ChangeDetectorRef, Component, ContentChildren, DestroyRef, ElementRef, HostBinding, inject, Input, QueryList, ViewChild, } from '@angular/core';
import { RdsFileUploader } from './uploader';
import { RdsUploadIntlService } from './rds-upload-intl.service';
import { filter, startWith } from 'rxjs/operators';
import { NgControl, } from '@angular/forms';
import { noop } from 'rxjs';
import { RdsUploadErrorDirective } from './upload-error.directive';
import { HttpClient } from '@angular/common/http';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import * as i0 from "@angular/core";
import * as i1 from "../icons/icon.component";
import * as i2 from "../button/button.component";
import * as i3 from "./upload.directive";
import * as i4 from "./upload-drop-zone.directive";
import * as i5 from "./upload-list-item/upload-list-item.component";
import * as i6 from "@angular/common";
let nextId = 0;
export class RdsUploadComponent {
    get hasError() {
        return !!(this.ngControl && this.ngControl.errors);
    }
    set uploader(uploader) {
        this._uploader = uploader;
        if (!this._uploader.isHttpClientRegistered()) {
            this._uploader.registerHttpClient(this.httpClient);
        }
    }
    get uploader() {
        return this._uploader;
    }
    get class() {
        return [`rds-upload-size-${this.size}`];
    }
    constructor() {
        this.intl = inject(RdsUploadIntlService);
        this.cdr = inject(ChangeDetectorRef);
        this.destroyRef = inject(DestroyRef);
        this.httpClient = inject(HttpClient);
        this.ngControl = inject(NgControl, {
            self: true,
            optional: true,
        });
        this.ariaErrorMessage = null;
        this.onChange = noop;
        this.onTouched = noop;
        this.size = 'm';
        this.hasBackground = false;
        this.hasDropZone = false;
        this.disabled = false;
        // can be used to transform/filter the files before they get added to the queue
        this.beforeAddFn = (files) => files;
        if (this.ngControl != null) {
            // Setting the value accessor directly (instead of using
            // the providers) to avoid running into a circular import.
            this.ngControl.valueAccessor = this;
        }
    }
    ngOnInit() {
        this.uploader.config$
            .pipe(takeUntilDestroyed(this.destroyRef))
            .subscribe(() => this.cdr.markForCheck());
        this.uploader.queue$
            .pipe(takeUntilDestroyed(this.destroyRef))
            .subscribe((v) => this.onChange(v));
        if (this.ngControl) {
            // Setting the validator directly (instead of using
            // the providers) to avoid running into a circular import.
            this.ngControl.control?.addValidators((control) => this.validate(control));
            this.ngControl.statusChanges
                ?.pipe(filter((status) => status === 'VALID' && !!this.uploader.config.autoUpload), takeUntilDestroyed(this.destroyRef))
                .subscribe(() => this.uploader.uploadAll());
        }
    }
    ngAfterContentInit() {
        this.errors.changes
            .pipe(startWith(this.errors), takeUntilDestroyed(this.destroyRef))
            .subscribe((errors) => this.setupErrors(errors));
    }
    ngOnDestroy() {
        this.uploader?.destroy();
    }
    onFilesSelected(files) {
        this.onTouched();
        this.uploader.addToQueue(this.beforeAddFn(files), [], !!this.ngControl);
    }
    writeValue(files) {
        this.uploader.addToQueue(files);
    }
    registerOnChange(onChange) {
        this.onChange = onChange;
    }
    registerOnTouched(onTouched) {
        this.onTouched = onTouched;
    }
    setDisabledState(disabled) {
        if (this.disabled !== disabled) {
            this.disabled = disabled;
            this.cdr.markForCheck();
        }
    }
    validate(control) {
        if (!control.value) {
            return null;
        }
        const errors = control.value.reduce((acc, curr) => {
            if (!curr.hasFailedFilters) {
                return acc;
            }
            curr.failedFilters.forEach((failedFilter) => {
                if (acc[failedFilter.name]) {
                    acc[failedFilter.name].push(curr.file.name);
                }
                else {
                    acc[failedFilter.name] = [curr.file.name];
                }
            });
            return acc;
        }, {});
        if (Object.keys(errors).length > 0) {
            return errors;
        }
        return null;
    }
    openDialog() {
        this.fileInput?.nativeElement.click();
    }
    setupErrors(errors) {
        const errorMessageIds = [];
        errors.forEach((err) => {
            const id = `rds-upload-error-${nextId++}`;
            err.setId(id);
            errorMessageIds.push(id);
        });
        this.ariaErrorMessage = errorMessageIds.length
            ? errorMessageIds.join(',')
            : null;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsUploadComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "17.3.1", type: RdsUploadComponent, selector: "rds-upload", inputs: { size: "size", hasBackground: ["hasBackground", "hasBackground", booleanAttribute], uploader: "uploader", hasDropZone: ["hasDropZone", "hasDropZone", booleanAttribute], disabled: ["disabled", "disabled", booleanAttribute], beforeAddFn: "beforeAddFn" }, host: { properties: { "class": "this.class" } }, queries: [{ propertyName: "errors", predicate: RdsUploadErrorDirective }], viewQueries: [{ propertyName: "fileInput", first: true, predicate: ["fileInput"], descendants: true }], exportAs: ["rdsUpload"], ngImport: i0, template: "@if (intl.change$ | async; as t) {\n  @if (hasDropZone) {\n    <button\n      rds-upload-drop-zone\n      [disabled]=\"disabled\"\n      (click)=\"openDialog()\"\n      (fileDropped)=\"onFilesSelected($event)\"\n      [attr.aria-errormessage]=\"ariaErrorMessage\"\n    >\n      <rds-icon namespace=\"outlined\" icon=\"upload\" />\n      <strong>{{ t.dropZoneChooseFiles }}</strong>\n      {{ t.dropZoneOrDropFiles }}\n    </button>\n  } @else {\n    <button\n      rds-secondary-button\n      class=\"rds-upload-simple-button\"\n      [size]=\"size\"\n      [disabled]=\"disabled\"\n      (click)=\"openDialog()\"\n      [attr.aria-errormessage]=\"ariaErrorMessage\"\n    >\n      <rds-icon namespace=\"outlined\" icon=\"upload\" />\n      {{ t.chooseFilesButtonLabel }}\n    </button>\n  }\n  <div class=\"rds-upload-error-container\">\n    <ng-content\n      select=\"rds-upload-error, [rds-upload-error], [rdsUploadError]\"\n    />\n  </div>\n  <input\n    #fileInput\n    rds-upload\n    [config]=\"uploader.config\"\n    (fileSelected)=\"onFilesSelected($event)\"\n  />\n  <ul\n    [class.rds-upload-item-with-background]=\"hasBackground\"\n    [attr.aria-label]=\"t.uploadListAriaLabel\"\n  >\n    @for (item of uploader.queue; track item) {\n      <li\n        rds-upload-list-item\n        [disabled]=\"disabled\"\n        [size]=\"size\"\n        [fileItem]=\"item\"\n        (remove)=\"uploader.removeFromQueue($event)\"\n        (upload)=\"uploader.uploadItem($event)\"\n      ></li>\n    }\n  </ul>\n  @if (!uploader.config.autoUpload && uploader.queue.length) {\n    <button\n      rds-primary-button\n      [size]=\"size\"\n      [disabled]=\"uploader.isUploading || disabled || hasError\"\n      (click)=\"uploader.uploadAll()\"\n    >\n      {{ t.startUploadButtonLabel }}\n    </button>\n  }\n}\n", styles: [":host{display:block}:host.rds-upload-size-s [rds-upload-drop-zone]{font-size:14px;font-weight:200;line-height:20px;text-transform:none;letter-spacing:.3px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:16px 32px}:host.rds-upload-size-s [rds-upload-drop-zone] strong{font-size:14px;font-weight:400;line-height:20px;text-transform:none;letter-spacing:.3px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host.rds-upload-size-s li+li{margin-top:8px}:host.rds-upload-size-s ul.rds-upload-item-with-background li{padding:8px}:host.rds-upload-size-s ul.rds-upload-item-with-background li+li{margin-top:4px}:host.rds-upload-size-m [rds-upload-drop-zone]{font-size:16px;font-weight:200;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:24px 32px}:host.rds-upload-size-m [rds-upload-drop-zone] strong{font-size:16px;font-weight:400;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host.rds-upload-size-m li+li{margin-top:16px}:host.rds-upload-size-m ul.rds-upload-item-with-background li{padding:12px}:host.rds-upload-size-m ul.rds-upload-item-with-background li+li{margin-top:4px}:host.rds-upload-size-l [rds-upload-drop-zone]{font-size:18px;font-weight:200;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:32px}:host.rds-upload-size-l [rds-upload-drop-zone] strong{font-size:18px;font-weight:400;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host.rds-upload-size-l li+li{margin-top:24px}:host.rds-upload-size-l ul.rds-upload-item-with-background li{padding:16px}:host.rds-upload-size-l ul.rds-upload-item-with-background li+li{margin-top:8px}:host [rds-upload-drop-zone]{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;cursor:pointer;background-color:var(--rds-color-bg-base-1);border:1px dashed var(--rds-color-grey-2);border-radius:2px;color:var(--rds-color-high-contrast)}:host [rds-upload-drop-zone] rds-icon{height:18px;width:18px}:host [rds-upload-drop-zone] rds-icon,:host [rds-upload-drop-zone] strong{color:var(--rds-color-informative);pointer-events:none}:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled).rds-upload-drop-zone-dragover,:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled):hover{border-color:var(--rds-color-bg-informative-hover)}:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled).rds-upload-drop-zone-dragover rds-icon,:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled).rds-upload-drop-zone-dragover strong,:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled):hover rds-icon,:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled):hover strong{color:var(--rds-color-bg-informative-hover)}:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled):focus-visible{outline:2px solid var(--rds-color-stroke-active-focus)}:host.ng-invalid:not(.ng-untouched) [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled,[disabled]),:host.ng-invalid:not(.ng-untouched) .rds-upload-simple-button:not(.rds-upload-drop-zone-disabled,[disabled]){border-color:var(--rds-color-error);color:var(--rds-color-error)}:host.ng-invalid:not(.ng-untouched) [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled,[disabled]) rds-icon,:host.ng-invalid:not(.ng-untouched) [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled,[disabled]) strong,:host.ng-invalid:not(.ng-untouched) .rds-upload-simple-button:not(.rds-upload-drop-zone-disabled,[disabled]) rds-icon,:host.ng-invalid:not(.ng-untouched) .rds-upload-simple-button:not(.rds-upload-drop-zone-disabled,[disabled]) strong{color:inherit}:host .rds-upload-drop-zone-disabled,:host button[disabled]{border-color:var(--rds-color-stroke-enabled);background-color:var(--rds-color-bg-disabled);color:var(--rds-color-disabled);cursor:not-allowed}:host .rds-upload-drop-zone-disabled rds-icon,:host .rds-upload-drop-zone-disabled strong,:host button[disabled] rds-icon,:host button[disabled] strong{color:inherit}:host ul{list-style-type:none;margin-top:24px;padding-left:0}:host ul>li:before{display:none}:host ul.rds-upload-item-with-background li{background-color:var(--rds-color-bg-disabled)}:host ul+button{display:flex;margin-top:24px;margin-left:auto}:host .rds-upload-error-container{font-size:12px;font-weight:400;line-height:16px;text-transform:none;letter-spacing:.5px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;margin-top:8px;color:var(--rds-color-error)}\n"], dependencies: [{ kind: "component", type: i1.RdsIconComponent, selector: "rds-icon", inputs: ["namespace", "icon"] }, { kind: "component", type: i2.RdsButtonComponent, selector: "\n    button[rds-primary-button],\n    button[rds-warning-button],\n    button[rds-secondary-button],\n    button[rds-secondary-warning-button],\n    button[rdsPrimaryButton],\n    button[rdsWarningButton],\n    button[rdsSecondaryButton],\n    button[rdsSecondaryWarningButton],\n  " }, { kind: "directive", type: i3.RdsUploadDirective, selector: "input[rds-upload], input[rdsUpload]", inputs: ["config"], outputs: ["fileSelected"] }, { kind: "directive", type: i4.RdsUploadDropZoneDirective, selector: "[rds-upload-drop-zone], [rdsUploadDropZone]", inputs: ["disabled"], outputs: ["fileOver", "fileDropped"] }, { kind: "component", type: i5.RdsUploadListItemComponent, selector: "li[rds-upload-list-item], li[rdsUploadListItem]", inputs: ["fileItem", "disabled", "size"], outputs: ["upload", "remove"] }, { kind: "pipe", type: i6.AsyncPipe, name: "async" }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsUploadComponent, decorators: [{
            type: Component,
            args: [{ selector: 'rds-upload', exportAs: 'rdsUpload', changeDetection: ChangeDetectionStrategy.OnPush, template: "@if (intl.change$ | async; as t) {\n  @if (hasDropZone) {\n    <button\n      rds-upload-drop-zone\n      [disabled]=\"disabled\"\n      (click)=\"openDialog()\"\n      (fileDropped)=\"onFilesSelected($event)\"\n      [attr.aria-errormessage]=\"ariaErrorMessage\"\n    >\n      <rds-icon namespace=\"outlined\" icon=\"upload\" />\n      <strong>{{ t.dropZoneChooseFiles }}</strong>\n      {{ t.dropZoneOrDropFiles }}\n    </button>\n  } @else {\n    <button\n      rds-secondary-button\n      class=\"rds-upload-simple-button\"\n      [size]=\"size\"\n      [disabled]=\"disabled\"\n      (click)=\"openDialog()\"\n      [attr.aria-errormessage]=\"ariaErrorMessage\"\n    >\n      <rds-icon namespace=\"outlined\" icon=\"upload\" />\n      {{ t.chooseFilesButtonLabel }}\n    </button>\n  }\n  <div class=\"rds-upload-error-container\">\n    <ng-content\n      select=\"rds-upload-error, [rds-upload-error], [rdsUploadError]\"\n    />\n  </div>\n  <input\n    #fileInput\n    rds-upload\n    [config]=\"uploader.config\"\n    (fileSelected)=\"onFilesSelected($event)\"\n  />\n  <ul\n    [class.rds-upload-item-with-background]=\"hasBackground\"\n    [attr.aria-label]=\"t.uploadListAriaLabel\"\n  >\n    @for (item of uploader.queue; track item) {\n      <li\n        rds-upload-list-item\n        [disabled]=\"disabled\"\n        [size]=\"size\"\n        [fileItem]=\"item\"\n        (remove)=\"uploader.removeFromQueue($event)\"\n        (upload)=\"uploader.uploadItem($event)\"\n      ></li>\n    }\n  </ul>\n  @if (!uploader.config.autoUpload && uploader.queue.length) {\n    <button\n      rds-primary-button\n      [size]=\"size\"\n      [disabled]=\"uploader.isUploading || disabled || hasError\"\n      (click)=\"uploader.uploadAll()\"\n    >\n      {{ t.startUploadButtonLabel }}\n    </button>\n  }\n}\n", styles: [":host{display:block}:host.rds-upload-size-s [rds-upload-drop-zone]{font-size:14px;font-weight:200;line-height:20px;text-transform:none;letter-spacing:.3px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:16px 32px}:host.rds-upload-size-s [rds-upload-drop-zone] strong{font-size:14px;font-weight:400;line-height:20px;text-transform:none;letter-spacing:.3px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host.rds-upload-size-s li+li{margin-top:8px}:host.rds-upload-size-s ul.rds-upload-item-with-background li{padding:8px}:host.rds-upload-size-s ul.rds-upload-item-with-background li+li{margin-top:4px}:host.rds-upload-size-m [rds-upload-drop-zone]{font-size:16px;font-weight:200;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:24px 32px}:host.rds-upload-size-m [rds-upload-drop-zone] strong{font-size:16px;font-weight:400;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host.rds-upload-size-m li+li{margin-top:16px}:host.rds-upload-size-m ul.rds-upload-item-with-background li{padding:12px}:host.rds-upload-size-m ul.rds-upload-item-with-background li+li{margin-top:4px}:host.rds-upload-size-l [rds-upload-drop-zone]{font-size:18px;font-weight:200;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:32px}:host.rds-upload-size-l [rds-upload-drop-zone] strong{font-size:18px;font-weight:400;line-height:24px;text-transform:none;letter-spacing:.2px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host.rds-upload-size-l li+li{margin-top:24px}:host.rds-upload-size-l ul.rds-upload-item-with-background li{padding:16px}:host.rds-upload-size-l ul.rds-upload-item-with-background li+li{margin-top:8px}:host [rds-upload-drop-zone]{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;cursor:pointer;background-color:var(--rds-color-bg-base-1);border:1px dashed var(--rds-color-grey-2);border-radius:2px;color:var(--rds-color-high-contrast)}:host [rds-upload-drop-zone] rds-icon{height:18px;width:18px}:host [rds-upload-drop-zone] rds-icon,:host [rds-upload-drop-zone] strong{color:var(--rds-color-informative);pointer-events:none}:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled).rds-upload-drop-zone-dragover,:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled):hover{border-color:var(--rds-color-bg-informative-hover)}:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled).rds-upload-drop-zone-dragover rds-icon,:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled).rds-upload-drop-zone-dragover strong,:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled):hover rds-icon,:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled):hover strong{color:var(--rds-color-bg-informative-hover)}:host [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled):focus-visible{outline:2px solid var(--rds-color-stroke-active-focus)}:host.ng-invalid:not(.ng-untouched) [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled,[disabled]),:host.ng-invalid:not(.ng-untouched) .rds-upload-simple-button:not(.rds-upload-drop-zone-disabled,[disabled]){border-color:var(--rds-color-error);color:var(--rds-color-error)}:host.ng-invalid:not(.ng-untouched) [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled,[disabled]) rds-icon,:host.ng-invalid:not(.ng-untouched) [rds-upload-drop-zone]:not(.rds-upload-drop-zone-disabled,[disabled]) strong,:host.ng-invalid:not(.ng-untouched) .rds-upload-simple-button:not(.rds-upload-drop-zone-disabled,[disabled]) rds-icon,:host.ng-invalid:not(.ng-untouched) .rds-upload-simple-button:not(.rds-upload-drop-zone-disabled,[disabled]) strong{color:inherit}:host .rds-upload-drop-zone-disabled,:host button[disabled]{border-color:var(--rds-color-stroke-enabled);background-color:var(--rds-color-bg-disabled);color:var(--rds-color-disabled);cursor:not-allowed}:host .rds-upload-drop-zone-disabled rds-icon,:host .rds-upload-drop-zone-disabled strong,:host button[disabled] rds-icon,:host button[disabled] strong{color:inherit}:host ul{list-style-type:none;margin-top:24px;padding-left:0}:host ul>li:before{display:none}:host ul.rds-upload-item-with-background li{background-color:var(--rds-color-bg-disabled)}:host ul+button{display:flex;margin-top:24px;margin-left:auto}:host .rds-upload-error-container{font-size:12px;font-weight:400;line-height:16px;text-transform:none;letter-spacing:.5px;font-family:roche-sans;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;margin-top:8px;color:var(--rds-color-error)}\n"] }]
        }], ctorParameters: () => [], propDecorators: { size: [{
                type: Input
            }], hasBackground: [{
                type: Input,
                args: [{ transform: booleanAttribute }]
            }], uploader: [{
                type: Input
            }], hasDropZone: [{
                type: Input,
                args: [{ transform: booleanAttribute }]
            }], disabled: [{
                type: Input,
                args: [{ transform: booleanAttribute }]
            }], class: [{
                type: HostBinding,
                args: ['class']
            }], fileInput: [{
                type: ViewChild,
                args: ['fileInput']
            }], errors: [{
                type: ContentChildren,
                args: [RdsUploadErrorDirective]
            }], beforeAddFn: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvYW5ndWxhci1jb21wb25lbnRzL3NyYy9saWIvdXBsb2FkL3VwbG9hZC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItY29tcG9uZW50cy9zcmMvbGliL3VwbG9hZC91cGxvYWQuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLGdCQUFnQixFQUNoQix1QkFBdUIsRUFDdkIsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxlQUFlLEVBQ2YsVUFBVSxFQUNWLFVBQVUsRUFDVixXQUFXLEVBQ1gsTUFBTSxFQUNOLEtBQUssRUFHTCxTQUFTLEVBQ1QsU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDN0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuRCxPQUFPLEVBR0wsU0FBUyxHQUdWLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUU1QixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7Ozs7Ozs7O0FBRWhFLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQVNmLE1BQU0sT0FBTyxrQkFBa0I7SUF3QjdCLElBQUksUUFBUTtRQUNWLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMs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LEVBQUUsRUFBRTtZQUNyQixNQUFNLEVBQUUsR0FBRyxvQkFBb0IsTUFBTSxFQUFFLEVBQUUsQ0FBQztZQUMxQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2QsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxlQUFlLENBQUMsTUFBTTtZQUM1QyxDQUFDLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDM0IsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNYLENBQUM7OEdBOUtVLGtCQUFrQjtrR0FBbEIsa0JBQWtCLG9HQTZCVCxnQkFBZ0IscUVBZWhCLGdCQUFnQixzQ0FDaEIsZ0JBQWdCLGlJQVNuQix1QkFBdUIsOEpDakcxQyx1eERBK0RBOzsyRkRwQmEsa0JBQWtCO2tCQVA5QixTQUFTOytCQUNFLFlBQVksWUFDWixXQUFXLG1CQUdKLHVCQUF1QixDQUFDLE1BQU07d0RBOEJ0QyxJQUFJO3NCQUFaLEtBQUs7Z0JBQ2tDLGFBQWE7c0JBQXBELEtBQUs7dUJBQUMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUU7Z0JBR2xDLFFBQVE7c0JBRFgsS0FBSztnQkFha0MsV0FBVztzQkFBbEQsS0FBSzt1QkFBQyxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRTtnQkFDRSxRQUFRO3NCQUEvQyxLQUFLO3VCQUFDLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixFQUFFO2dCQUVaLEtBQUs7c0JBQTlCLFdBQVc7dUJBQUMsT0FBTztnQkFLcEIsU0FBUztzQkFEUixTQUFTO3VCQUFDLFdBQVc7Z0JBSXRCLE1BQU07c0JBREwsZUFBZTt1QkFBQyx1QkFBdUI7Z0JBS3hDLFdBQVc7c0JBRFYsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyQ29udGVudEluaXQsXG4gIGJvb2xlYW5BdHRyaWJ1dGUsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGRyZW4sXG4gIERlc3Ryb3lSZWYsXG4gIEVsZW1lbnRSZWYsXG4gIEhvc3RCaW5kaW5nLFxuICBpbmplY3QsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgUXVlcnlMaXN0LFxuICBWaWV3Q2hpbGQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUmRzVXBsb2FkU2l6ZSB9IGZyb20gJy4vdXBsb2FkLnR5cGVzJztcbmltcG9ydCB7IFJkc0ZpbGVVcGxvYWRlciB9IGZyb20gJy4vdXBsb2FkZXInO1xuaW1wb3J0IHsgUmRzVXBsb2FkSW50bFNlcnZpY2UgfSBmcm9tICcuL3Jkcy11cGxvYWQtaW50bC5zZXJ2aWNlJztcbmltcG9ydCB7IGZpbHRlciwgc3RhcnRXaXRoIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgQWJzdHJhY3RDb250cm9sLFxuICBDb250cm9sVmFsdWVBY2Nlc3NvcixcbiAgTmdDb250cm9sLFxuICBWYWxpZGF0aW9uRXJyb3JzLFxuICBWYWxpZGF0b3IsXG59IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IG5vb3AgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFJkc0ZpbGVJdGVtIH0gZnJvbSAnLi9maWxlLWl0ZW0uY2xhc3MnO1xuaW1wb3J0IHsgUmRzVXBsb2FkRXJyb3JEaXJlY3RpdmUgfSBmcm9tICcuL3VwbG9hZC1lcnJvci5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IHRha2VVbnRpbERlc3Ryb3llZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvcnhqcy1pbnRlcm9wJztcblxubGV0IG5leHRJZCA9IDA7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3Jkcy11cGxvYWQnLFxuICBleHBvcnRBczogJ3Jkc1VwbG9hZCcsXG4gIHRlbXBsYXRlVXJsOiAnLi91cGxvYWQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi91cGxvYWQuY29tcG9uZW50LnNjc3MnXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIFJkc1VwbG9hZENvbXBvbmVudDxUID0gdW5rbm93bj5cbiAgaW1wbGVtZW50c1xuICAgIE9uSW5pdCxcbiAgICBBZnRlckNvbnRlbnRJbml0LFxuICAgIE9uRGVzdHJveSxcbiAgICBDb250cm9sVmFsdWVBY2Nlc3NvcixcbiAgICBWYWxpZGF0b3JcbntcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGludGwgPSBpbmplY3QoUmRzVXBsb2FkSW50bFNlcnZpY2UpO1xuICBwcml2YXRlIHJlYWRvbmx5IGNkciA9IGluamVjdChDaGFuZ2VEZXRlY3RvclJlZik7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveVJlZiA9IGluamVjdChEZXN0cm95UmVmKTtcbiAgcHJpdmF0ZSByZWFkb25seSBodHRwQ2xpZW50ID0gaW5qZWN0KEh0dHBDbGllbnQpO1xuICBwcml2YXRlIHJlYWRvbmx5IG5nQ29udHJvbCA9IGluamVjdChOZ0NvbnRyb2wsIHtcbiAgICBzZWxmOiB0cnVlLFxuICAgIG9wdGlvbmFsOiB0cnVlLFxuICB9KTtcblxuICBwcml2YXRlIF91cGxvYWRlcjogUmRzRmlsZVVwbG9hZGVyPFQ+O1xuXG4gIGFyaWFFcnJvck1lc3NhZ2U6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuXG4gIG9uQ2hhbmdlOiAoZmlsZXM6IFJkc0ZpbGVJdGVtW10pID0+IHZvaWQgPSBub29wO1xuICBvblRvdWNoZWQgPSBub29wO1xuXG4gIGdldCBoYXNFcnJvcigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISEodGhpcy5uZ0NvbnRyb2wgJiYgdGhpcy5uZ0NvbnRyb2wuZXJyb3JzKTtcbiAgfVxuXG4gIEBJbnB1dCgpIHNpemU6IFJkc1VwbG9hZFNpemUgPSAnbSc7XG4gIEBJbnB1dCh7IHRyYW5zZm9ybTogYm9vbGVhbkF0dHJpYnV0ZSB9KSBoYXNCYWNrZ3JvdW5kID0gZmFsc2U7XG5cbiAgQElucHV0KClcbiAgc2V0IHVwbG9hZGVyKHVwbG9hZGVyOiBSZHNGaWxlVXBsb2FkZXI8VD4pIHtcbiAgICB0aGlzLl91cGxvYWRlciA9IHVwbG9hZGVyO1xuXG4gICAgaWYgKCF0aGlzLl91cGxvYWRlci5pc0h0dHBDbGllbnRSZWdpc3RlcmVkKCkpIHtcbiAgICAgIHRoaXMuX3VwbG9hZGVyLnJlZ2lzdGVySHR0cENsaWVudCh0aGlzLmh0dHBDbGllbnQpO1xuICAgIH1cbiAgfVxuXG4gIGdldCB1cGxvYWRlcigpOiBSZHNGaWxlVXBsb2FkZXI8VD4ge1xuICAgIHJldHVybiB0aGlzLl91cGxvYWRlcjtcbiAgfVxuXG4gIEBJbnB1dCh7IHRyYW5zZm9ybTogYm9vbGVhbkF0dHJpYnV0ZSB9KSBoYXNEcm9wWm9uZSA9IGZhbHNlO1xuICBASW5wdXQoeyB0cmFuc2Zvcm06IGJvb2xlYW5BdHRyaWJ1dGUgfSkgZGlzYWJsZWQgPSBmYWxzZTtcblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzJykgZ2V0IGNsYXNzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gW2ByZHMtdXBsb2FkLXNpemUtJHt0aGlzLnNpemV9YF07XG4gIH1cblxuICBAVmlld0NoaWxkKCdmaWxlSW5wdXQnKVxuICBmaWxlSW5wdXQ6IEVsZW1lbnRSZWY8SFRNTElucHV0RWxlbWVudD47XG5cbiAgQENvbnRlbnRDaGlsZHJlbihSZHNVcGxvYWRFcnJvckRpcmVjdGl2ZSlcbiAgZXJyb3JzOiBRdWVyeUxpc3Q8UmRzVXBsb2FkRXJyb3JEaXJlY3RpdmU+O1xuXG4gIC8vIGNhbiBiZSB1c2VkIHRvIHRyYW5zZm9ybS9maWx0ZXIgdGhlIGZpbGVzIGJlZm9yZSB0aGV5IGdldCBhZGRlZCB0byB0aGUgcXVldWVcbiAgQElucHV0KClcbiAgYmVmb3JlQWRkRm4gPSAoZmlsZXM6IEZpbGVbXSk6IEZpbGVbXSA9PiBmaWxlcztcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBpZiAodGhpcy5uZ0NvbnRyb2wgIT0gbnVsbCkge1xuICAgICAgLy8gU2V0dGluZyB0aGUgdmFsdWUgYWNjZXNzb3IgZGlyZWN0bHkgKGluc3RlYWQgb2YgdXNpbmdcbiAgICAgIC8vIHRoZSBwcm92aWRlcnMpIHRvIGF2b2lkIHJ1bm5pbmcgaW50byBhIGNpcmN1bGFyIGltcG9ydC5cbiAgICAgIHRoaXMubmdDb250cm9sLnZhbHVlQWNjZXNzb3IgPSB0aGlzO1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMudXBsb2FkZXIuY29uZmlnJFxuICAgICAgLnBpcGUodGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZikpXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpKTtcblxuICAgIHRoaXMudXBsb2FkZXIucXVldWUkXG4gICAgICAucGlwZSh0YWtlVW50aWxEZXN0cm95ZWQodGhpcy5kZXN0cm95UmVmKSlcbiAgICAgIC5zdWJzY3JpYmUoKHYpID0+IHRoaXMub25DaGFuZ2UodikpO1xuXG4gICAgaWYgKHRoaXMubmdDb250cm9sKSB7XG4gICAgICAvLyBTZXR0aW5nIHRoZSB2YWxpZGF0b3IgZGlyZWN0bHkgKGluc3RlYWQgb2YgdXNpbmdcbiAgICAgIC8vIHRoZSBwcm92aWRlcnMpIHRvIGF2b2lkIHJ1bm5pbmcgaW50byBhIGNpcmN1bGFyIGltcG9ydC5cbiAgICAgIHRoaXMubmdDb250cm9sLmNvbnRyb2w/LmFkZFZhbGlkYXRvcnMoKGNvbnRyb2wpID0+XG4gICAgICAgIHRoaXMudmFsaWRhdGUoY29udHJvbCksXG4gICAgICApO1xuXG4gICAgICB0aGlzLm5nQ29udHJvbC5zdGF0dXNDaGFuZ2VzXG4gICAgICAgID8ucGlwZShcbiAgICAgICAgICBmaWx0ZXIoXG4gICAgICAgICAgICAoc3RhdHVzKSA9PiBzdGF0dXMgPT09ICdWQUxJRCcgJiYgISF0aGlzLnVwbG9hZGVyLmNvbmZpZy5hdXRvVXBsb2FkLFxuICAgICAgICAgICksXG4gICAgICAgICAgdGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZiksXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnVwbG9hZGVyLnVwbG9hZEFsbCgpKTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5lcnJvcnMuY2hhbmdlc1xuICAgICAgLnBpcGUoc3RhcnRXaXRoKHRoaXMuZXJyb3JzKSwgdGFrZVVudGlsRGVzdHJveWVkKHRoaXMuZGVzdHJveVJlZikpXG4gICAgICAuc3Vic2NyaWJlKChlcnJvcnMpID0+IHRoaXMuc2V0dXBFcnJvcnMoZXJyb3JzKSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnVwbG9hZGVyPy5kZXN0cm95KCk7XG4gIH1cblxuICBvbkZpbGVzU2VsZWN0ZWQoZmlsZXM6IEZpbGVbXSk6IHZvaWQge1xuICAgIHRoaXMub25Ub3VjaGVkKCk7XG4gICAgdGhpcy51cGxvYWRlci5hZGRUb1F1ZXVlKHRoaXMuYmVmb3JlQWRkRm4oZmlsZXMpLCBbXSwgISF0aGlzLm5nQ29udHJvbCk7XG4gIH1cblxuICB3cml0ZVZhbHVlKGZpbGVzOiBGaWxlW10pOiB2b2lkIHtcbiAgICB0aGlzLnVwbG9hZGVyLmFkZFRvUXVldWUoZmlsZXMpO1xuICB9XG5cbiAgcmVnaXN0ZXJPbkNoYW5nZShvbkNoYW5nZTogKHZhbHVlOiBSZHNGaWxlSXRlbVtdKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5vbkNoYW5nZSA9IG9uQ2hhbmdlO1xuICB9XG5cbiAgcmVnaXN0ZXJPblRvdWNoZWQob25Ub3VjaGVkOiAoKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5vblRvdWNoZWQgPSBvblRvdWNoZWQ7XG4gIH1cblxuICBzZXREaXNhYmxlZFN0YXRlKGRpc2FibGVkOiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQgIT09IGRpc2FibGVkKSB7XG4gICAgICB0aGlzLmRpc2FibGVkID0gZGlzYWJsZWQ7XG4gICAgICB0aGlzLmNkci5tYXJrRm9yQ2hlY2soKTtcbiAgICB9XG4gIH1cblxuICB2YWxpZGF0ZShjb250cm9sOiBBYnN0cmFjdENvbnRyb2w8UmRzRmlsZUl0ZW1bXT4pOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gICAgaWYgKCFjb250cm9sLnZhbHVlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBlcnJvcnMgPSBjb250cm9sLnZhbHVlLnJlZHVjZSgoYWNjLCBjdXJyKSA9PiB7XG4gICAgICBpZiAoIWN1cnIuaGFzRmFpbGVkRmlsdGVycykge1xuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfVxuXG4gICAgICBjdXJyLmZhaWxlZEZpbHRlcnMuZm9yRWFjaCgoZmFpbGVkRmlsdGVyKSA9PiB7XG4gICAgICAgIGlmIChhY2NbZmFpbGVkRmlsdGVyLm5hbWVdKSB7XG4gICAgICAgICAgYWNjW2ZhaWxlZEZpbHRlci5uYW1lXS5wdXNoKGN1cnIuZmlsZS5uYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhY2NbZmFpbGVkRmlsdGVyLm5hbWVdID0gW2N1cnIuZmlsZS5uYW1lXTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwge30gYXMgVmFsaWRhdGlvbkVycm9ycyk7XG5cbiAgICBpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGggPiAwKSB7XG4gICAgICByZXR1cm4gZXJyb3JzO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgb3BlbkRpYWxvZygpOiB2b2lkIHtcbiAgICB0aGlzLmZpbGVJbnB1dD8ubmF0aXZlRWxlbWVudC5jbGljaygpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cEVycm9ycyhlcnJvcnM6IFF1ZXJ5TGlzdDxSZHNVcGxvYWRFcnJvckRpcmVjdGl2ZT4pOiB2b2lkIHtcbiAgICBjb25zdCBlcnJvck1lc3NhZ2VJZHM6IHN0cmluZ1tdID0gW107XG5cbiAgICBlcnJvcnMuZm9yRWFjaCgoZXJyKSA9PiB7XG4gICAgICBjb25zdCBpZCA9IGByZHMtdXBsb2FkLWVycm9yLSR7bmV4dElkKyt9YDtcbiAgICAgIGVyci5zZXRJZChpZCk7XG4gICAgICBlcnJvck1lc3NhZ2VJZHMucHVzaChpZCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmFyaWFFcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2VJZHMubGVuZ3RoXG4gICAgICA/IGVycm9yTWVzc2FnZUlkcy5qb2luKCcsJylcbiAgICAgIDogbnVsbDtcbiAgfVxufVxuIiwiQGlmIChpbnRsLmNoYW5nZSQgfCBhc3luYzsgYXMgdCkge1xuICBAaWYgKGhhc0Ryb3Bab25lKSB7XG4gICAgPGJ1dHRvblxuICAgICAgcmRzLXVwbG9hZC1kcm9wLXpvbmVcbiAgICAgIFtkaXNhYmxlZF09XCJkaXNhYmxlZFwiXG4gICAgICAoY2xpY2spPVwib3BlbkRpYWxvZygpXCJcbiAgICAgIChmaWxlRHJvcHBlZCk9XCJvbkZpbGVzU2VsZWN0ZWQoJGV2ZW50KVwiXG4gICAgICBbYXR0ci5hcmlhLWVycm9ybWVzc2FnZV09XCJhcmlhRXJyb3JNZXNzYWdlXCJcbiAgICA+XG4gICAgICA8cmRzLWljb24gbmFtZXNwYWNlPVwib3V0bGluZWRcIiBpY29uPVwidXBsb2FkXCIgLz5cbiAgICAgIDxzdHJvbmc+e3sgdC5kcm9wWm9uZUNob29zZUZpbGVzIH19PC9zdHJvbmc+XG4gICAgICB7eyB0LmRyb3Bab25lT3JEcm9wRmlsZXMgfX1cbiAgICA8L2J1dHRvbj5cbiAgfSBAZWxzZSB7XG4gICAgPGJ1dHRvblxuICAgICAgcmRzLXNlY29uZGFyeS1idXR0b25cbiAgICAgIGNsYXNzPVwicmRzLXVwbG9hZC1zaW1wbGUtYnV0dG9uXCJcbiAgICAgIFtzaXplXT1cInNpemVcIlxuICAgICAgW2Rpc2FibGVkXT1cImRpc2FibGVkXCJcbiAgICAgIChjbGljayk9XCJvcGVuRGlhbG9nKClcIlxuICAgICAgW2F0dHIuYXJpYS1lcnJvcm1lc3NhZ2VdPVwiYXJpYUVycm9yTWVzc2FnZVwiXG4gICAgPlxuICAgICAgPHJkcy1pY29uIG5hbWVzcGFjZT1cIm91dGxpbmVkXCIgaWNvbj1cInVwbG9hZFwiIC8+XG4gICAgICB7eyB0LmNob29zZUZpbGVzQnV0dG9uTGFiZWwgfX1cbiAgICA8L2J1dHRvbj5cbiAgfVxuICA8ZGl2IGNsYXNzPVwicmRzLXVwbG9hZC1lcnJvci1jb250YWluZXJcIj5cbiAgICA8bmctY29udGVudFxuICAgICAgc2VsZWN0PVwicmRzLXVwbG9hZC1lcnJvciwgW3Jkcy11cGxvYWQtZXJyb3JdLCBbcmRzVXBsb2FkRXJyb3JdXCJcbiAgICAvPlxuICA8L2Rpdj5cbiAgPGlucHV0XG4gICAgI2ZpbGVJbnB1dFxuICAgIHJkcy11cGxvYWRcbiAgICBbY29uZmlnXT1cInVwbG9hZGVyLmNvbmZpZ1wiXG4gICAgKGZpbGVTZWxlY3RlZCk9XCJvbkZpbGVzU2VsZWN0ZWQoJGV2ZW50KVwiXG4gIC8+XG4gIDx1bFxuICAgIFtjbGFzcy5yZHMtdXBsb2FkLWl0ZW0td2l0aC1iYWNrZ3JvdW5kXT1cImhhc0JhY2tncm91bmRcIlxuICAgIFthdHRyLmFyaWEtbGFiZWxdPVwidC51cGxvYWRMaXN0QXJpYUxhYmVsXCJcbiAgPlxuICAgIEBmb3IgKGl0ZW0gb2YgdXBsb2FkZXIucXVldWU7IHRyYWNrIGl0ZW0pIHtcbiAgICAgIDxsaVxuICAgICAgICByZHMtdXBsb2FkLWxpc3QtaXRlbVxuICAgICAgICBbZGlzYWJsZWRdPVwiZGlzYWJsZWRcIlxuICAgICAgICBbc2l6ZV09XCJzaXplXCJcbiAgICAgICAgW2ZpbGVJdGVtXT1cIml0ZW1cIlxuICAgICAgICAocmVtb3ZlKT1cInVwbG9hZGVyLnJlbW92ZUZyb21RdWV1ZSgkZXZlbnQpXCJcbiAgICAgICAgKHVwbG9hZCk9XCJ1cGxvYWRlci51cGxvYWRJdGVtKCRldmVudClcIlxuICAgICAgPjwvbGk+XG4gICAgfVxuICA8L3VsPlxuICBAaWYgKCF1cGxvYWRlci5jb25maWcuYXV0b1VwbG9hZCAmJiB1cGxvYWRlci5xdWV1ZS5sZW5ndGgpIHtcbiAgICA8YnV0dG9uXG4gICAgICByZHMtcHJpbWFyeS1idXR0b25cbiAgICAgIFtzaXplXT1cInNpemVcIlxuICAgICAgW2Rpc2FibGVkXT1cInVwbG9hZGVyLmlzVXBsb2FkaW5nIHx8IGRpc2FibGVkIHx8IGhhc0Vycm9yXCJcbiAgICAgIChjbGljayk9XCJ1cGxvYWRlci51cGxvYWRBbGwoKVwiXG4gICAgPlxuICAgICAge3sgdC5zdGFydFVwbG9hZEJ1dHRvbkxhYmVsIH19XG4gICAgPC9idXR0b24+XG4gIH1cbn1cbiJdfQ==