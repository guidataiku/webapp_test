import { BehaviorSubject, Subject } from 'rxjs';
import { RdsFileItem } from './file-item.class';
import { RdsUploadFilters } from './upload.filters';
import { RdsHttpClientWrapper } from './http-client-wrapper';
export class RdsFileUploader {
    get config() {
        return this._config;
    }
    get isUploading() {
        return this.events.isUploading.value;
    }
    set isUploading(v) {
        this.events.isUploading.next(v);
    }
    constructor(config, client) {
        this.client = client;
        this._config = {
            autoUpload: true,
            filters: [],
            url: '',
        };
        this.queue = [];
        this.itemIdToRequest = new Map();
        this.events = {
            fileInvalid: new Subject(),
            fileItemSuccess: new Subject(),
            fileItemError: new Subject(),
            fileItemCanceled: new Subject(),
            fileItemCompleted: new Subject(),
            allComplete: new Subject(),
            isUploading: new BehaviorSubject(false),
            config: new BehaviorSubject(this._config),
            queue: new BehaviorSubject(this.queue),
        };
        this.fileInvalid$ = this.events.fileInvalid.asObservable();
        this.fileItemSuccess$ = this.events.fileItemSuccess.asObservable();
        this.fileItemError$ = this.events.fileItemError.asObservable();
        this.fileItemCanceled$ = this.events.fileItemCanceled.asObservable();
        this.fileItemCompleted$ = this.events.fileItemCompleted.asObservable();
        this.allComplete$ = this.events.allComplete.asObservable();
        this.isUploading$ = this.events.isUploading.asObservable();
        this.config$ = this.events.config.asObservable();
        this.queue$ = this.events.queue.asObservable();
        this.setConfig(config);
    }
    setConfig(config) {
        this._config = {
            ...config,
            filters: RdsUploadFilters.compose(config.filters ?? [], config),
        };
        if (this._config.queueLimit == undefined) {
            this._config.queueLimit = this._config.multiple ? undefined : 1;
        }
        this.events.config.next(this.config);
    }
    updateConfig(update) {
        this._config = Object.assign(this._config, update);
        this._config.filters = RdsUploadFilters.compose(this._config.filters, this._config);
        this._config = { ...this._config };
        this.events.config.next(this.config);
    }
    addToQueue(files, filters, bypassAutoUpload = false) {
        const list = [...files];
        const selectedFilters = this.getFilters(filters);
        const addedItems = [];
        list.forEach((file) => {
            const fileItem = this.addFileToQueue(file, selectedFilters);
            if (!fileItem) {
                return;
            }
            addedItems.push(fileItem);
            if (!bypassAutoUpload && this._config.autoUpload) {
                this.uploadItem(fileItem);
            }
        });
        this.events.queue.next(this.queue);
        return addedItems;
    }
    removeFromQueue(value) {
        const index = this.getIndexOfItem(value);
        if (index == null) {
            return false;
        }
        this.removeItem(index);
        return true;
    }
    clearQueue() {
        for (let i = this.queue.length; i >= 0; i--) {
            this.removeItem(i, false);
        }
        this.events.queue.next(this.queue);
    }
    uploadItem(value) {
        const index = this.getIndexOfItem(value);
        if (index == null) {
            return;
        }
        const item = this.queue[index];
        if ((this.isUploading && this._config.uploadSequentially) ||
            item.hasFailedFilters) {
            return;
        }
        if (!this.client) {
            throw new Error('Missing HttpClient! Pass it as a RdsUploader\'s constructor param or use "registerHttpClient" method to provide one.');
        }
        this.isUploading = true;
        const request = new RdsHttpClientWrapper(item, this._config, this.client);
        request.progress = (change) => this.onProgressItem(change);
        request.success = (change) => this.onSuccessItem(change);
        request.cancel = (change) => this.onCancelItem(change);
        request.error = (change) => this.onErrorItem(change);
        request.complete = (change) => this.onCompleteItem(change);
        item.onBeforeUpload();
        request.send();
        this.itemIdToRequest.set(item.id, request);
    }
    cancelItem(value) {
        const index = this.getIndexOfItem(value);
        if (index == null) {
            return;
        }
        const item = this.queue[index];
        if (item && item.isUploading) {
            const request = this.itemIdToRequest.get(item.id);
            request?.abort();
        }
    }
    uploadAll() {
        const items = this.queue.filter((item) => item.state !== 'success' && !item.isUploading && !item.hasFailedFilters);
        if (!items.length) {
            return;
        }
        items.forEach((item) => {
            this.uploadItem(item);
        });
    }
    cancelAll() {
        this.queue
            .filter((item) => item.isUploading)
            .forEach((item) => this.cancelItem(item));
    }
    destroy() {
        this.cancelAll();
        Object.values(this.events).forEach((subject) => subject.complete());
    }
    registerHttpClient(client) {
        this.client = client;
    }
    isHttpClientRegistered() {
        return !!this.client;
    }
    removeItem(index, emitEvent = true) {
        const fileItem = this.queue[index];
        if (fileItem.isUploading) {
            this.cancelItem(fileItem);
        }
        this.queue.splice(index, 1);
        this.itemIdToRequest.delete(fileItem.id);
        emitEvent && this.events.queue.next(this.queue);
    }
    getIndexOfItem(value) {
        if (typeof value === 'number') {
            return this.isValidIndex(value) ? value : null;
        }
        else {
            return this.queue.indexOf(value);
        }
    }
    isValidIndex(index) {
        return 0 <= index && index < this.queue.length;
    }
    getReadyItems() {
        return this.queue.filter((item) => item.state === 'ready');
    }
    onErrorItem(event) {
        event.item.onError();
        this.events.fileItemError.next(event);
    }
    onCompleteItem(change) {
        if (this._config.removeAfterUpload && change.item.state === 'success') {
            this.removeFromQueue(change.item);
        }
        this.events.fileItemCompleted.next(change);
        const nextItem = this.getReadyItems()[0];
        this.isUploading = false;
        if (nextItem) {
            this.uploadItem(nextItem);
            return;
        }
        this.events.allComplete.next();
    }
    addFileToQueue(file, filters) {
        const { isValid, failedFilters } = this.isValidFile(file, filters);
        if (!isValid) {
            this.events.fileInvalid.next({
                file,
                failedFilters,
                config: this.config,
            });
        }
        if (failedFilters.some((f) => f.preventsAddingToQueue)) {
            return null;
        }
        const fileItem = new RdsFileItem(file, failedFilters);
        this.queue.push(fileItem);
        return fileItem;
    }
    getFilters(filters) {
        if (!filters) {
            return this._config.filters;
        }
        if (Array.isArray(filters)) {
            return filters;
        }
        const names = filters.match(/[^\s,]+/g);
        if (!names) {
            return this._config.filters;
        }
        return this._config.filters.filter((filter) => names.includes(filter.name));
    }
    isValidFile(file, filters) {
        const failedFilters = [];
        filters.forEach((filter) => {
            if (!filter.fn(file, this.config, this.queue)) {
                failedFilters.push(filter);
            }
        });
        return { isValid: failedFilters.length === 0, failedFilters };
    }
    onProgressItem(change) {
        change.item.onProgress(change.progress);
    }
    onSuccessItem(change) {
        change.item.onSuccess();
        this.events.fileItemSuccess.next(change);
    }
    onCancelItem(change) {
        change.item.onAbort();
        this.events.fileItemCanceled.next(change);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItY29tcG9uZW50cy9zcmMvbGliL3VwbG9hZC91cGxvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDaEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFhcEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFN0QsTUFBTSxPQUFPLGVBQWU7SUFVMUIsSUFBSSxNQUFNO1FBQ1IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUEwQkQsSUFBSSxXQUFXO1FBQ2IsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7SUFDdkMsQ0FBQztJQUVELElBQVksV0FBVyxDQUFDLENBQVU7UUFDaEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRCxZQUNFLE1BQXVCLEVBQ2YsTUFBbUI7UUFBbkIsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQS9DN0IsWUFBTyxHQUFpRTtZQUN0RSxVQUFVLEVBQUUsSUFBSTtZQUNoQixPQUFPLEVBQUUsRUFBRTtZQUNYLEdBQUcsRUFBRSxFQUFFO1NBQ1IsQ0FBQztRQUVPLFVBQUssR0FBa0IsRUFBRSxDQUFDO1FBQzFCLG9CQUFlLEdBQUcsSUFBSSxHQUFHLEVBQW1DLENBQUM7UUFNckQsV0FBTSxHQUFHO1lBQ3hCLFdBQVcsRUFBRSxJQUFJLE9BQU8sRUFBeUI7WUFDakQsZUFBZSxFQUFFLElBQUksT0FBTyxFQUE4QjtZQUMxRCxhQUFhLEVBQUUsSUFBSSxP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LFlBQVksQ0FBQyxNQUFrQztRQUNyRCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzVDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUmRzRmlsZUl0ZW0gfSBmcm9tICcuL2ZpbGUtaXRlbS5jbGFzcyc7XG5pbXBvcnQgeyBSZHNVcGxvYWRGaWx0ZXJzIH0gZnJvbSAnLi91cGxvYWQuZmlsdGVycyc7XG5pbXBvcnQge1xuICBSZHNGaWxlSXRlbVByb2dyZXNzQ2hhbmdlLFxuICBSZHNGaWxlSXRlbVN0YXR1c0NoYW5nZSxcbiAgUmRzVXBsb2FkQ29uZmlnLFxuICBSZHNVcGxvYWRGaWxlQWRkRXJyb3IsXG4gIFJkc1VwbG9hZEZpbHRlcixcbn0gZnJvbSAnLi91cGxvYWQudHlwZXMnO1xuaW1wb3J0IHtcbiAgSHR0cENsaWVudCxcbiAgSHR0cEVycm9yUmVzcG9uc2UsXG4gIEh0dHBSZXNwb25zZSxcbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgUmRzSHR0cENsaWVudFdyYXBwZXIgfSBmcm9tICcuL2h0dHAtY2xpZW50LXdyYXBwZXInO1xuXG5leHBvcnQgY2xhc3MgUmRzRmlsZVVwbG9hZGVyPFQgPSB1bmtub3duPiB7XG4gIF9jb25maWc6IFJkc1VwbG9hZENvbmZpZyAmIFJlcXVpcmVkPFBpY2s8UmRzVXBsb2FkQ29uZmlnLCAnZmlsdGVycyc+PiA9IHtcbiAgICBhdXRvVXBsb2FkOiB0cnVlLFxuICAgIGZpbHRlcnM6IFtdLFxuICAgIHVybDogJycsXG4gIH07XG5cbiAgcmVhZG9ubHkgcXVldWU6IFJkc0ZpbGVJdGVtW10gPSBbXTtcbiAgcmVhZG9ubHkgaXRlbUlkVG9SZXF1ZXN0ID0gbmV3IE1hcDxudW1iZXIsIFJkc0h0dHBDbGllbnRXcmFwcGVyPFQ+PigpO1xuXG4gIGdldCBjb25maWcoKTogUmVhZG9ubHk8UmRzVXBsb2FkQ29uZmlnPiB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbmZpZztcbiAgfVxuXG4gIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRzID0ge1xuICAgIGZpbGVJbnZhbGlkOiBuZXcgU3ViamVjdDxSZHNVcGxvYWRGaWxlQWRkRXJyb3I+KCksXG4gICAgZmlsZUl0ZW1TdWNjZXNzOiBuZXcgU3ViamVjdDxSZHNGaWxlSXRlbVN0YXR1c0NoYW5nZTxUPj4oKSxcbiAgICBmaWxlSXRlbUVycm9yOiBuZXcgU3ViamVjdDxSZHNGaWxlSXRlbVN0YXR1c0NoYW5nZTxULCBIdHRwRXJyb3JSZXNwb25zZT4+KCksXG4gICAgZmlsZUl0ZW1DYW5jZWxlZDogbmV3IFN1YmplY3Q8UmRzRmlsZUl0ZW1TdGF0dXNDaGFuZ2U8VD4+KCksXG4gICAgZmlsZUl0ZW1Db21wbGV0ZWQ6IG5ldyBTdWJqZWN0PFxuICAgICAgUmRzRmlsZUl0ZW1TdGF0dXNDaGFuZ2U8VCwgSHR0cFJlc3BvbnNlPFQ+IHwgSHR0cEVycm9yUmVzcG9uc2U+XG4gICAgPigpLFxuICAgIGFsbENvbXBsZXRlOiBuZXcgU3ViamVjdDx2b2lkPigpLFxuICAgIGlzVXBsb2FkaW5nOiBuZXcgQmVoYXZpb3JTdWJqZWN0KGZhbHNlKSxcbiAgICBjb25maWc6IG5ldyBCZWhhdmlvclN1YmplY3Q8UmVhZG9ubHk8UmRzVXBsb2FkQ29uZmlnPj4odGhpcy5fY29uZmlnKSxcbiAgICBxdWV1ZTogbmV3IEJlaGF2aW9yU3ViamVjdCh0aGlzLnF1ZXVlKSxcbiAgfTtcblxuICByZWFkb25seSBmaWxlSW52YWxpZCQgPSB0aGlzLmV2ZW50cy5maWxlSW52YWxpZC5hc09ic2VydmFibGUoKTtcbiAgcmVhZG9ubHkgZmlsZUl0ZW1TdWNjZXNzJCA9IHRoaXMuZXZlbnRzLmZpbGVJdGVtU3VjY2Vzcy5hc09ic2VydmFibGUoKTtcbiAgcmVhZG9ubHkgZmlsZUl0ZW1FcnJvciQgPSB0aGlzLmV2ZW50cy5maWxlSXRlbUVycm9yLmFzT2JzZXJ2YWJsZSgpO1xuICByZWFkb25seSBmaWxlSXRlbUNhbmNlbGVkJCA9IHRoaXMuZXZlbnRzLmZpbGVJdGVtQ2FuY2VsZWQuYXNPYnNlcnZhYmxlKCk7XG4gIHJlYWRvbmx5IGZpbGVJdGVtQ29tcGxldGVkJCA9IHRoaXMuZXZlbnRzLmZpbGVJdGVtQ29tcGxldGVkLmFzT2JzZXJ2YWJsZSgpO1xuICByZWFkb25seSBhbGxDb21wbGV0ZSQgPSB0aGlzLmV2ZW50cy5hbGxDb21wbGV0ZS5hc09ic2VydmFibGUoKTtcbiAgcmVhZG9ubHkgaXNVcGxvYWRpbmckID0gdGhpcy5ldmVudHMuaXNVcGxvYWRpbmcuYXNPYnNlcnZhYmxlKCk7XG4gIHJlYWRvbmx5IGNvbmZpZyQgPSB0aGlzLmV2ZW50cy5jb25maWcuYXNPYnNlcnZhYmxlKCk7XG4gIHJlYWRvbmx5IHF1ZXVlJCA9IHRoaXMuZXZlbnRzLnF1ZXVlLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIGdldCBpc1VwbG9hZGluZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5ldmVudHMuaXNVcGxvYWRpbmcudmFsdWU7XG4gIH1cblxuICBwcml2YXRlIHNldCBpc1VwbG9hZGluZyh2OiBib29sZWFuKSB7XG4gICAgdGhpcy5ldmVudHMuaXNVcGxvYWRpbmcubmV4dCh2KTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNvbmZpZzogUmRzVXBsb2FkQ29uZmlnLFxuICAgIHByaXZhdGUgY2xpZW50PzogSHR0cENsaWVudCxcbiAgKSB7XG4gICAgdGhpcy5zZXRDb25maWcoY29uZmlnKTtcbiAgfVxuXG4gIHNldENvbmZpZyhjb25maWc6IFJkc1VwbG9hZENvbmZpZyk6IHZvaWQge1xuICAgIHRoaXMuX2NvbmZpZyA9IHtcbiAgICAgIC4uLmNvbmZpZyxcbiAgICAgIGZpbHRlcnM6IFJkc1VwbG9hZEZpbHRlcnMuY29tcG9zZShjb25maWcuZmlsdGVycyA/PyBbXSwgY29uZmlnKSxcbiAgICB9O1xuXG4gICAgaWYgKHRoaXMuX2NvbmZpZy5xdWV1ZUxpbWl0ID09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5fY29uZmlnLnF1ZXVlTGltaXQgPSB0aGlzLl9jb25maWcubXVsdGlwbGUgPyB1bmRlZmluZWQgOiAxO1xuICAgIH1cblxuICAgIHRoaXMuZXZlbnRzLmNvbmZpZy5uZXh0KHRoaXMuY29uZmlnKTtcbiAgfVxuXG4gIHVwZGF0ZUNvbmZpZyh1cGRhdGU6IFBhcnRpYWw8UmRzVXBsb2FkQ29uZmlnPik6IHZvaWQge1xuICAgIHRoaXMuX2NvbmZpZyA9IE9iamVjdC5hc3NpZ24odGhpcy5fY29uZmlnLCB1cGRhdGUpO1xuXG4gICAgdGhpcy5fY29uZmlnLmZpbHRlcnMgPSBSZHNVcGxvYWRGaWx0ZXJzLmNvbXBvc2UoXG4gICAgICB0aGlzLl9jb25maWcuZmlsdGVycyxcbiAgICAgIHRoaXMuX2NvbmZpZyxcbiAgICApO1xuXG4gICAgdGhpcy5fY29uZmlnID0geyAuLi50aGlzLl9jb25maWcgfTtcbiAgICB0aGlzLmV2ZW50cy5jb25maWcubmV4dCh0aGlzLmNvbmZpZyk7XG4gIH1cblxuICBhZGRUb1F1ZXVlKFxuICAgIGZpbGVzOiBGaWxlW10sXG4gICAgZmlsdGVycz86IFJkc1VwbG9hZEZpbHRlcltdIHwgc3RyaW5nLFxuICAgIGJ5cGFzc0F1dG9VcGxvYWQgPSBmYWxzZSxcbiAgKTogUmRzRmlsZUl0ZW1bXSB7XG4gICAgY29uc3QgbGlzdCA9IFsuLi5maWxlc107XG4gICAgY29uc3Qgc2VsZWN0ZWRGaWx0ZXJzID0gdGhpcy5nZXRGaWx0ZXJzKGZpbHRlcnMpO1xuICAgIGNvbnN0IGFkZGVkSXRlbXM6IFJkc0ZpbGVJdGVtW10gPSBbXTtcblxuICAgIGxpc3QuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgY29uc3QgZmlsZUl0ZW0gPSB0aGlzLmFkZEZpbGVUb1F1ZXVlKGZpbGUsIHNlbGVjdGVkRmlsdGVycyk7XG5cbiAgICAgIGlmICghZmlsZUl0ZW0pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBhZGRlZEl0ZW1zLnB1c2goZmlsZUl0ZW0pO1xuXG4gICAgICBpZiAoIWJ5cGFzc0F1dG9VcGxvYWQgJiYgdGhpcy5fY29uZmlnLmF1dG9VcGxvYWQpIHtcbiAgICAgICAgdGhpcy51cGxvYWRJdGVtKGZpbGVJdGVtKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuZXZlbnRzLnF1ZXVlLm5leHQodGhpcy5xdWV1ZSk7XG5cbiAgICByZXR1cm4gYWRkZWRJdGVtcztcbiAgfVxuXG4gIHJlbW92ZUZyb21RdWV1ZSh2YWx1ZTogUmRzRmlsZUl0ZW0gfCBudW1iZXIpOiBib29sZWFuIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ2V0SW5kZXhPZkl0ZW0odmFsdWUpO1xuXG4gICAgaWYgKGluZGV4ID09IG51bGwpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB0aGlzLnJlbW92ZUl0ZW0oaW5kZXgpO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBjbGVhclF1ZXVlKCk6IHZvaWQge1xuICAgIGZvciAobGV0IGkgPSB0aGlzLnF1ZXVlLmxlbmd0aDsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIHRoaXMucmVtb3ZlSXRlbShpLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgdGhpcy5ldmVudHMucXVldWUubmV4dCh0aGlzLnF1ZXVlKTtcbiAgfVxuXG4gIHVwbG9hZEl0ZW0odmFsdWU6IFJkc0ZpbGVJdGVtKTogdm9pZCB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdldEluZGV4T2ZJdGVtKHZhbHVlKTtcblxuICAgIGlmIChpbmRleCA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaXRlbSA9IHRoaXMucXVldWVbaW5kZXhdO1xuXG4gICAgaWYgKFxuICAgICAgKHRoaXMuaXNVcGxvYWRpbmcgJiYgdGhpcy5fY29uZmlnLnVwbG9hZFNlcXVlbnRpYWxseSkgfHxcbiAgICAgIGl0ZW0uaGFzRmFpbGVkRmlsdGVyc1xuICAgICkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5jbGllbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ01pc3NpbmcgSHR0cENsaWVudCEgUGFzcyBpdCBhcyBhIFJkc1VwbG9hZGVyXFwncyBjb25zdHJ1Y3RvciBwYXJhbSBvciB1c2UgXCJyZWdpc3Rlckh0dHBDbGllbnRcIiBtZXRob2QgdG8gcHJvdmlkZSBvbmUuJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5pc1VwbG9hZGluZyA9IHRydWU7XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFJkc0h0dHBDbGllbnRXcmFwcGVyPFQ+KFxuICAgICAgaXRlbSxcbiAgICAgIHRoaXMuX2NvbmZpZyxcbiAgICAgIHRoaXMuY2xpZW50LFxuICAgICk7XG4gICAgcmVxdWVzdC5wcm9ncmVzcyA9IChjaGFuZ2UpID0+IHRoaXMub25Qcm9ncmVzc0l0ZW0oY2hhbmdlKTtcbiAgICByZXF1ZXN0LnN1Y2Nlc3MgPSAoY2hhbmdlKSA9PiB0aGlzLm9uU3VjY2Vzc0l0ZW0oY2hhbmdlKTtcbiAgICByZXF1ZXN0LmNhbmNlbCA9IChjaGFuZ2UpID0+IHRoaXMub25DYW5jZWxJdGVtKGNoYW5nZSk7XG4gICAgcmVxdWVzdC5lcnJvciA9IChjaGFuZ2UpID0+IHRoaXMub25FcnJvckl0ZW0oY2hhbmdlKTtcbiAgICByZXF1ZXN0LmNvbXBsZXRlID0gKGNoYW5nZSkgPT4gdGhpcy5vbkNvbXBsZXRlSXRlbShjaGFuZ2UpO1xuXG4gICAgaXRlbS5vbkJlZm9yZVVwbG9hZCgpO1xuXG4gICAgcmVxdWVzdC5zZW5kKCk7XG5cbiAgICB0aGlzLml0ZW1JZFRvUmVxdWVzdC5zZXQoaXRlbS5pZCwgcmVxdWVzdCk7XG4gIH1cblxuICBjYW5jZWxJdGVtKHZhbHVlOiBSZHNGaWxlSXRlbSB8IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5nZXRJbmRleE9mSXRlbSh2YWx1ZSk7XG5cbiAgICBpZiAoaW5kZXggPT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnF1ZXVlW2luZGV4XTtcblxuICAgIGlmIChpdGVtICYmIGl0ZW0uaXNVcGxvYWRpbmcpIHtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLml0ZW1JZFRvUmVxdWVzdC5nZXQoaXRlbS5pZCk7XG4gICAgICByZXF1ZXN0Py5hYm9ydCgpO1xuICAgIH1cbiAgfVxuXG4gIHVwbG9hZEFsbCgpOiB2b2lkIHtcbiAgICBjb25zdCBpdGVtcyA9IHRoaXMucXVldWUuZmlsdGVyKFxuICAgICAgKGl0ZW0pID0+XG4gICAgICAgIGl0ZW0uc3RhdGUgIT09ICdzdWNjZXNzJyAmJiAhaXRlbS5pc1VwbG9hZGluZyAmJiAhaXRlbS5oYXNGYWlsZWRGaWx0ZXJzLFxuICAgICk7XG5cbiAgICBpZiAoIWl0ZW1zLmxlbmd0aCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGl0ZW1zLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgIHRoaXMudXBsb2FkSXRlbShpdGVtKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNhbmNlbEFsbCgpOiB2b2lkIHtcbiAgICB0aGlzLnF1ZXVlXG4gICAgICAuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmlzVXBsb2FkaW5nKVxuICAgICAgLmZvckVhY2goKGl0ZW0pID0+IHRoaXMuY2FuY2VsSXRlbShpdGVtKSk7XG4gIH1cblxuICBkZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuY2FuY2VsQWxsKCk7XG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLmV2ZW50cykuZm9yRWFjaCgoc3ViamVjdCkgPT4gc3ViamVjdC5jb21wbGV0ZSgpKTtcbiAgfVxuXG4gIHJlZ2lzdGVySHR0cENsaWVudChjbGllbnQ6IEh0dHBDbGllbnQpOiB2b2lkIHtcbiAgICB0aGlzLmNsaWVudCA9IGNsaWVudDtcbiAgfVxuXG4gIGlzSHR0cENsaWVudFJlZ2lzdGVyZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhdGhpcy5jbGllbnQ7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUl0ZW0oaW5kZXg6IG51bWJlciwgZW1pdEV2ZW50ID0gdHJ1ZSk6IHZvaWQge1xuICAgIGNvbnN0IGZpbGVJdGVtID0gdGhpcy5xdWV1ZVtpbmRleF07XG5cbiAgICBpZiAoZmlsZUl0ZW0uaXNVcGxvYWRpbmcpIHtcbiAgICAgIHRoaXMuY2FuY2VsSXRlbShmaWxlSXRlbSk7XG4gICAgfVxuXG4gICAgdGhpcy5xdWV1ZS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIHRoaXMuaXRlbUlkVG9SZXF1ZXN0LmRlbGV0ZShmaWxlSXRlbS5pZCk7XG4gICAgZW1pdEV2ZW50ICYmIHRoaXMuZXZlbnRzLnF1ZXVlLm5leHQodGhpcy5xdWV1ZSk7XG4gIH1cblxuICBwcml2YXRlIGdldEluZGV4T2ZJdGVtKHZhbHVlOiBSZHNGaWxlSXRlbSB8IG51bWJlcik6IG51bWJlciB8IG51bGwge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gdGhpcy5pc1ZhbGlkSW5kZXgodmFsdWUpID8gdmFsdWUgOiBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5xdWV1ZS5pbmRleE9mKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzVmFsaWRJbmRleChpbmRleDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIDAgPD0gaW5kZXggJiYgaW5kZXggPCB0aGlzLnF1ZXVlLmxlbmd0aDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVhZHlJdGVtcygpOiBSZHNGaWxlSXRlbVtdIHtcbiAgICByZXR1cm4gdGhpcy5xdWV1ZS5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0uc3RhdGUgPT09ICdyZWFkeScpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkVycm9ySXRlbShcbiAgICBldmVudDogUmRzRmlsZUl0ZW1TdGF0dXNDaGFuZ2U8VCwgSHR0cEVycm9yUmVzcG9uc2U+LFxuICApOiB2b2lkIHtcbiAgICBldmVudC5pdGVtLm9uRXJyb3IoKTtcbiAgICB0aGlzLmV2ZW50cy5maWxlSXRlbUVycm9yLm5leHQoZXZlbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkNvbXBsZXRlSXRlbShcbiAgICBjaGFuZ2U6IFJkc0ZpbGVJdGVtU3RhdHVzQ2hhbmdlPFQsIEh0dHBSZXNwb25zZTxUPiB8IEh0dHBFcnJvclJlc3BvbnNlPixcbiAgKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX2NvbmZpZy5yZW1vdmVBZnRlclVwbG9hZCAmJiBjaGFuZ2UuaXRlbS5zdGF0ZSA9PT0gJ3N1Y2Nlc3MnKSB7XG4gICAgICB0aGlzLnJlbW92ZUZyb21RdWV1ZShjaGFuZ2UuaXRlbSk7XG4gICAgfVxuXG4gICAgdGhpcy5ldmVudHMuZmlsZUl0ZW1Db21wbGV0ZWQubmV4dChjaGFuZ2UpO1xuXG4gICAgY29uc3QgbmV4dEl0ZW0gPSB0aGlzLmdldFJlYWR5SXRlbXMoKVswXTtcbiAgICB0aGlzLmlzVXBsb2FkaW5nID0gZmFsc2U7XG5cbiAgICBpZiAobmV4dEl0ZW0pIHtcbiAgICAgIHRoaXMudXBsb2FkSXRlbShuZXh0SXRlbSk7XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmV2ZW50cy5hbGxDb21wbGV0ZS5uZXh0KCk7XG4gIH1cblxuICBwcml2YXRlIGFkZEZpbGVUb1F1ZXVlKFxuICAgIGZpbGU6IEZpbGUsXG4gICAgZmlsdGVyczogUmRzVXBsb2FkRmlsdGVyW10sXG4gICk6IFJkc0ZpbGVJdGVtIHwgbnVsbCB7XG4gICAgY29uc3QgeyBpc1ZhbGlkLCBmYWlsZWRGaWx0ZXJzIH0gPSB0aGlzLmlzVmFsaWRGaWxlKGZpbGUsIGZpbHRlcnMpO1xuXG4gICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICB0aGlzLmV2ZW50cy5maWxlSW52YWxpZC5uZXh0KHtcbiAgICAgICAgZmlsZSxcbiAgICAgICAgZmFpbGVkRmlsdGVycyxcbiAgICAgICAgY29uZmlnOiB0aGlzLmNvbmZpZyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChmYWlsZWRGaWx0ZXJzLnNvbWUoKGYpID0+IGYucHJldmVudHNBZGRpbmdUb1F1ZXVlKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZUl0ZW0gPSBuZXcgUmRzRmlsZUl0ZW0oZmlsZSwgZmFpbGVkRmlsdGVycyk7XG4gICAgdGhpcy5xdWV1ZS5wdXNoKGZpbGVJdGVtKTtcblxuICAgIHJldHVybiBmaWxlSXRlbTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RmlsdGVycyhmaWx0ZXJzPzogUmRzVXBsb2FkRmlsdGVyW10gfCBzdHJpbmcpOiBSZHNVcGxvYWRGaWx0ZXJbXSB7XG4gICAgaWYgKCFmaWx0ZXJzKSB7XG4gICAgICByZXR1cm4gdGhpcy5fY29uZmlnLmZpbHRlcnM7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZmlsdGVycykpIHtcbiAgICAgIHJldHVybiBmaWx0ZXJzO1xuICAgIH1cblxuICAgIGNvbnN0IG5hbWVzID0gZmlsdGVycy5tYXRjaCgvW15cXHMsXSsvZyk7XG5cbiAgICBpZiAoIW5hbWVzKSB7XG4gICAgICByZXR1cm4gdGhpcy5fY29uZmlnLmZpbHRlcnM7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2NvbmZpZy5maWx0ZXJzLmZpbHRlcigoZmlsdGVyKSA9PiBuYW1lcy5pbmNsdWRlcyhmaWx0ZXIubmFtZSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1ZhbGlkRmlsZShcbiAgICBmaWxlOiBGaWxlLFxuICAgIGZpbHRlcnM6IFJkc1VwbG9hZEZpbHRlcltdLFxuICApOiB7IGlzVmFsaWQ6IGJvb2xlYW47IGZhaWxlZEZpbHRlcnM6IFJkc1VwbG9hZEZpbHRlcltdIH0ge1xuICAgIGNvbnN0IGZhaWxlZEZpbHRlcnM6IFJkc1VwbG9hZEZpbHRlcltdID0gW107XG5cbiAgICBmaWx0ZXJzLmZvckVhY2goKGZpbHRlcikgPT4ge1xuICAgICAgaWYgKCFmaWx0ZXIuZm4oZmlsZSwgdGhpcy5jb25maWcsIHRoaXMucXVldWUpKSB7XG4gICAgICAgIGZhaWxlZEZpbHRlcnMucHVzaChmaWx0ZXIpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgaXNWYWxpZDogZmFpbGVkRmlsdGVycy5sZW5ndGggPT09IDAsIGZhaWxlZEZpbHRlcnMgfTtcbiAgfVxuXG4gIHByaXZhdGUgb25Qcm9ncmVzc0l0ZW0oY2hhbmdlOiBSZHNGaWxlSXRlbVByb2dyZXNzQ2hhbmdlKTogdm9pZCB7XG4gICAgY2hhbmdlLml0ZW0ub25Qcm9ncmVzcyhjaGFuZ2UucHJvZ3Jlc3MpO1xuICB9XG5cbiAgcHJpdmF0ZSBvblN1Y2Nlc3NJdGVtKGNoYW5nZTogUmRzRmlsZUl0ZW1TdGF0dXNDaGFuZ2U8VD4pOiB2b2lkIHtcbiAgICBjaGFuZ2UuaXRlbS5vblN1Y2Nlc3MoKTtcbiAgICB0aGlzLmV2ZW50cy5maWxlSXRlbVN1Y2Nlc3MubmV4dChjaGFuZ2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkNhbmNlbEl0ZW0oY2hhbmdlOiBSZHNGaWxlSXRlbVN0YXR1c0NoYW5nZTxUPik6IHZvaWQge1xuICAgIGNoYW5nZS5pdGVtLm9uQWJvcnQoKTtcbiAgICB0aGlzLmV2ZW50cy5maWxlSXRlbUNhbmNlbGVkLm5leHQoY2hhbmdlKTtcbiAgfVxufVxuIl19