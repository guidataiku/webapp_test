import { inject, Injectable, Injector, NgZone, SecurityContext, } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { from, noop } from 'rxjs';
import { RdsComponentPortal } from './portal/rds-component-portal';
import { RdsToastOverlayService } from './overlay/rds-toast-overlay.service';
import { RdsToastInjector } from './rds-toast.injector';
import { RdsToastRef } from './rds-toast.ref';
import { DEFAULT_GLOBAL_CONFIG, RDS_TOAST_GLOBAL_CONFIG_TOKEN, } from './rds-toast.config';
import { RdsToastPackage } from './rds-toast.package';
import { LiveAnnouncer } from '@angular/cdk/a11y';
import { RdsToastComponent } from './rds-toast.component';
import { takeUntil } from 'rxjs/operators';
import { RdsToastModule } from './rds-toast.module';
import * as i0 from "@angular/core";
export class RdsToastService {
    constructor() {
        this.overlayService = inject(RdsToastOverlayService);
        this.injector = inject(Injector);
        this.domSanitizer = inject(DomSanitizer);
        this.ngZone = inject(NgZone);
        this.liveAnnouncer = inject(LiveAnnouncer);
        this.toastGlobalConfig = inject(RDS_TOAST_GLOBAL_CONFIG_TOKEN, {
            optional: true,
        });
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        this.toasts = [];
        this.currentlyActive = 0;
        this._index = 0;
        if (this.toastGlobalConfig) {
            this.globalConfig = { ...this.toastGlobalConfig };
        }
        else {
            this.globalConfig = { ...DEFAULT_GLOBAL_CONFIG };
        }
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    show(message, title, override = {}) {
        if (override.type === 'info' ||
            override.type === 'warning' ||
            override.type === 'success' ||
            override.type === 'error') {
            return this[override.type](message, title, override);
        }
        else {
            return this._preBuildNotification(message, title, this._applyConfig(override));
        }
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    success(message, title, override = {}) {
        override.type = 'success';
        override.icon = 'checkmark_circle';
        override.iconNamespace = 'outlined';
        return this._preBuildNotification(message, title, this._applyConfig(override));
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    error(message, title, override = {}) {
        override.type = 'error';
        override.icon = 'close_circle';
        override.iconNamespace = 'outlined';
        return this._preBuildNotification(message, title, this._applyConfig(override));
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    info(message, title, override = {}) {
        override.type = 'info';
        override.icon = 'info';
        override.iconNamespace = 'outlined';
        return this._preBuildNotification(message, title, this._applyConfig(override));
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    warning(message, title, override = {}) {
        override.type = 'warning';
        override.icon = 'warning_circle';
        override.iconNamespace = 'outlined';
        return this._preBuildNotification(message, title, this._applyConfig(override));
    }
    clear(toastId) {
        const toast = typeof toastId === 'number'
            ? this.toasts.find((t) => t.toastId === toastId)
            : this.toasts.find((t) => t === toastId);
        if (!toast) {
            this.toasts.forEach((t) => t.toastRef.manualClose());
        }
        else {
            toast.toastRef.manualClose();
        }
    }
    _remove(toastId) {
        const toastIndex = this.toasts.findIndex((t) => t.toastId === toastId);
        if (toastIndex === -1) {
            return false;
        }
        if (!this.toasts[toastIndex].toastRef.isClosed()) {
            this.toasts[toastIndex].toastRef.close();
        }
        this.toasts.splice(toastIndex, 1);
        this.currentlyActive = this.currentlyActive - 1;
        if (!this.globalConfig.maxOpened || !this.toasts.length) {
            return false;
        }
        if (this.currentlyActive < this.globalConfig.maxOpened &&
            this.toasts[this.currentlyActive]) {
            const p = this.toasts[this.currentlyActive].toastRef;
            if (!p.isInactive()) {
                this.currentlyActive = this.currentlyActive + 1;
                p.activate();
            }
        }
        return true;
    }
    _applyConfig(override = {}) {
        return {
            ...this.globalConfig,
            ...override,
            // remove this line when library should allow to pass custom component
            ...{ toastComponent: RdsToastComponent },
        };
    }
    _preBuildNotification(message, title, config) {
        if (config.onActivateTick) {
            return this.ngZone.run(() => this._buildNotification(message, title, config));
        }
        return this._buildNotification(message, title, config);
    }
    _buildNotification(message, title, config) {
        if (!config.toastComponent) {
            throw new Error('toastComponent required');
        }
        if (typeof title !== 'string' || title.trim().length === 0) {
            title = '';
        }
        if (typeof message !== 'string' || message.trim().length === 0) {
            message = title;
            title = '';
        }
        this.previousToastMessage = message;
        let keepInactive = false;
        if (this.globalConfig.maxOpened &&
            this.currentlyActive >= this.globalConfig.maxOpened) {
            keepInactive = true;
            if (this.globalConfig.autoDismiss) {
                this.clear(this.toasts[0]);
            }
        }
        const overlayRef = this.overlayService.create(config.position, this.overlayContainer);
        this._index = this._index + 1;
        let sanitizedMessage = message;
        if (message && config.enableHtml) {
            sanitizedMessage = this.domSanitizer.sanitize(SecurityContext.HTML, message);
        }
        const toastRef = new RdsToastRef(overlayRef);
        const toastPackage = new RdsToastPackage(this._index, config, sanitizedMessage, title, toastRef);
        const toastInjector = new RdsToastInjector(toastPackage, this.injector);
        const component = new RdsComponentPortal(config.toastComponent, toastInjector);
        const portal = overlayRef.attach(component, config.newestOnTop);
        toastRef.componentInstance = portal.instance;
        const ins = {
            toastId: this._index,
            title: title,
            message: message,
            toastRef,
            onShown: toastRef.afterActivate(),
            onHidden: toastRef.afterClosed(),
            onTap: toastPackage.onTap(),
            onAction: toastPackage.onAction(),
            portal,
        };
        if (!keepInactive) {
            this.currentlyActive = this.currentlyActive + 1;
            from(Promise.resolve())
                .pipe(takeUntil(ins.toastRef.afterClosed()))
                .subscribe(() => ins.toastRef.activate());
        }
        toastRef.afterClosed().subscribe(() => {
            this.liveAnnouncer.clear();
            this._remove(ins.toastId);
        });
        toastRef
            .afterActivate()
            .pipe(takeUntil(toastRef.afterClosed()))
            .subscribe(() => {
            if (config.announcementMessage) {
                from(this.liveAnnouncer.announce(config.announcementMessage, config.politeness)).subscribe(noop);
            }
            else {
                from(this.liveAnnouncer.announce(`${config.type} Toast: Title: ${ins.title}: Message: ${ins.message}`, config.politeness)).subscribe(noop);
            }
        });
        this.toasts.push(ins);
        return ins;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsToastService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsToastService, providedIn: RdsToastModule }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: RdsToastService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: RdsToastModule,
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmRzLXRvYXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItY29tcG9uZW50cy9zcmMvbGliL3RvYXN0L3Jkcy10b2FzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxNQUFNLEVBQ04sVUFBVSxFQUNWLFFBQVEsRUFDUixNQUFNLEVBQ04sZUFBZSxHQUNoQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDekQsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDbkUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDN0UsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTlDLE9BQU8sRUFDTCxxQkFBcUIsRUFDckIsNkJBQTZCLEdBRzlCLE1BQU0sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDOztBQWtCcEQsTUFBTSxPQUFPLGVBQWU7SUFrQjFCO1FBakJpQixtQkFBYyxHQUFHLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBQ2hELGFBQVEsR0FBRyxNQUFNLENB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LG1CQUFtQixFQUMxQixNQUFNLENBQUMsVUFBVSxDQUNsQixDQUNGLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BCLENBQUM7aUJBQU0sQ0FBQztnQkFDTixJQUFJLENBQ0YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQ3pCLEdBQUcsTUFBTSxDQUFDLElBQUksa0JBQWtCLEdBQUcsQ0FBQyxLQUFLLGNBQWMsR0FBRyxDQUFDLE9BQU8sRUFBRSxFQUNwRSxNQUFNLENBQUMsVUFBVSxDQUNsQixDQUNGLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BCLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVMLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXRCLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQzs4R0ExU1UsZUFBZTtrSEFBZixlQUFlLGNBRmQsY0FBYzs7MkZBRWYsZUFBZTtrQkFIM0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsY0FBYztpQkFDM0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnRSZWYsXG4gIGluamVjdCxcbiAgSW5qZWN0YWJsZSxcbiAgSW5qZWN0b3IsXG4gIE5nWm9uZSxcbiAgU2VjdXJpdHlDb250ZXh0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERvbVNhbml0aXplciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgZnJvbSwgbm9vcCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUmRzQ29tcG9uZW50UG9ydGFsIH0gZnJvbSAnLi9wb3J0YWwvcmRzLWNvbXBvbmVudC1wb3J0YWwnO1xuaW1wb3J0IHsgUmRzVG9hc3RPdmVybGF5U2VydmljZSB9IGZyb20gJy4vb3ZlcmxheS9yZHMtdG9hc3Qtb3ZlcmxheS5zZXJ2aWNlJztcbmltcG9ydCB7IFJkc1RvYXN0SW5qZWN0b3IgfSBmcm9tICcuL3Jkcy10b2FzdC5pbmplY3Rvcic7XG5pbXBvcnQgeyBSZHNUb2FzdFJlZiB9IGZyb20gJy4vcmRzLXRvYXN0LnJlZic7XG5pbXBvcnQgeyBSZHNUb2FzdENvbnRhaW5lckRpcmVjdGl2ZSB9IGZyb20gJy4vcmRzLXRvYXN0LWNvbnRhaW5lci5kaXJlY3RpdmUnO1xuaW1wb3J0IHtcbiAgREVGQVVMVF9HTE9CQUxfQ09ORklHLFxuICBSRFNfVE9BU1RfR0xPQkFMX0NPTkZJR19UT0tFTixcbiAgUmRzVG9hc3RHbG9iYWxDb25maWcsXG4gIFJkc1RvYXN0SW5kaXZpZHVhbENvbmZpZyxcbn0gZnJvbSAnLi9yZHMtdG9hc3QuY29uZmlnJztcbmltcG9ydCB7IFJkc1RvYXN0UGFja2FnZSB9IGZyb20gJy4vcmRzLXRvYXN0LnBhY2thZ2UnO1xuaW1wb3J0IHsgTGl2ZUFubm91bmNlciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9hMTF5JztcbmltcG9ydCB7IFJkc1RvYXN0Q29tcG9uZW50IH0gZnJvbSAnLi9yZHMtdG9hc3QuY29tcG9uZW50JztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJkc1RvYXN0TW9kdWxlIH0gZnJvbSAnLi9yZHMtdG9hc3QubW9kdWxlJztcblxuZXhwb3J0IGludGVyZmFjZSBSZHNBY3RpdmVUb2FzdDxDID0gUmRzVG9hc3RDb21wb25lbnQ+IHtcbiAgdG9hc3RJZDogbnVtYmVyO1xuICB0aXRsZTogc3RyaW5nO1xuICBtZXNzYWdlOiBzdHJpbmc7XG4gIHBvcnRhbDogQ29tcG9uZW50UmVmPEM+O1xuICB0b2FzdFJlZjogUmRzVG9hc3RSZWY8Qz47XG4gIG9uU2hvd246IE9ic2VydmFibGU8dm9pZD47XG4gIG9uSGlkZGVuOiBPYnNlcnZhYmxlPHZvaWQ+O1xuICBvblRhcDogT2JzZXJ2YWJsZTx2b2lkPjtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgb25BY3Rpb246IE9ic2VydmFibGU8YW55Pjtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiBSZHNUb2FzdE1vZHVsZSxcbn0pXG5leHBvcnQgY2xhc3MgUmRzVG9hc3RTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBvdmVybGF5U2VydmljZSA9IGluamVjdChSZHNUb2FzdE92ZXJsYXlTZXJ2aWNlKTtcbiAgcHJpdmF0ZSByZWFkb25seSBpbmplY3RvciA9IGluamVjdChJbmplY3Rvcik7XG4gIHByaXZhdGUgcmVhZG9ubHkgZG9tU2FuaXRpemVyID0gaW5qZWN0KERvbVNhbml0aXplcik7XG4gIHByaXZhdGUgcmVhZG9ubHkgbmdab25lID0gaW5qZWN0KE5nWm9uZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgbGl2ZUFubm91bmNlciA9IGluamVjdChMaXZlQW5ub3VuY2VyKTtcbiAgcHJpdmF0ZSByZWFkb25seSB0b2FzdEdsb2JhbENvbmZpZyA9IGluamVjdChSRFNfVE9BU1RfR0xPQkFMX0NPTkZJR19UT0tFTiwge1xuICAgIG9wdGlvbmFsOiB0cnVlLFxuICB9KTtcblxuICBnbG9iYWxDb25maWc6IFJkc1RvYXN0R2xvYmFsQ29uZmlnO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICBwcml2YXRlIHJlYWRvbmx5IHRvYXN0czogUmRzQWN0aXZlVG9hc3Q8YW55PltdID0gW107XG4gIHByaXZhdGUgY3VycmVudGx5QWN0aXZlID0gMDtcbiAgcHJpdmF0ZSBvdmVybGF5Q29udGFpbmVyPzogUmRzVG9hc3RDb250YWluZXJEaXJlY3RpdmU7XG4gIHByaXZhdGUgcHJldmlvdXNUb2FzdE1lc3NhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBfaW5kZXggPSAwO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGlmICh0aGlzLnRvYXN0R2xvYmFsQ29uZmlnKSB7XG4gICAgICB0aGlzLmdsb2JhbENvbmZpZyA9IHsgLi4udGhpcy50b2FzdEdsb2JhbENvbmZpZyB9O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmdsb2JhbENvbmZpZyA9IHsgLi4uREVGQVVMVF9HTE9CQUxfQ09ORklHIH07XG4gICAgfVxuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgc2hvdzxUID0gUmRzVG9hc3RDb21wb25lbnQsIEEgPSBhbnk+KFxuICAgIG1lc3NhZ2U/OiBzdHJpbmcsXG4gICAgdGl0bGU/OiBzdHJpbmcsXG4gICAgb3ZlcnJpZGU6IFBhcnRpYWw8UmRzVG9hc3RJbmRpdmlkdWFsQ29uZmlnPiA9IHt9LFxuICApOiBSZHNBY3RpdmVUb2FzdDxUPiB8IG51bGwge1xuICAgIGlmIChcbiAgICAgIG92ZXJyaWRlLnR5cGUgPT09ICdpbmZvJyB8fFxuICAgICAgb3ZlcnJpZGUudHlwZSA9PT0gJ3dhcm5pbmcnIHx8XG4gICAgICBvdmVycmlkZS50eXBlID09PSAnc3VjY2VzcycgfHxcbiAgICAgIG92ZXJyaWRlLnR5cGUgPT09ICdlcnJvcidcbiAgICApIHtcbiAgICAgIHJldHVybiB0aGlzW292ZXJyaWRlLnR5cGVdKG1lc3NhZ2UsIHRpdGxlLCBvdmVycmlkZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLl9wcmVCdWlsZE5vdGlmaWNhdGlvbjxULCBBPihcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgdGl0bGUsXG4gICAgICAgIHRoaXMuX2FwcGx5Q29uZmlnKG92ZXJyaWRlKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgc3VjY2VzczxUID0gUmRzVG9hc3RDb21wb25lbnQsIEEgPSBhbnk+KFxuICAgIG1lc3NhZ2U/OiBzdHJpbmcsXG4gICAgdGl0bGU/OiBzdHJpbmcsXG4gICAgb3ZlcnJpZGU6IFBhcnRpYWw8UmRzVG9hc3RJbmRpdmlkdWFsQ29uZmlnPiA9IHt9LFxuICApOiBSZHNBY3RpdmVUb2FzdDxUPiB8IG51bGwge1xuICAgIG92ZXJyaWRlLnR5cGUgPSAnc3VjY2Vzcyc7XG4gICAgb3ZlcnJpZGUuaWNvbiA9ICdjaGVja21hcmtfY2lyY2xlJztcbiAgICBvdmVycmlkZS5pY29uTmFtZXNwYWNlID0gJ291dGxpbmVkJztcblxuICAgIHJldHVybiB0aGlzLl9wcmVCdWlsZE5vdGlmaWNhdGlvbjxULCBBPihcbiAgICAgIG1lc3NhZ2UsXG4gICAgICB0aXRsZSxcbiAgICAgIHRoaXMuX2FwcGx5Q29uZmlnKG92ZXJyaWRlKSxcbiAgICApO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgZXJyb3I8VCA9IFJkc1RvYXN0Q29tcG9uZW50LCBBID0gYW55PihcbiAgICBtZXNzYWdlPzogc3RyaW5nLFxuICAgIHRpdGxlPzogc3RyaW5nLFxuICAgIG92ZXJyaWRlOiBQYXJ0aWFsPFJkc1RvYXN0SW5kaXZpZHVhbENvbmZpZz4gPSB7fSxcbiAgKTogUmRzQWN0aXZlVG9hc3Q8VD4gfCBudWxsIHtcbiAgICBvdmVycmlkZS50eXBlID0gJ2Vycm9yJztcbiAgICBvdmVycmlkZS5pY29uID0gJ2Nsb3NlX2NpcmNsZSc7XG4gICAgb3ZlcnJpZGUuaWNvbk5hbWVzcGFjZSA9ICdvdXRsaW5lZCc7XG5cbiAgICByZXR1cm4gdGhpcy5fcHJlQnVpbGROb3RpZmljYXRpb248VCwgQT4oXG4gICAgICBtZXNzYWdlLFxuICAgICAgdGl0bGUsXG4gICAgICB0aGlzLl9hcHBseUNvbmZpZyhvdmVycmlkZSksXG4gICAgKTtcbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIGluZm88VCA9IFJkc1RvYXN0Q29tcG9uZW50LCBBID0gYW55PihcbiAgICBtZXNzYWdlPzogc3RyaW5nLFxuICAgIHRpdGxlPzogc3RyaW5nLFxuICAgIG92ZXJyaWRlOiBQYXJ0aWFsPFJkc1RvYXN0SW5kaXZpZHVhbENvbmZpZz4gPSB7fSxcbiAgKTogUmRzQWN0aXZlVG9hc3Q8VD4gfCBudWxsIHtcbiAgICBvdmVycmlkZS50eXBlID0gJ2luZm8nO1xuICAgIG92ZXJyaWRlLmljb24gPSAnaW5mbyc7XG4gICAgb3ZlcnJpZGUuaWNvbk5hbWVzcGFjZSA9ICdvdXRsaW5lZCc7XG5cbiAgICByZXR1cm4gdGhpcy5fcHJlQnVpbGROb3RpZmljYXRpb248VCwgQT4oXG4gICAgICBtZXNzYWdlLFxuICAgICAgdGl0bGUsXG4gICAgICB0aGlzLl9hcHBseUNvbmZpZyhvdmVycmlkZSksXG4gICAgKTtcbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIHdhcm5pbmc8VCA9IFJkc1RvYXN0Q29tcG9uZW50LCBBID0gYW55PihcbiAgICBtZXNzYWdlPzogc3RyaW5nLFxuICAgIHRpdGxlPzogc3RyaW5nLFxuICAgIG92ZXJyaWRlOiBQYXJ0aWFsPFJkc1RvYXN0SW5kaXZpZHVhbENvbmZpZz4gPSB7fSxcbiAgKTogUmRzQWN0aXZlVG9hc3Q8VD4gfCBudWxsIHtcbiAgICBvdmVycmlkZS50eXBlID0gJ3dhcm5pbmcnO1xuICAgIG92ZXJyaWRlLmljb24gPSAnd2FybmluZ19jaXJjbGUnO1xuICAgIG92ZXJyaWRlLmljb25OYW1lc3BhY2UgPSAnb3V0bGluZWQnO1xuXG4gICAgcmV0dXJuIHRoaXMuX3ByZUJ1aWxkTm90aWZpY2F0aW9uPFQsIEE+KFxuICAgICAgbWVzc2FnZSxcbiAgICAgIHRpdGxlLFxuICAgICAgdGhpcy5fYXBwbHlDb25maWcob3ZlcnJpZGUpLFxuICAgICk7XG4gIH1cblxuICBjbGVhcjxUPih0b2FzdElkPzogbnVtYmVyIHwgUmRzQWN0aXZlVG9hc3Q8VD4pOiB2b2lkIHtcbiAgICBjb25zdCB0b2FzdCA9XG4gICAgICB0eXBlb2YgdG9hc3RJZCA9PT0gJ251bWJlcidcbiAgICAgICAgPyB0aGlzLnRvYXN0cy5maW5kKCh0KSA9PiB0LnRvYXN0SWQgPT09IHRvYXN0SWQpXG4gICAgICAgIDogdGhpcy50b2FzdHMuZmluZCgodCkgPT4gdCA9PT0gdG9hc3RJZCk7XG5cbiAgICBpZiAoIXRvYXN0KSB7XG4gICAgICB0aGlzLnRvYXN0cy5mb3JFYWNoKCh0KSA9PiB0LnRvYXN0UmVmLm1hbnVhbENsb3NlKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0b2FzdC50b2FzdFJlZi5tYW51YWxDbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3JlbW92ZSh0b2FzdElkOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBjb25zdCB0b2FzdEluZGV4ID0gdGhpcy50b2FzdHMuZmluZEluZGV4KCh0KSA9PiB0LnRvYXN0SWQgPT09IHRvYXN0SWQpO1xuXG4gICAgaWYgKHRvYXN0SW5kZXggPT09IC0xKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnRvYXN0c1t0b2FzdEluZGV4XS50b2FzdFJlZi5pc0Nsb3NlZCgpKSB7XG4gICAgICB0aGlzLnRvYXN0c1t0b2FzdEluZGV4XS50b2FzdFJlZi5jbG9zZSgpO1xuICAgIH1cblxuICAgIHRoaXMudG9hc3RzLnNwbGljZSh0b2FzdEluZGV4LCAxKTtcbiAgICB0aGlzLmN1cnJlbnRseUFjdGl2ZSA9IHRoaXMuY3VycmVudGx5QWN0aXZlIC0gMTtcblxuICAgIGlmICghdGhpcy5nbG9iYWxDb25maWcubWF4T3BlbmVkIHx8ICF0aGlzLnRvYXN0cy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLmN1cnJlbnRseUFjdGl2ZSA8IHRoaXMuZ2xvYmFsQ29uZmlnLm1heE9wZW5lZCAmJlxuICAgICAgdGhpcy50b2FzdHNbdGhpcy5jdXJyZW50bHlBY3RpdmVdXG4gICAgKSB7XG4gICAgICBjb25zdCBwID0gdGhpcy50b2FzdHNbdGhpcy5jdXJyZW50bHlBY3RpdmVdLnRvYXN0UmVmO1xuXG4gICAgICBpZiAoIXAuaXNJbmFjdGl2ZSgpKSB7XG4gICAgICAgIHRoaXMuY3VycmVudGx5QWN0aXZlID0gdGhpcy5jdXJyZW50bHlBY3RpdmUgKyAxO1xuICAgICAgICBwLmFjdGl2YXRlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIF9hcHBseUNvbmZpZyhcbiAgICBvdmVycmlkZTogUGFydGlhbDxSZHNUb2FzdEluZGl2aWR1YWxDb25maWc+ID0ge30sXG4gICk6IFJkc1RvYXN0R2xvYmFsQ29uZmlnIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4udGhpcy5nbG9iYWxDb25maWcsXG4gICAgICAuLi5vdmVycmlkZSxcbiAgICAgIC8vIHJlbW92ZSB0aGlzIGxpbmUgd2hlbiBsaWJyYXJ5IHNob3VsZCBhbGxvdyB0byBwYXNzIGN1c3RvbSBjb21wb25lbnRcbiAgICAgIC4uLnsgdG9hc3RDb21wb25lbnQ6IFJkc1RvYXN0Q29tcG9uZW50IH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgX3ByZUJ1aWxkTm90aWZpY2F0aW9uPFQsIEE+KFxuICAgIG1lc3NhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICB0aXRsZTogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgIGNvbmZpZzogUmRzVG9hc3RHbG9iYWxDb25maWcsXG4gICk6IFJkc0FjdGl2ZVRvYXN0PFQ+IHwgbnVsbCB7XG4gICAgaWYgKGNvbmZpZy5vbkFjdGl2YXRlVGljaykge1xuICAgICAgcmV0dXJuIHRoaXMubmdab25lLnJ1bigoKSA9PlxuICAgICAgICB0aGlzLl9idWlsZE5vdGlmaWNhdGlvbjxULCBBPihtZXNzYWdlLCB0aXRsZSwgY29uZmlnKSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2J1aWxkTm90aWZpY2F0aW9uPFQsIEE+KG1lc3NhZ2UsIHRpdGxlLCBjb25maWcpO1xuICB9XG5cbiAgcHJpdmF0ZSBfYnVpbGROb3RpZmljYXRpb248VCwgQT4oXG4gICAgbWVzc2FnZTogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgIHRpdGxlOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgY29uZmlnOiBSZHNUb2FzdEdsb2JhbENvbmZpZyxcbiAgKTogUmRzQWN0aXZlVG9hc3Q8VD4gfCBudWxsIHtcbiAgICBpZiAoIWNvbmZpZy50b2FzdENvbXBvbmVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCd0b2FzdENvbXBvbmVudCByZXF1aXJlZCcpO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgdGl0bGUgIT09ICdzdHJpbmcnIHx8IHRpdGxlLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRpdGxlID0gJyc7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAnc3RyaW5nJyB8fCBtZXNzYWdlLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIG1lc3NhZ2UgPSB0aXRsZTtcbiAgICAgIHRpdGxlID0gJyc7XG4gICAgfVxuXG4gICAgdGhpcy5wcmV2aW91c1RvYXN0TWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgbGV0IGtlZXBJbmFjdGl2ZSA9IGZhbHNlO1xuXG4gICAgaWYgKFxuICAgICAgdGhpcy5nbG9iYWxDb25maWcubWF4T3BlbmVkICYmXG4gICAgICB0aGlzLmN1cnJlbnRseUFjdGl2ZSA+PSB0aGlzLmdsb2JhbENvbmZpZy5tYXhPcGVuZWRcbiAgICApIHtcbiAgICAgIGtlZXBJbmFjdGl2ZSA9IHRydWU7XG5cbiAgICAgIGlmICh0aGlzLmdsb2JhbENvbmZpZy5hdXRvRGlzbWlzcykge1xuICAgICAgICB0aGlzLmNsZWFyKHRoaXMudG9hc3RzWzBdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBvdmVybGF5UmVmID0gdGhpcy5vdmVybGF5U2VydmljZS5jcmVhdGU8VD4oXG4gICAgICBjb25maWcucG9zaXRpb24sXG4gICAgICB0aGlzLm92ZXJsYXlDb250YWluZXIsXG4gICAgKTtcbiAgICB0aGlzLl9pbmRleCA9IHRoaXMuX2luZGV4ICsgMTtcbiAgICBsZXQgc2FuaXRpemVkTWVzc2FnZTogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCA9IG1lc3NhZ2U7XG5cbiAgICBpZiAobWVzc2FnZSAmJiBjb25maWcuZW5hYmxlSHRtbCkge1xuICAgICAgc2FuaXRpemVkTWVzc2FnZSA9IHRoaXMuZG9tU2FuaXRpemVyLnNhbml0aXplKFxuICAgICAgICBTZWN1cml0eUNvbnRleHQuSFRNTCxcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgdG9hc3RSZWYgPSBuZXcgUmRzVG9hc3RSZWY8VD4ob3ZlcmxheVJlZik7XG4gICAgY29uc3QgdG9hc3RQYWNrYWdlID0gbmV3IFJkc1RvYXN0UGFja2FnZTxULCBBPihcbiAgICAgIHRoaXMuX2luZGV4LFxuICAgICAgY29uZmlnLFxuICAgICAgc2FuaXRpemVkTWVzc2FnZSxcbiAgICAgIHRpdGxlLFxuICAgICAgdG9hc3RSZWYsXG4gICAgKTtcbiAgICBjb25zdCB0b2FzdEluamVjdG9yID0gbmV3IFJkc1RvYXN0SW5qZWN0b3I8VCwgQT4oXG4gICAgICB0b2FzdFBhY2thZ2UsXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICk7XG4gICAgY29uc3QgY29tcG9uZW50ID0gbmV3IFJkc0NvbXBvbmVudFBvcnRhbChcbiAgICAgIGNvbmZpZy50b2FzdENvbXBvbmVudCxcbiAgICAgIHRvYXN0SW5qZWN0b3IsXG4gICAgKTtcbiAgICBjb25zdCBwb3J0YWwgPSBvdmVybGF5UmVmLmF0dGFjaChjb21wb25lbnQsIGNvbmZpZy5uZXdlc3RPblRvcCk7XG4gICAgdG9hc3RSZWYuY29tcG9uZW50SW5zdGFuY2UgPSBwb3J0YWwuaW5zdGFuY2U7XG4gICAgY29uc3QgaW5zOiBSZHNBY3RpdmVUb2FzdDxUPiA9IHtcbiAgICAgIHRvYXN0SWQ6IHRoaXMuX2luZGV4LFxuICAgICAgdGl0bGU6IHRpdGxlLFxuICAgICAgbWVzc2FnZTogbWVzc2FnZSxcbiAgICAgIHRvYXN0UmVmLFxuICAgICAgb25TaG93bjogdG9hc3RSZWYuYWZ0ZXJBY3RpdmF0ZSgpLFxuICAgICAgb25IaWRkZW46IHRvYXN0UmVmLmFmdGVyQ2xvc2VkKCksXG4gICAgICBvblRhcDogdG9hc3RQYWNrYWdlLm9uVGFwKCksXG4gICAgICBvbkFjdGlvbjogdG9hc3RQYWNrYWdlLm9uQWN0aW9uKCksXG4gICAgICBwb3J0YWwsXG4gICAgfTtcblxuICAgIGlmICgha2VlcEluYWN0aXZlKSB7XG4gICAgICB0aGlzLmN1cnJlbnRseUFjdGl2ZSA9IHRoaXMuY3VycmVudGx5QWN0aXZlICsgMTtcbiAgICAgIGZyb20oUHJvbWlzZS5yZXNvbHZlKCkpXG4gICAgICAgIC5waXBlKHRha2VVbnRpbChpbnMudG9hc3RSZWYuYWZ0ZXJDbG9zZWQoKSkpXG4gICAgICAgIC5zdWJzY3JpYmUoKCkgPT4gaW5zLnRvYXN0UmVmLmFjdGl2YXRlKCkpO1xuICAgIH1cblxuICAgIHRvYXN0UmVmLmFmdGVyQ2xvc2VkKCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMubGl2ZUFubm91bmNlci5jbGVhcigpO1xuICAgICAgdGhpcy5fcmVtb3ZlKGlucy50b2FzdElkKTtcbiAgICB9KTtcbiAgICB0b2FzdFJlZlxuICAgICAgLmFmdGVyQWN0aXZhdGUoKVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRvYXN0UmVmLmFmdGVyQ2xvc2VkKCkpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIGlmIChjb25maWcuYW5ub3VuY2VtZW50TWVzc2FnZSkge1xuICAgICAgICAgIGZyb20oXG4gICAgICAgICAgICB0aGlzLmxpdmVBbm5vdW5jZXIuYW5ub3VuY2UoXG4gICAgICAgICAgICAgIGNvbmZpZy5hbm5vdW5jZW1lbnRNZXNzYWdlLFxuICAgICAgICAgICAgICBjb25maWcucG9saXRlbmVzcyxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgKS5zdWJzY3JpYmUobm9vcCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZnJvbShcbiAgICAgICAgICAgIHRoaXMubGl2ZUFubm91bmNlci5hbm5vdW5jZShcbiAgICAgICAgICAgICAgYCR7Y29uZmlnLnR5cGV9IFRvYXN0OiBUaXRsZTogJHtpbnMudGl0bGV9OiBNZXNzYWdlOiAke2lucy5tZXNzYWdlfWAsXG4gICAgICAgICAgICAgIGNvbmZpZy5wb2xpdGVuZXNzLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApLnN1YnNjcmliZShub29wKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICB0aGlzLnRvYXN0cy5wdXNoKGlucyk7XG5cbiAgICByZXR1cm4gaW5zO1xuICB9XG59XG4iXX0=